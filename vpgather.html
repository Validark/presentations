<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="utf-8">
	<title>Double-Buffers & VPGATHERDD</title>
	<link rel="stylesheet" type="text/css" href="./fonts/Iosevka/Iosevka.css">
	<style>
		[hidden] {
		  display: none;
		}

		g.slide:not([hidden]) > .h2:first-child:not(.code),
		g.slide:not([hidden]) > [click]:not([hidden]):not(.no-slide-in):not(.no-slide-in2):not(.code),
		g.slide:not([hidden]) > [click]:not([hidden]):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > [click]:not([hidden]):not(.code) tspan:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg):not(.code) tspan:not(.highlighted):not(.highlighted-blue),

		g.slide:not([hidden]) > g:not(.no-slide-in) > .h2:first-child:not(.code),
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]):not(.no-slide-in):not(.no-slide-in2):not(.code),
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]):not(.code) tspan:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg):not(.code) tspan:not(.highlighted):not(.highlighted-blue)
		{
			animation: unhide 1s cubic-bezier(0, 0, 0.53, 1) 0s 1 forwards;
		}


		g.slide:not([hidden]) > [click]:not([hidden]) text.highlighted,
		g.slide:not([hidden]) > [click]:not([hidden]) tspan.highlighted,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) text.highlighted,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) tspan.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) text.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) tspan.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) text.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) tspan.highlighted
		{
			animation: unhide-highlighted 1s cubic-bezier(0, 0, 0.53, 1) 0s 1 forwards;
		}

		g.slide:not([hidden]) > [click]:not([hidden]) text.highlighted-blue,
		g.slide:not([hidden]) > [click]:not([hidden]) tspan.highlighted-blue,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) text.highlighted-blue,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) tspan.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) text.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) tspan.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) text.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) tspan.highlighted-blue,
		g.slide > g > text > tspan > tspan.highlighted-blue
		{
			animation: unhide-highlighted-blue 1s cubic-bezier(0, 0, 0.53, 1) 0s 1 forwards;
		}

		g.slide:not([hidden]) {
			animation: unhide-slide 1s ease 0s 1 forwards;
		}

		.unhide-slide:not(.no-slide-in):not(.no-slide-in2) {
			animation: unhide-slide 1s ease 0s 1 forwards;
		}

		.unhide-slide.no-slide-in {
			animation: no-unhide-slide 1s ease 0s 1 forwards;
		}

		.unhide-slide.no-slide-in2 {
			animation: no-unhide-slide2 1s ease 0s 1 forwards;
		}

		.hide-slide {
			animation: hide-slide 1s ease 0s 1 forwards;
		}


		@keyframes unhide {
			0%   { transform: translateY(-60px); stroke: rgba(255, 255, 255, 1); stroke-width: 5px; }
			100% { transform: translateY(0); stroke: rgba(255, 255, 255, 0) }
		}

		@keyframes unhide-highlighted {
			0%   { transform: translateY(-60px); stroke: rgba(255, 255, 255, 1); stroke-width: 5px; }
			100% { transform: translateY(0); stroke: rgba(0, 255, 255, 1); stroke-width: 2px; }
		}

		@keyframes unhide-highlighted-blue {
			0%   { transform: translateY(-60px); stroke: rgba(255, 255, 255, 1); stroke-width: 5px; }
			100% { transform: translateY(0); stroke: rgb(255, 177, 100); stroke-width: 2px; }
		}

		@keyframes unhide-slide {
			from   { transform: translateY(-60px); }
		}

		@keyframes no-unhide-slide {
			from   { transform: translateY(60px); }
		}

		@keyframes no-unhide-slide2 {
			/* from   { transform: translate(150px, -550px) rotate(45deg); } */
		}

		@keyframes hide-slide {
			to   { transform: translateY(-60px); opacity: 0; }
		}

		g.slide#title {
			animation: unhide-svg 10s cubic-bezier(0, 1, 0, 1) 0s 1 forwards !important;
		}

		@keyframes unhide-svg {
			0%   { transform: scale(0) translate(1100px, 1600px); }
			100% { transform: scale(1) translate(0, 0); }
		}

		@font-face {
			font-family: 'Press Start 2P';
			src: url('./fonts/Press_Start_2P/PressStart2P-Regular.ttf') format('truetype');
			font-weight: 400;
			font-style: normal;
			font-display: block;
		}

		@font-face {
			font-family: 'Ysabeau Office';
			src: url('./fonts/Ysabeau_Office/static/YsabeauOffice-Regular.ttf') format('truetype');
			font-weight: 400;
			font-style: normal;
			font-display: block;
		}

		@font-face {
			font-family: 'Ysabeau Office';
			src: url('./fonts/Ysabeau_Office/static/YsabeauOffice-Medium.ttf') format('truetype');
			font-weight: 500;
			font-style: normal;
			font-display: block;
		}

		* {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
		}

		html, body, #container, #overlay {
			height: 100%;
			width: 100%;
			font-size: 12pt
		}

		.h1, .h2, .h3, .h4 {
			font-family: "Press Start 2P";
			color: hsl(265, 89%, 78%);
			text-align: center;
			line-height: 1.25;
		}

		.h2, .h3, .h4 {
			fill: hsl(265, 89%, 78%);
		}

		h1, .h1 {
			font-size: 8rem;
		}

		h2, .h2 {
			font-size: 4.25rem;
		}

		.h3 {
			font-size: 2.75rem;
		}

		.h4 {
			font-size: 2rem;
		}

		#container, #overlay {
			height: 100%;
			width: 100%;
			position: absolute;
			background-color: #000
			/* animation: container-background 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0s 1 forwards; */
		}

		#overlay {
			position: fixed;
			background: none;
		}

		@keyframes container-background {
			0% { background-color: hsl(231, 15%, 18%) }
			100%   { background-color: #000 }
		}

		/* .slide {
			padding-top: 1in;
			padding-bottom: 1in;
			padding-left: 1in;
			padding-right: 1in;
		} */

		ol, ul, p, pre {
			font-size: 2.5rem;
			color: #F8F8F2;
			font-family: "Press Start 2P";
			line-height: 1.25;
			letter-spacing: -2px;
		}

		ol, ul, p {
			margin-left: 4rem;
		}

		.slide > p,
		.slide > ul,
		.slide > ol {
			margin-top: 1rem;
		}

		ol ol {
			list-style-type: lower-alpha;
		}

		a {
			color:aqua
		}
	</style>


<style>

.stroke-rain {
	stroke: hsl(0, 100%, 50%);
	animation: strokeHue 2s linear infinite !important;
}

@keyframes strokeHue {
	0%   { stroke: hsl(0,   100%, 50%); }   /* red */
	25%  { stroke: hsl(90,  100%, 50%); }   /* green */
	50%  { stroke: hsl(180, 100%, 50%); }   /* cyan */
	75%  { stroke: hsl(270, 100%, 50%); }   /* purple */
	100% { stroke: hsl(360, 100%, 50%); }   /* back to red */
}

.sub {
	font-size: 60%;
	baseline-shift: -10px;
	letter-spacing: -8px;
}

.super {
	font-size: 60%;
	baseline-shift: 20px;
	letter-spacing: -8px;
}

.sub-space {
	letter-spacing: -11px;
}

.undies {
	font-size: 80%;
}

.ceil {
	baseline-shift: 13px;
}

.hidey-ones {
	opacity: 0;
}

.bullet {
	font-size: 112.5%;
	baseline-shift: 0px;
	letter-spacing: -8px;
}

.bullet-dot {
	font-size: 150%;
	baseline-shift: 6px;
	letter-spacing: -8px;
}

</style>


	<script>
	    const global_animations = [];
		const global_scrolls = [];
		const state_transitions = new Map();
		const post_processes = [];
	</script>
</head>

<body style="padding-bottom: 0px; padding-right: 0px">

<svg id="container" viewBox="0 0 1920 1080" version="1.1" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMin meet">
	<g class="slide" id="title">
		  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7"
            refX="8" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" stroke="rgb(0, 255, 255)"/>
    </marker>

	<marker id="arrowhead-orange" markerWidth="10" markerHeight="7"
            refX="8" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" stroke="rgb(255, 177, 100)"/>
    </marker>
  </defs>
		<text class="h1 title-line" x="965" y="300" fill="#F7A41D" text-anchor="middle">Double-Buffers</text>
		<!-- <text class="h1 title-line" x="965" y="575" fill="#F7A41D" text-anchor="middle">HHID Cache</text> -->

		<text class="h1 title-line" x="965" y="475" fill="#F7A41D" text-anchor="middle">&</text>

		<g class="title-line">
			<text class="h1" x="965" y="650" fill="#F7A41D" text-anchor="middle">VPGATHERDD</text>
		</g>

		<text class="h2" id="by-line-1" x="960" y="875" text-anchor="middle">by Niles Salter</text>
		<text class="h2" id="by-line-2" x="960" y="975" text-anchor="middle"><tspan style="stroke: rgb(0, 255, 255); stroke-width: 2px">https://validark.dev</tspan></text>

		<script>
			const EXTRA_DELAY = 0.25;

			global_animations.push({
				section: "title",
				selector: ".title-line, #zig-logo",
				slide_num: 0,
				animation_delay: `${0 + EXTRA_DELAY}s`,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { "letter-spacing": "-1em", opacity: 0, transform: "scale(0.25) translate(140rem, 50rem)", "font-size": "1rem" },
					30:  { opacity: 1, "font-size": "8rem" },
					100: { "letter-spacing": 0, opacity: 1, transform: "scale(1) translate(0, 0)", "font-size": "8rem" },
				}
			}, {
				section: "title",
				selector: ".title-line > text",
				slide_num: 0,
				animation_delay: `${0 + EXTRA_DELAY}s`,
				animation_duration: "3s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { "letter-spacing": "-1em" },
					100: { "letter-spacing": 0 },
				}
			}, {
				section: "title",
				selector: "#by-line-1, #by-line-2",
				slide_num: 0,
				animation_delay: `${2 + EXTRA_DELAY}s`,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { "letter-spacing": "-1em", opacity: 0 },
					25:  { opacity: 1 },
					100: { "letter-spacing": "-7px", opacity: 1 },
				}
			}, {
				section: "title",
				selector: "#logo-left-side",
				slide_num: 0,
				animation_delay: `${0 + EXTRA_DELAY}s`,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { transform: "scaleX(0) translateX(75px)" },
					100: { transform: "scaleX(1) translateX(0)" },
				}
			}, {
				section: "title",
				selector: "#logo-right-side",
				slide_num: 0,
				animation_delay: `${0 + EXTRA_DELAY}s`,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { transform: "scaleX(0) translateX(-75px)" },
					100: { transform: "scaleX(1) translateX(0)" },
				}
			}, {
				section: "title",
				selector: "#logo-middle",
				slide_num: 0,
				animation_delay: `${0 + EXTRA_DELAY}s`,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { transform: "scaleX(0) translateX(0)" },
					100: { transform: "scaleX(1) translateX(0)" },
				}
			});
		</script>
	</g>


	<g class="slide" id="motivation" clicks="28">
		<text class="h2" id="" x="980" y="100" text-anchor="middle">Motivating Example</text>
		<g click="2" id="marker-1"></g>
		<!-- <text class="h4" id="" x="250" y="300" text-anchor="start"></text>
		<text class="h4" id="" x="250" y="425" text-anchor="start">with guaranteed space</text>
		<text class="h4" id="" x="250" y="550" text-anchor="start">and memory constraints!</text> -->

		<script>
			const updated_first = new Set([1, 3, 4])
			document.getElementById("marker-1").insertAdjacentHTML("afterend", new Array(10).fill().map((_, i) => {
				return `&lt;g click="2" class="unhide-slide no-slide-in" style="transform: translate(${i === 9 ? `625px, 250px` : `${i*150}px, 700px`}) scale(0.5)"&gt;
		&lt;text class="h4" id="" x="672" y="600" text-anchor="middle" style="font-size:
		100px !important; fill: rgb(255, 177, 100) !important"&gt;${i === 9 ? 'W' : i}&lt;/text&gt;

		${1 ? `&lt;text click="${i === 9 ? '7-11' : '8-' + (updated_first.has(i) ? '14' : '20')}" class="h4" id="" x="672" y="450" text-anchor="middle" style="font-size:
		100px !important; fill: ${["rgb(255, 99, 132)", "rgb(72, 136, 255)"][0]} !important"&gt;${["A","B"][0]}&lt;/text&gt;` : ""}

		${`&lt;text click="${i === 9 ? '11-24' : updated_first.has(i) ? '14-26' : '20-26'}" class="h4" id="" x="672" y="450" text-anchor="middle" style="font-size:
		100px !important; fill: ${["rgb(255, 99, 132)", "rgb(72, 136, 255)"][1]} !important"&gt;${["A","B"][1]}&lt;/text&gt;`}

		${`&lt;text click="${24 + 2*(i !== 9)}" class="h4" id="" x="672" y="450" text-anchor="middle" style="font-size:
		100px !important; fill: ${["rgb(255, 99, 132)", "rgb(72, 136, 255)"][0]} !important"&gt;${["A","B"][0]}&lt;/text&gt;`}


		&lt;rect x="547" y="450" width="238" height="25.5" fill="rgb(255, 177, 100)"&gt;&lt;/rect&gt;
		&lt;rect x="547" y="475" width="25" height="138" fill="rgb(255, 177, 100)"&gt;&lt;/rect&gt;
		&lt;rect x="760" y="475" width="25" height="138" fill="rgb(255, 177, 100)"&gt;&lt;/rect&gt;
		&lt;rect x="547" y="612.5" width="238" height="25.5" fill="rgb(255, 177, 100)"&gt;&lt;/rect&gt;
		&lt;/g&gt;`;
			}).join("\n"));
		</script>

		<g id="motivation-group-4" click="4">
			<g click="4" class="unhide-slide no-slide-in" style="transform: translate(-200px, -100px)">
			<text class="h4" id="" x="772" y="700" text-anchor="middle" style="font-size:
			100px !important; fill: rgb(255, 99, 132) !important">A</text>
			<rect class="unhide-slide no-slide-in" x="647" y="550" width="238" height="25.5" fill="rgb(255, 99, 132)"></rect>
			<rect class="unhide-slide no-slide-in" x="647" y="575" width="25" height="138" fill="rgb(255, 99, 132)"></rect>
			<rect class="unhide-slide no-slide-in" x="860" y="575" width="25" height="138" fill="rgb(255, 99, 132)"></rect>
			<rect class="unhide-slide no-slide-in" x="647" y="712.5" width="238" height="25.5" fill="rgb(255, 99, 132)"></rect>
			</g>

			<g click="4" class="unhide-slide no-slide-in" style="transform: translate(200px, 100px)">
			<text class="h4" id="" x="1148" y="500" text-anchor="middle" style="font-size:
			100px !important; fill: rgb(72, 136, 255) !important">B</text>
			<rect x="1023" y="350" width="238" height="25.5" fill="rgb(72, 136, 255)"></rect>
			<rect x="1023" y="375" width="25" height="138" fill="rgb(72, 136, 255)"></rect>
			<rect x="1236" y="375" width="25" height="138" fill="rgb(72, 136, 255)"></rect>
			<rect x="1023" y="512.5" width="238" height="25.5" fill="rgb(72, 136, 255)"></rect>
			</g>
		</g>





		<script>
			document.getElementById("marker-1").insertAdjacentHTML("afterend", new Array(9).fill().map((_, i) => `&lt;line class="no-slide-in2 vertbar" click="5-28"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="960" x2="960" y1="540" y2="540"
		click-5="${340 + i*150}, ${445 + i*30}, 920, 650"
		click-6="${340 + i*150}, ${445 + i*30 + 776}, 920, 650"
		click-7="${339 + i*148}, ${120 + i*15 + 776}, 920, 580"
		click-8="${339 + i*148}, ${120 + i*15 + 776}, 860, 580"
		click-9="${340 + i*150}, ${445 + i*30}, 860, 650"
		click-10="${120 + i*15 + 776}, ${339 + i*148}, 570, 860"
		click-11="${120 + i*15 + 776}, ${339 + i*148}, 570, 860"
		click-12="${340 + i*150}, ${445 + i*30}, 860, 650"
		click-13="${updated_first.has(i) ? `${339 + i*148}, ${120 + i*15 + 776}, 860, 580` : `${340 + i*150}, ${445 + i*30}, 860, 650`}"
		click-14="${updated_first.has(i) ? `${339 + i*148}, ${120 + i*15 + 776}, 860, 580` : `${340 + i*150}, ${445 + i*30}, 860, 650`}"
		click-15="${updated_first.has(i) ? `${340 + i*150}, ${445 + i*30 + 776}, 860, 650` : `${340 + i*150}, ${445 + i*30}, 860, 650`}"
		click-16="${120 + i*15 + 776}, ${339 + i*148}, 570, 860"
		click-17="${120 + i*15 + 776}, ${339 + i*148}, 570, 860"
		click-18="${updated_first.has(i) ? `${340 + i*150}, ${445 + i*30 + 776}, 860, 650` : `${340 + i*150}, ${445 + i*30}, 860, 650`}"
		click-19="${updated_first.has(i) ? `${340 + i*150}, ${445 + i*30 + 776}, 860, 650` : `${339 + i*148}, ${120 + i*15 + 776}, 860, 580`}"
		click-20="${updated_first.has(i) ? `${340 + i*150}, ${445 + i*30 + 776}, 860, 650` : `${339 + i*148}, ${120 + i*15 + 776}, 860, 580`}"
		click-21="${true ? `${340 + i*150}, ${445 + i*30 + 776}, 860, 650` : `${339 + i*148}, ${120 + i*15 + 776}, 860, 580`}"
		click-22="${120 + i*15 + 776}, ${339 + i*148}, 570, 860"
		click-23="${120 + i*15 + 776}, ${339 + i*148}, 570, 860"
		click-24="${120 + i*15 + 776}, ${339 + i*148}, 570, 860"
		click-25="${339 + i*148}, ${120 + i*15 + 776}, 860, 580"
		click-26="${339 + i*148}, ${120 + i*15 + 776}, 860, 580"
		click-27="${340 + i*150}, ${445 + i*30}, 860, 650"
		<!-- click-15="${340 + i*150}, ${445 + i*30 + 776}, 860, 650" -->
		&gt;&lt;/line&gt;`).join("\n"));

		document.getElementById("marker-1").insertAdjacentHTML("afterend", new Array(1).fill().map((_, i) => `&lt;line class="no-slide-in2 vertbar" click="5-26"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="960" x2="960" y1="540" y2="540"
		click-5="1020, 1210, 520, 520"
		click-6="890, 700, 520, 520"
		click-7="960, 960, -50000, -50000"
		click-8="960, 960, -50000, -50000"
		click-9="960, 960, -50000, -50000"
		click-10="1020, 1210, 520, 520"
		click-11="960, 960, -50000, -50000"
		click-12="960, 960, -50000, -50000"
		click-13="960, 960, -50000, -50000"
		click-14="960, 960, -50000, -50000"
		click-15="960, 960, -50000, -50000"
		click-16="890, 700, 520, 520"
		click-17="890, 700, 520, 520"
		click-18="890, 700, 520, 520"
		click-19="890, 700, 520, 520"
		click-20="890, 700, 520, 520"
		click-21="890, 700, 520, 520"
		click-22="890, 700, 520, 520"
		click-23="890, 700, 520, 520"
		click-24="890, 700, 520, 520"
		click-25="890, 700, 520, 520"
		&gt;&lt;/line&gt;`).join("\n"));
		</script>


		<text class="h2" click="17-23" id="" x="800" y="560" text-anchor="middle" style="fill: red !important">X</text>

		<script>
			{
			let iter = 0;
			let iter2 = 0;
			let y = 225+50+4.5*100-65-50-400;
			let tmp = 0;


			const bullets = {
				0: "&lt;tspan class=\"bullet\"&gt;&bullet;&lt;/tspan&gt;&ThinSpace;&ThinSpace;&ThinSpace;",
				2: "&lt;tspan class=\"bullet-dot\"&gt;.&lt;/tspan&gt;",
			};

		const colors2 = new Map([
			["cyan", "rgb(0, 255, 255)"],
			["orange", "rgb(255, 177, 100)"],
			["red", "rgb(255, 99, 132)"],
			["green", "rgb(144, 238, 144)"],
			["yellow", "rgb(255, 255, 102)"],
			["pink", "rgb(255, 112, 255)"],
			["blue", "rgb(70, 255, 180)"],
			["pink", "rgb(255, 15, 180)"],
			["gold", "rgb(255, 215, 20)"],

			<!-- lime green: rgb(70, 255, 180) -->
		]);

		let click_offset = 1;

		document.getElementById("marker-1").insertAdjacentHTML("afterend", [
				":Let's imagine we have a multi-threaded server",
				"~:And a double-buffered cache system",
		].map((x, i) => {
			x = x.replaceAll(/^~/g, (_, spaces) => (click_offset++, ""));
			x = x.replace(/^( *):/, (_, spaces) => "&nbsp;".repeat(spaces.length) + bullets[spaces.length]);
			x = x.replaceAll(/:(.+?):{(.+?)\}/g, (_, color, content) => `&lt;tspan fill=\"${colors2.get(color)}\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/\_\{(.+?)\}/g, (_, content) => `&lt;tspan class=\"sub\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/\^\{(.+?)\}/g, (_, content) => `&lt;tspan class=\"super\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/```(.+?)```/g, (_, content) => `&lt;tspan class=\"stroke-rain\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/``(.+?)``/g, (_, content) => `&lt;tspan class=\"highlighted\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/`(.+?)`/g, (_, content) => `&lt;tspan class=\"highlighted-blue\"&gt;${content}&lt;/tspan&gt;`);

			return x.slice(0, 2) === '--'
						? `&lt;text click="${i + click_offset}" class="h4" x="80" y="${tmp=y,y+=50+10+30,y}" text-anchor="start"&gt;${["&nbsp;&nbsp;i", "&nbsp;ii", "iii", "&nbsp;iv"][iter2++]}. ${x.slice(2)}&lt;/text&gt;`
						: x[0] === '-'
							? `&lt;text click="${i + click_offset}" class="h4" x="80" y="${tmp=y,y+=50+10+30,y}" text-anchor="start"&gt;${x.slice(2)}&lt;/text&gt;`
							: `&lt;text click="${i + click_offset}" class="h4" x="30" y="${tmp=y,y+=65-10,y}" text-anchor="start"&gt;${x}&lt;/text&gt;`
			}).join(""));
		}
		</script>
	</g>

	<g class="slide" id="writer-code" clicks="4">
		<text class="h2" id="" x="980" y="100" text-anchor="middle">Cache-Writer Check</text>

		<g click class="code" id="zig-code-1" x="50" y="150" width="1920" line-height="80" line-num-indent="80"
		line-indent="100" hide-background lang="zig" steps="-2,2:5,7:4">
		pub fn writer_begin_update(self: *@This()) ?struct { *T, *T } {
			for (self.thread_phases) |t_phase| {
				if (t_phase.phase.load(.acquire) != self.prev_phase) {
					return null;
				}
			}
			return .{
				&self.buffer_data[prev_phase & 1].data,
				&self.buffer_data[(prev_phase +% 1) & 1].data,
			};
		}
		</g>
	</g>

	<g class="slide" id="vectorized-code" clicks="17">
		<text class="h2" id="vectorizable-title" x="980" y="100" text-anchor="middle">We can vectorize that!</text>

		<g click="1" class="code" id="asm-code-full" x="50" y="100" width="1920" line-height="80" line-num-indent="80"
		line-indent="100" hide-background lang="asm" steps="16,7">
		.LBB0_1:
			bzhi    r8d, edx, ecx
			cmp     ecx, 64
			cmovae  r8d, edx
			kmovd   k1, r8d
			vmovdqa64       zmm3, zmm0
			vpgatherdd      zmm3 {k1}, dword ptr [rax + 8*zmm2]
			vpternlogd      zmm1, zmm3, zmm0, 246
			add     rax, 1024
			sub     ecx, 16
			ja      .LBB0_1
		</g>

		<g click="3" class="code" id="asm-code-partial" x="50" y="100" width="1920" line-height="80" line-num-indent="80"
		line-indent="204" hide-background hide-line-numbers lang="asm">






			vpgatherdd      zmm3 {k1}, dword ptr [rax + 8*zmm2]
		</g>

		<line class="no-slide-in2 vertbar" click="4-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="0" x2="0" y1="700" y2="700"
		click-4="100, 250, 720, 670"
		></line>

		<text click="4-16" class="h3" id="" x="5" y="770" text-anchor="start">vector</text>

		<line class="no-slide-in2 vertbar" click="5-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="300" x2="395" y1="820" y2="680"
		click-5="250, 295, 820, 680"
		></line>

		<text click="5-16" class="h3" id="" x="150" y="870" text-anchor="start">packed</text>

		<line class="no-slide-in2 vertbar" click="6-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="480" x2="480" y1="900" y2="900"
		click-6="480, 480, 920, 675"
		></line>

		<text click="6-16" class="h3" id="" x="460" y="970" text-anchor="start">dword<tspan style="font-size: 60%;
		baseline-shift: 10px;"> (indices=i32)</tspan></text>

		<line class="no-slide-in2 vertbar" click="7-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="480" x2="480" y1="920" y2="675"
		click-7="1050, 1500, 920, 675"
		></line>





		<line class="no-slide-in2 vertbar" click="8-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="650" x2="650" y1="820" y2="820"
		click-8="650, 510, 820, 675"
		></line>



		<text click="8-16" class="h3" id="" x="550" y="870" text-anchor="start">dword<tspan style="font-size: 60%;
		baseline-shift: 10px;"> (load size)</tspan></text>

		<line class="no-slide-in2 vertbar" click="9-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="650" x2="510" y1="820" y2="675"
		click-9="649, 1010, 820, 675"
		></line>



		<text click="10-16" class="h3" id="" x="900" y="420" text-anchor="start">pointer to an array</text>

		<line class="no-slide-in2 vertbar" click="11-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="1100" x2="1100" y1="420" y2="420"
		click-11="1100, 1300, 420, 600"
		></line>

		<text click="12-16" class="h3" id="" x="650" y="520" text-anchor="start">mask</text>

		<line class="no-slide-in2 vertbar" click="13-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="730" x2="730" y1="520" y2="520"
		click-13="730, 860, 520, 600"
		></line>

		<text click="14-16" class="h3" id="" x="50" y="570" text-anchor="start">destination</text>

		<line class="no-slide-in2 vertbar" click="15-16"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"
		x1="540" x2="540" y1="570" y2="570"
		click-15="540, 660, 570, 616"
		></line>

		<g click="16" class="code" id="zig-equivalent" x="0" y="0" width="1920" line-height="80" line-num-indent="80"
		line-indent="0" hide-background hide-line-numbers lang="zig">
			fn vpgatherdd(
				zmm3: @Vector(16, i32),
				k1: @Vector(16, bool),
				rax: [*]const i32,
				zmm2: @Vector(16, i32),
			) @Vector(16, i32) {
				zmm3 = k1 ? @as(@Vector(16, *i32), @splat(rax) + zmm2).* : zmm3;
				return zmm3;
			}
		</g>

		<script>
			global_animations.push({
				section: "vectorized-code",
				selector: "#asm-code-partial",
				slide_num: 3,
				animation_duration: "5s",
				continuous: true,
				keyframes: {
					0:   { opacity: 1, transform: "translate(0, 0)" },
					40:  { transform: "translate(0, 0)" },
					100: { opacity: 1, transform: "translate(0, 0px)" },
				}
			}, {
				section: "vectorized-code",
				selector: "#asm-code-full, #vectorizable-title",
				slide_num: 3,
				animation_duration: "2s",
				continuous: true,
				keyframes: {
					0:   { opacity: 1 },
					100: { opacity: 0 },
				}
			}, {
				section: "vectorized-code",
				selector: "#asm-code-partial",
				slide_num: 16,
				animation_duration: "1s",
				continuous: true,
				keyframes: {
					0:   { opacity: 1, transform: "translate(0, 0)" },
					100: { opacity: 1, transform: "translate(0, 200px)" },
				}
			});
		</script>
	</g>

	<g class="slide" id="conclusory">
		<text class="h2" id="conclusion-title" x="980" y="100" text-anchor="middle">Other variants</text>

		<script>
			{
			let iter = 0;
			let iter2 = 0;
			let y = 225+50+4.5*100-65-50-400;
			let tmp = 0;


			const bullets = {
				0: "&lt;tspan class=\"bullet\"&gt;&bullet;&lt;/tspan&gt;&ThinSpace;&ThinSpace;&ThinSpace;",
				2: "&lt;tspan class=\"bullet-dot\"&gt;.&lt;/tspan&gt;",
			};

		const colors2 = new Map([
			["cyan", "rgb(0, 255, 255)"],
			["orange", "rgb(255, 177, 100)"],
			["red", "rgb(255, 99, 132)"],
			["green", "rgb(144, 238, 144)"],
			["yellow", "rgb(255, 255, 102)"],
			["pink", "rgb(255, 112, 255)"],
			["blue", "rgb(70, 255, 180)"],
			["pink", "rgb(255, 15, 180)"],
			["gold", "rgb(255, 215, 20)"],

			<!-- lime green: rgb(70, 255, 180) -->
		]);

		let click_offset = 1;

		document.getElementById("conclusion-title").insertAdjacentHTML("afterend", [
				":We have 4 possible combinations of ```gather``` instructions!",
				"  :`vpgatherdd`, ``vpgatherdq``, `vpgatherqd`, ``vpgatherqq``",
				":We have 4 possible combinations of ```scatter``` instructions!",
				"  :We can use these to issue 8 or 16 stores at once!",
				":`vpscatterdd`, ``vpscatterdq``, `vpscatterqd`, & ``vpscatterqq``",
				"  :Unfortunately, these can't be used for multi-threaded",
				"&nbsp;&nbsp;&nbsp;\"release\" stores. But most stores are fair game!",
		].map((x, i) => {
			x = x.replaceAll(/^~/g, (_, spaces) => (click_offset++, ""));
			x = x.replace(/^( *):/, (_, spaces) => "&nbsp;".repeat(spaces.length) + bullets[spaces.length]);
			x = x.replaceAll(/:(.+?):{(.+?)\}/g, (_, color, content) => `&lt;tspan fill=\"${colors2.get(color)}\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/\_\{(.+?)\}/g, (_, content) => `&lt;tspan class=\"sub\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/\^\{(.+?)\}/g, (_, content) => `&lt;tspan class=\"super\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/```(.+?)```/g, (_, content) => `&lt;tspan class=\"stroke-rain\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/``(.+?)``/g, (_, content) => `&lt;tspan class=\"highlighted\"&gt;${content}&lt;/tspan&gt;`);
			x = x.replaceAll(/`(.+?)`/g, (_, content) => `&lt;tspan class=\"highlighted-blue\"&gt;${content}&lt;/tspan&gt;`);

			return x.slice(0, 2) === '--'
						? `&lt;text click="${i + click_offset}" class="h4" x="80" y="${tmp=y,y+=5+50+10+30,y}" text-anchor="start"&gt;${["&nbsp;&nbsp;i", "&nbsp;ii", "iii", "&nbsp;iv"][iter2++]}. ${x.slice(2)}&lt;/text&gt;`
						: x[0] === '-'
							? `&lt;text click="${i + click_offset}" class="h4" x="80" y="${tmp=y,y+=5+50+10+30,y}" text-anchor="start"&gt;${x.slice(2)}&lt;/text&gt;`
							: `&lt;text click="${i + click_offset}" class="h4" x="30" y="${tmp=y,y+=5+65-10,y}" text-anchor="start"&gt;${x}&lt;/text&gt;`
			}).join(""));
		}
		</script>
	</g>

	<g class="slide" id="end">
		<text class="h2" x="960" y="525" text-anchor="middle" style="font-size: 100px; letter-spacing: 0.1px;">fin</text>
	</g>
</svg>

<svg id="overlay" style="overflow: hidden; width: 100%;" y="5000" viewBox="0 0 1920 1080" version="1.1" xmlns="http://www.w3.org/2000/svg">
</svg>

<style>
	#button-left, #button-right {
		position: fixed;
		font-size: 2rem;
		font-family: 'Press Start 2P';
		bottom: 1rem;
		color: white;
		text-align: center;
		align-content: center;
		height: 1.5rem;
		width: 4rem;
		padding: 0.5rem 0.85rem;
		background: none;
		border: none;
	}

	#button-left {
		left: 0rem;
	}

	#button-right {
		right: 0rem;
	}

	.code-star {
		alignment-baseline: middle;
	}

	.code-color-white { fill: #fff; }
	.code-color-0 { fill: rgb(80, 250, 123); }
	.code-color-1 { fill: #60f4d4; }
	.code-color-2 { fill: rgb(189, 147, 249); }
	.code-color-3 { fill: rgb(255, 121, 198); }
	.code-color-4 { fill: rgb(255, 184, 104); }
	.code-color-5 { fill: #F1FA8C; }
	.code-color-6 { fill: #7960f4; }
	.code-color-7 { fill: #f46060; }
	/* .code-color-8 { fill: #60f4d4; } */

	.code-block-label {
		text-decoration: underline;
		fill: rgb(80, 250, 123);
	}

	.code-builtin {
		fill: rgb(139, 233, 253);
	}

	.code-num {
		fill: rgb(189, 147, 249);
	}

	.code-type, .code-keyword, .code-symbol-1, .code-symbol-2 {
		fill: rgb(255, 121, 198);
	}

	.code-symbol-2 {
		baseline-shift: -14px;
	}

	.code-struct-type {
		fill: rgb(255, 184, 104);
		font-style: italic;
	}

	.code-register {
		fill: #b6c8ff;
	}

	.code-register-2, .code-register-3 {
		fill: rgb(255, 184, 104);
		font-style: italic;
	}

	.code-comment {
		font-style: normal;
		fill: #6272a4;
	}

	.code-type {
		font-style: italic;
	}

	.code-string {
		fill: #F1FA8C;
	}

	.code-space {
		fill: rgb(98, 114, 164);
	}

	.bit-1 {
		fill: #F1FA8C;
	}

	.line-of-code, .line-number, .bits, .label, .small-label, .xsmall-label, .ysmall-label, .big-label {
		font-family: 'Iosevka', 'Press Start 2P', 'Courier New', Courier, monospace;
		font-size: 64px;
		letter-spacing: -6px;
		fill: rgb(248, 248, 242)
	}

	.bits, .bits .code-type {
		font-style: normal;
	}

	.line-number {
		font-size: 45px;
	}

	.label {
		font-size: 40px;
		baseline-shift: 10px;
		letter-spacing: -4px;
	}

	.small-label {
		font-size: 28px;
		baseline-shift: 10px;
		letter-spacing: -1px;
	}

	.xsmall-label {
		font-size: 20px;
		baseline-shift: 10px;
		letter-spacing: -1px;
	}

	.ysmall-label {
		font-size: 25px;
		baseline-shift: 10px;
		letter-spacing: -1px;
	}

	.big-label {
		font-size: 70px;
	}

	.code-func-name {
		fill: rgb(80, 250, 123);
	}

	.code-instruction {
		fill: rgb(255, 121, 198);
	}

	.code-keyword-asm {
		fill: rgb(255, 184, 104);
	}

	.code-curly-0 { fill: rgb(248, 248, 242); }
	.code-curly-1 { fill: rgb(255, 121, 198); }
	.code-curly-2 { fill: rgb(139, 233, 253); }
	.code-curly-3 { fill: rgb(80, 250, 123); }
	.code-curly-4 { fill: rgb(189, 147, 249); }
	.code-curly-5 { fill: rgb(255, 184, 104); }

	.code-paren-0 { fill: rgb(248, 248, 242); }
	.code-paren-1 { fill: #F1FA8C; }
	.code-paren-2 { fill: rgb(255, 184, 104); }
	.code-paren-3 { fill: rgb(255, 121, 198); }
 	.code-paren-4 { fill: rgb(189, 147, 249); }
 	.code-paren-5 { fill: rgb(139, 233, 253); }

	.code-brack-0 { fill: #F1FA8C; }
	.code-brack-1 { fill: rgb(255, 184, 104); }
	.code-brack-2 { fill: rgb(255, 121, 198); }
	.code-brack-3 { fill: rgb(189, 147, 249); }
	.code-brack-4 { fill: rgb(139, 233, 253); }
	.code-brack-5 { fill: rgb(248, 248, 242); }

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Bold-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Bold-Italic.woff') format('woff');
		font-weight: 700;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Bold.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Bold.woff') format('woff');
		font-weight: 700;
		font-style: normal;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold-Italic.woff') format('woff');
		font-weight: 800;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold.woff') format('woff');
		font-weight: 800;
		font-style: normal;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Italic.woff') format('woff');
		font-weight: 400;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Medium-Italic.woff') format('woff');
		font-weight: 500;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Medium.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Medium.woff') format('woff');
		font-weight: 500;
		font-style: normal;
		font-display: swap;
	}
	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Regular.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Regular.woff') format('woff');
		font-weight: 400;
		font-style: normal;
		font-display: swap;
	}
</style>

<button id="button-left" onclick="goBackward()">&lt;</button>
<button id="button-right" onclick="goForward()">&gt;</button>

<style>
	.thin-space {
		letter-spacing: -0.3em;
	}
</style>

<script>
	const code_snippets = new Map();
	code_snippets.set("title", "HHID Cache in Zig\nby Niles Salter (validark.dev)");

	function processRanges(ranges, joined_lines) {
		return ranges
			.reduce((a, [n, start, end]) =>
				`${a.slice(0, start)}<tspan class="code-${n}">${n === "register-2" ? "<tspan class=\"thin-space\">&nbsp;</tspan>" : ""}${
					a.slice(start, end)
					.replaceAll(/ +/g, e => "&nbsp;".repeat(e.length))
				}${n === "register-2" ? "<tspan class=\"thin-space\">&nbsp;</tspan>" : ""}</tspan>${a.slice(end)}`,
				joined_lines.replaceAll("&gt;", ">").replaceAll("&lt;", "<")
			)
			.split('\n');
	}

	function preprocess(slide_id, text, lang) {
		let start_pos = text.indexOf("\n");
		let end_pos = text.lastIndexOf("\n");

		if (text.slice(0, start_pos + 1).trim() !== "")
			start_pos = -1;

		if (text.slice(end_pos, -1).trim() !== "")
			end_pos = -1

		let lines = text
			.slice(start_pos + 1, end_pos)
			.split('\n')
			.map(e => e.trimRight().replaceAll('\t', '    '));

		const unnecessary_whitespace = lines
			.filter(e => e)
			.reduce((a, c) => Math.min(a, c.length - c.trimLeft().length), Number.POSITIVE_INFINITY);

		lines = lines.map(e => e.slice(unnecessary_whitespace));
		code_snippets.set(slide_id, (code_snippets.get(slide_id) || "") +
			lines
				.join("\n")
				.replaceAll("&gt;", ">")
				.replaceAll("&lt;", "<")
				.replaceAll("&amp;", "&")
		);
		let curly_depth = 0;
		let paren_depth = 0;

		const joined_lines = lines.join('\n')
			.replaceAll("&gt;&gt;", "&raquo;")
			.replaceAll("&lt;&lt;", "&laquo;")
			.replaceAll("-&gt;", "&RightArrow;")
			.replaceAll(" =&gt; ", " &rArr; ")
			.replaceAll(" != ", " &ne; ")
			.replaceAll(" &lt;= ", " &le; ")
			.replaceAll(" &gt;= ", " &ge; ")
			.replaceAll(" == ", " &Equal; ")
			.replaceAll("&lt;", "<")
			.replaceAll("&gt;", ">");

		const ranges = new Array();

		// for (; )
		// for (let regex = /".+?"/g, cur = regex.exec(joined_lines); cur; cur = regex.exec(joined_lines));

		// const meme = RegExp.prototype.exec.bind(/".+?"/g, joined_lines);
		// joined_lines;

		const in_match = new Array(joined_lines.length).fill(false);

		if (lang === 'zig' || lang === 'ziggy') {
			// console.log(joined_lines);

			// let pos = 0;
			for (const match of joined_lines.matchAll(lang === "ziggy" ? /\/\/([^_]*|$)|"[^_]*?(?<!\\)"|'[^_]*?'|\\\\([^_]*|$)/g : /\/\/([^\n]*|$)|"[^\n]*?(?<!\\)"|'[^\n]*?'|\\\\([^\n]*|$)/g)) {
				const { index, 0: { length } } = match;
				for (let q = 0; q < length; q++) in_match[index + q] = true;
				ranges.push([match[0][0] === '/' ? "comment" : "string", index, index + length]);
			}



			// for (const [regex, name] of [
			// 	[/\/\/([^\n]*|$)/g, "comment"],
			// 	[/"[^\n]*?"|'[^\n]*?'/g, "string"],
			// ]) {
			// 	outer: for (const { index, 0: s } of joined_lines.matchAll(regex)) {
			// 		const { length } = s;
			// 		// console.log({index, length, s})
			// 		for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
			// 		for (let q = 0; q < length; q++) in_match[index + q] = true;
			// 		ranges.push([name, index, index + length]);
			// 	}
			// }

			for (const [regex, name] of [
				[/(?<!\w)(usingnamespace|linksection|threadlocal|unreachable|addrspace|allowzero|nosuspend|anyframe|callconv|comptime|continue|errdefer|noinline|volatile|anytype|noalias|suspend|export|undefined|extern|inline|opaque|orelse|packed|false|true|null|resume|return|struct|switch|align|async|await|break|catch|const|defer|error|union|while|else|enum|test|and|asm|for|pub|try|var|fn|if|or)(?!\w)/g, "keyword"],
				[/(?<!\w)(Carry|HHID|Allocator|IndexItem|FastDivider32|IpAddress|T)(?!\w+)/g, "struct-type"],
				[/@\w+/g, "builtin"],
				[/ +/g, "space"],
				[/(?:&rArr;)|(?:&amp;)|(?:&ne;)|(?:&le;)|(?:&ge;)|(?:&Equal;)|(?:&raquo;)|(?:&laquo;)|(?:&RightArrow;)|[+*-]?%|\.\.\.?|[:=><!+~?|^/-]|\.(?=\*)|(?<!\.)\*/ug, "symbol-1"],
				[/(?<=\.)\*/g, "symbol-2"],
				[/\w+(?=\()|(?<=fn )\w+/g, "func-name"],
				[/(?<!\w)(?:[ui]\d+|void|bool|u?int|[ui]size)(?!\w)/g, "type"],
				[/(?<!\w)0x[\dA-Fa-f]+/g, "num"],
				[/(?<!\w)(?:0[b])?\d+/g, "num"],
				[/\*/g, "star"],
			]) {
				outer: for (const { index, 0: { length } } of joined_lines.matchAll(regex)) {
					for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
					for (let q = 0; q < length; q++) in_match[index + q] = true;
					ranges.push([name, index, index + length]);
				}
			}
		} else if (lang === "asm") {
			for (const [regex, name] of [
				[/"[^\n]+?"|'[^\n]+?'/g, "string"],
				[/;([^\n]+|$)/g, "comment"],
			]) {
				outer: for (const { index, 0: { length } } of joined_lines.matchAll(regex)) {
					for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
					for (let q = 0; q < length; q++) in_match[index + q] = true;
					ranges.push([name, index, index + length]);
				}
			}

			for (const [regex, name] of [
				[/ +/g, "space"],
				[/\+/g, "symbol-1"],
				[/\*/g, "star"],
				[/(?<!\w)(?:[re]?[abcd]x|[abcd][hl]|[er]?[sb]p|[er]?[ds]i|r[89][bwd]?|r1[0-5][bwd]?|[xyz]mm[0-9]|zmm[12][0-9]|[xy]mm1[0-5]|zmm3[01]|rip)(?!\w)/g, "register"],
				[/(?<=\{)(?:k[0-7])(?=\})/g, "register-2"],
				[/(?<!\w)(?:k[0-7])(?!\w)/g, "register-3"],
				// [/[:=]/g, "symbol-1"],
				[/.LBB\d+_\d+/g, "block-label"],
				[/(?<!\w)0x\d+/g, "num"],
				[/(?<!\w)-?\d+/g, "num"],
				[/(?<=call +)[_.\w]+/g, "func-name"],
				[/(?<=\+ ?)[_.\w]+/g, "func-name"],
				[/(?<=^|\n)[_.\w]+:/g, "func-name"],
				[/(?<!\w)(qword|ptr|dword|byte|word|xmmword|ymmword|zmmword)(?!\w)/g, "keyword-asm"],
				[/(?<=^[ \t]*|\n[ \t]*)\.?\w+/g, "instruction"],
				]) {
					if (name === "instruction") {
						for (const x of joined_lines.matchAll(regex)) {
							const { index, 0: { length } } = x;
							// console.log(index, length, x);
						}
					}

				outer: for (const { index, 0: { length } } of joined_lines.matchAll(regex)) {
					if (length === 0) throw new Error("bad news");
					for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
					for (let q = 0; q < length; q++) in_match[index + q] = true;
					ranges.push([name, index, index + length]);
				}
			}
		} if (lang === "rainbow") {
			let cur_color = 0;
			for (let i = 0; i < joined_lines.length; ) {
				for (; i < joined_lines.length && joined_lines[i] !== '1'; i++) {
					ranges.push([`color-white`, i, i + 1]);
				}
				for (; i < joined_lines.length && joined_lines[i] === '1'; i++) {
					ranges.push([`color-${5}`, i, i + 1]);
				}
				cur_color += 1;
			}
		}


		// .replaceAll(//g, (_, pre, e) => `${pre}<tspan class="code-func-name">${e}</tspan>`)

		for (const [regex, name, [opener, closer]] of [
			[/[{}]/g, "curly", "{}"],
			[/[()]/g, "paren", "()"],
			[/[[\]]/g, "brack", "()"],
		]) {
			outer: for (const { index, 0: { 0: e, length } } of joined_lines.matchAll(regex)) {
				for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
				for (let q = 0; q < length; q++) in_match[index + q] = true;
				if (e === closer) {
					curly_depth--;
				}

				ranges.push([`${name}-${curly_depth % 6}`, index, index + length]);

				if (e === opener) {
					curly_depth++;
				}
			}
		}

		return [
			processRanges(ranges.sort(([, a], [, b]) => b - a), joined_lines),
			ranges
		];
	}

	const container = document.getElementById("container");
	const overlay = document.getElementById("overlay");
	const slide_elements = [...container.children];
	const overlay_elements = slide_elements.map(e => document.getElementById(e.id + "-overlay") || (() => {
		// console.log(e);
		overlay.insertAdjacentHTML("beforeend", `<g class="slide" id="${e.id}-overlay"></g>`)
		return document.getElementById(`${e.id}-overlay`);
	})());

	const EmptyFunction = () => {};

	const clicks = new Map();
	const slidesById = new Map();
	const pane_heights = new Map();

function applyState(line, s) {
  line.setAttribute("x1", s.x1);
  line.setAttribute("y1", s.y1);
  line.setAttribute("x2", s.x2);
  line.setAttribute("y2", s.y2);
}

let my_thread = { id: 0 };

// Critically damped (no overshoot, fastest)
const STIFFNESS_DEFAULT = 25;
const zeta = 1; // critical
const DAMPING_DEFAULT = 2 * Math.sqrt(STIFFNESS_DEFAULT) * zeta; // ≈ 10

// Slightly overdamped (no overshoot, a bit “heavier” feel)
// const stiffness = 25;
// const zeta = 1.2;
// const damping = 2 * Math.sqrt(stiffness) * zeta; // ≈ 12


// const STIFFNESS_DEFAULT = 0.6;
// const DAMPING_DEFAULT = 1;



function springTween(line, from, to, opts = {}) {
  let state = { ...from };
  let velocity = { x1: 0, y1: 0, x2: 0, y2: 0 };

  const stiffness = opts.stiffness ?? STIFFNESS_DEFAULT;   // spring strength (per second)
  const damping   = opts.damping   ?? DAMPING_DEFAULT;    // damping (per second)

  const my_thread_id = my_thread.id;
  let lastTime = null;

  function animate(timestamp) {
    if (lastTime === null) lastTime = timestamp;

    const deltaMs = timestamp - lastTime;
    const dt = deltaMs / 500;       // convert to seconds
    lastTime = timestamp;

    let done = true;

    if (my_thread_id === my_thread.id) {
      for (let key in state) {

        // displacement
        const dist = to[key] - state[key];

        // spring force (Hooke's law) scaled by dt
        const springForce = dist * stiffness;

        // damping force scaled by velocity
        const dampingForce = velocity[key] * damping;

        // acceleration
        const accel = springForce - dampingForce;

        // integrate velocity & position
        velocity[key] += accel * dt;
        state[key] += velocity[key] * dt;

        // check if still moving noticeably
        if (Math.abs(dist) > 0.1 || Math.abs(velocity[key]) > 0.01) {
          done = false;
        }
      }
    }

    if (done) {
      applyState(line, to);
    } else {
      applyState(line, state);
      requestAnimationFrame(animate);
    }
  }

  requestAnimationFrame(animate);
}




// <!-- [553, 631], [820, 787], [957, 958], [1157.25, 1129], [1224, 1278] -->
const startState = { x1: 553, y1: 250, x2: 631, y2: 429 };
const endState   = { x1: 820, y1: 250, x2: 787, y2: 429 };

	function recursivelyHandleChildren(child_state_transitions, child, current_click_num) {
		for (const grandchild of child.children) {
			let click_attr = grandchild.getAttribute("click")
			if (click_attr !== null) {
				grandchild.setAttribute("hidden", "");
				const [click, click2] = click_attr.split('-');
				const clicky = (click === "") ? ++current_click_num : parseInt(click) || 1;

				// if (grandchild.id === "change-highlighted-color") {
				// 	console.log({grandchild})
				// }

				if (grandchild.tagName === "line" && clicky && click && click2) {
					//console.log({clicky, click, click2})
					const data1 = [+grandchild.getAttribute("x1"),
										+grandchild.getAttribute("x2"),
										+grandchild.getAttribute("y1"),
										+grandchild.getAttribute("y2"),];

					data1.stiffness = STIFFNESS_DEFAULT;
					data1.damping = DAMPING_DEFAULT;

					const map = new Map([
						[click - 1, data1]
					]);

					for (let i = +click; i <= +click2; i++) {
						const data = grandchild.getAttribute(`click-${i}`)?.split(', ');
						map.set(i, data);
					}

					//console.log({map});
					const thread_incrementers = new Set();

					for (const [i, data] of map.entries()) {
						if (data) {
							const damping = data.damping ?? grandchild.getAttribute("damping") ?? DAMPING_DEFAULT;
							const stiffness = data.stiffness ?? grandchild.getAttribute("stiffness") ?? STIFFNESS_DEFAULT;
							const [x1, x2, y1=250, y2=429-50] = data;
							// console.log({x1, x2,y1,y2});
							thread_incrementers.add(i);

							child_state_transitions[i]?.push(() => {
								springTween(grandchild,
									{
										x1: +grandchild.getAttribute("x1"),
										y1: +grandchild.getAttribute("y1"),
										x2: +grandchild.getAttribute("x2"),
										y2: +grandchild.getAttribute("y2"),
									},
									{
										x1: +x1,
										y1: +y1,
										x2: +x2,
										y2: +y2,
									},
									{ stiffness, damping });
							});
						}
					}

					for (const i of thread_incrementers)
						child_state_transitions[i]?.unshift(() => my_thread.id++)
				}

				const unhide_slide = () => {
					// setTimeout(() => grandchild.removeAttribute("hidden"), 1000);
					grandchild.classList.remove("hide-slide");
					grandchild.classList.add("unhide-slide");
					grandchild.removeAttribute("hidden");
				};


				const hide_slide = () => {
					// console.log("hiding", grandchild);
					grandchild.classList.remove("unhide-slide");
					grandchild.classList.add("hide-slide");
					grandchild.setAttribute("hidden", "");


					// setTimeout(() => {
					// 	console.log({a:+click < +cur_click, b: +cur_click > (+click2 || -Infinity)})
					// 	if (!(+cur_click > (+click2 || -Infinity) || +click < +cur_click))
					// 		grandchild.setAttribute("hidden", "");
					// }, 1000);
				};

				child_state_transitions[clicky].push(unhide_slide);
				child_state_transitions[clicky - 1].push(hide_slide);

				if (click2) {
					child_state_transitions[click2]?.push(hide_slide);
					child_state_transitions[click2 - 1].push(unhide_slide);
				}
			}
			current_click_num = recursivelyHandleChildren(child_state_transitions, grandchild, current_click_num);
		}

		return current_click_num;
	}

	function countClicks(child, state) {
		for (const grandchild of child.children) {
			let click = grandchild.getAttribute("click")
			if (click !== null) {
				grandchild.setAttribute("hidden", "");
				const clicky = (click === "") ? ++state.current_click_num : parseInt(click) || 1;
				if (clicky > state.max_click_num) state.max_click_num = clicky;
			}
			countClicks(grandchild, state);
		}
		return state;
	}

	let IS_MOBILE_FULL_SCREEN = false;

	post_processes.push(() => {
		for (const [is_overlay, elements] of  [[false, slide_elements], [true, overlay_elements]]) {
			for (const [i, child] of elements.entries()) {
				child.setAttribute("hidden", "");
				const id = child.getAttribute("id");
				if (id === null) throw new Error("Please add an ID to slide " + i + ` (after the slide with an id of "${elements[i - 1].id}")`);
				const id_without_overlay = id.replace("-overlay", "");
				const click_attr = child.getAttribute("clicks");
				const num_clicks = is_overlay ? clicks.get(id_without_overlay) : parseInt(click_attr?.split(",").length > 1 ? click_attr.split(",").length + 1 : click_attr) ||
					(1 + countClicks(child, { current_click_num: 0, max_click_num: 0 }).max_click_num);

				clicks.set(id_without_overlay, num_clicks);
				const arr = slidesById.get(id_without_overlay) || [];
				arr.push(child);
				slidesById.set(id_without_overlay, arr);

				const child_state_transitions = is_overlay ? state_transitions.get(id_without_overlay) : new Array(num_clicks).fill(0).map(() => []);
				if (!is_overlay) state_transitions.set(id, child_state_transitions);

				child_state_transitions[0].push(() => {
					child.removeAttribute("hidden")
					if (i > 0) elements[i - 1].setAttribute("hidden", "")
					if (i < elements.length - 1) elements[i + 1].setAttribute("hidden", "")
					if (!is_overlay)
						container.setAttribute("viewBox", `0 0 1920 ${pane_heights.get(id) || 1080}`);
				});

				child_state_transitions[num_clicks - 1].push(() => {
					child.removeAttribute("hidden")
					if (i > 0) elements[i - 1].setAttribute("hidden", "")
					if (i < elements.length - 1) elements[i + 1].setAttribute("hidden", "")
				});

				// if (is_overlay)
				// 	state_transitions.get(id_without_overlay).forEach((a, i) => {
				// 		child_state_transitions.forEach((b, j) => {
				// 			console.log(a);
				// 			a.push(b);
				// 		});
				// 	});

				recursivelyHandleChildren(child_state_transitions, child, 0)
			}
		}
	});

				// 	global_scrolls.push({
				// 	section: slide_id,
				// 	slide_num: i + 1,
				// 	animation_duration,
				// 	pos: next,
				// });

	post_processes.push(() => {
		/**
		 * Create a cubic-bezier easing function.
		 * @param {number} p0x
		 * @param {number} p0y
		 * @param {number} p1x
		 * @param {number} p1y
		 */
		function cubicBezier(p0x, p0y, p1x, p1y) {
		// Helper functions for bezier math
		function cubic(a, b, m) { return ((1 - 3*b + 3*a) * m ** 3) + ((3*b - 6*a) * m ** 2) + (3*a * m); }
		function cubicDerivative(a, b, m) { return (3*(1 - 3*b + 3*a) * m ** 2) + (2*(3*b - 6*a) * m) + (3*a); }

		return function(t) {
			// Newton-Raphson iteration to find the parametric value for time t
			let x = t, i = 0;
			for (; i < 5; i++) {
			const xEstimate = cubic(p0x, p1x, x) - t;
			const dx = cubicDerivative(p0x, p1x, x);
			if (Math.abs(xEstimate) < 1e-6) break;
			x -= xEstimate / dx;
			}
			return cubic(p0y, p1y, x);
		};
		}

		// Your easing curve: cubic-bezier(0.69, 0.02, 0.53, 1)
		const easeCustom = cubicBezier(0.69, 0.02, 0.53, 1);

		/**
		 * Smooth scroll to target using cubic-bezier easing.
		 */
		let active_scroll_id = 0;
		function scrollToPosition(targetY, duration = 500) {
			const startY = window.scrollY;
			const distance = targetY - startY;
			let startTime = null;
			const my_scroll_id = ++active_scroll_id;

			function step(timestamp) {
				if (active_scroll_id !== my_scroll_id) return;
				if (!startTime) startTime = timestamp;
				const elapsed = timestamp - startTime;
				const progress = Math.min(elapsed / duration, 1);

				const easedProgress = easeCustom(progress);

				if (elapsed < duration) {
					window.scrollTo(0, startY + distance * easedProgress);
					requestAnimationFrame(step);
				} else {
					window.scrollTo(0, targetY);
				}
			}

			requestAnimationFrame(step);
		}

		let scroll_id = 0;

		function scrollElementOffsetAnimated(elem, offsetPx, duration = 500, section) {
			if (IS_MOBILE_FULL_SCREEN) return;
			let startTime = 0.0;
			const my_scroll_id = ++scroll_id;

			function step(timestamp) {
				if (cur_slide != section) return;
				if (my_scroll_id !== scroll_id) return;
				if (!startTime) startTime = timestamp;
				const elapsed = timestamp - startTime;
				const rect = elem.getBoundingClientRect();
				window.scrollTo(0, window.scrollY + rect.top - offsetPx);
				if (elapsed < duration) requestAnimationFrame(step);
			}

			requestAnimationFrame(step);
		}


		{
			let i = 0;
			const selectors = new Set();
			const sections = new Set();

			const positions = global_scrolls.map(({ pos }) => 120 - pos * 80 - 55);

			for (const [i, { section, slide_num, animation_duration, selector, pos }] of global_scrolls.entries()) {
				// console.log({ section, slide_num, animation_duration, selector, pos });
				sections.add(section);
				selectors.add(selector);

				// console.log({selector:selector.slice(0, -("-rect".length))});

				global_animations.push({
					section,
					selector: selector.slice(0, -("-rect".length)),
					slide_num,
					animation_duration,
					forward_only: true,
					keyframes: {
						0:    {  transform: `translateY(${positions[i - 1] || 0}px)` },
						100:   { transform: `translateY(${positions[i]}px)` },
					},
					mobile_full_screen_only: true,
				});

				global_animations.push({
					section,
					selector: selector.slice(0, -("-rect".length)),
					slide_num,
					animation_duration: global_scrolls[i+1]?.animation_duration,
					backward_only: true,
					keyframes: {
						0:    {  transform: `translateY(${positions[i + 1] || 0}px)` },
						100:   { transform: `translateY(${positions[i]}px)` },
					},
					mobile_full_screen_only: true,
				});

				state_transitions.get(section)[slide_num].push(() => {
					const elem = document.querySelector(selector);
					const styles = getComputedStyle(elem);

					// console.log("selector", selector);
					// console.log("elem", elem);
					// console.log("styles.animationDuration", styles.animationDuration);

					scrollElementOffsetAnimated(document.querySelector(selector),
						// offset from top
						70,
						1000 * styles.animationDuration.slice(0, -1), section);
				});
			}
			const selectors_arr = [...selectors];
			const sections_arr = [...sections];

			for (let i = 0; i < selectors_arr.length; i++)
				state_transitions.get(sections_arr[i])[0].push(() => {
					scrollElementOffsetAnimated(document.querySelector(selectors_arr[i]),
								// offset from top
								70,
								5000, sections_arr[i]);
				});
		}

		// console.log(global_scrolls);
	})

	const code_info = new Map();

	let code_block_i = 0;

	for (const codeblock of document.getElementsByClassName("code")) {
		let codeblock_id = codeblock.getAttribute("id");
		const x = +codeblock.getAttribute("x");
		const y = +codeblock.getAttribute("y");
		const steps = codeblock.getAttribute("steps");
		const mini_steps = codeblock.getAttribute("mini-steps");
		const lang = codeblock.getAttribute("lang");
		const width = +codeblock.getAttribute("width");
		const click = +codeblock.getAttribute("click");
		if (codeblock.getAttribute("height")) {
			throw new Error("Height is not allowed on code block")
		}
		const line_height = +codeblock.getAttribute("line-height");
		const font_size = codeblock.getAttribute("font-size") || "";
		const letter_spacing = codeblock.getAttribute("letter-spacing") || "";

		const line_num_indent = +codeblock.getAttribute("line-num-indent");
		const hide_line_numbers = codeblock.hasAttribute("hide-line-numbers");

		const line_indent = +codeblock.getAttribute("line-indent");
		let slide = codeblock;
		do slide = slide.parentNode; while (!slide.classList.contains("slide"));
		const slide_id = slide.getAttribute("id");


		const [lines, ranges] = preprocess(slide_id, codeblock.innerHTML, lang);

		if (codeblock_id) {
			code_info.set(codeblock_id, { x, y, width, line_height, line_num_indent, hide_line_numbers, line_indent, slide, ranges });
		} else {
			codeblock_id = `${slide_id}-codeblock-${code_block_i++}`;
			codeblock.setAttribute("id", codeblock_id);
		}

		if (lines.length > 0) {
			let innerHTML = codeblock.hasAttribute("hide-background") ? '' : `<rect x="${x || 0}" y="${y || 0}" height="${y + (line_height*(codeblock.getAttribute("lines") || lines.length)) + 20}" width="${width}" fill="black"></rect>`;
			innerHTML += lines.map((e, i) => `<text class="line-of-code" line-no="${i-1}" x="${x + line_indent}" y="${y + (line_height*(i+1))}">${e}</text>`).join('\n');

			if (!hide_line_numbers)
				innerHTML += lines.map((_, i) => `<text class="line-number" x="${x + line_num_indent}" y="${y + (line_height*(i+1)) - 1}" text-anchor="end">${i + 1}</text>`);

			const extra_height = y + (line_height*(lines.length));
			const [body] = document.getElementsByTagName("body");
			if (extra_height > 1080) {
				pane_heights.set(slide_id, extra_height);

				body.insertAdjacentHTML("beforeend",
					`
					<style>
					#container[slide="${slide_id}"] {
					height: ${extra_height / 10.80}%
					}
					</style>
				`);
			}

			if (font_size || letter_spacing) {
				body.insertAdjacentHTML("beforeend", `
				<style>
				#${codeblock_id} text.line-of-code {
					${font_size && `font-size: ${font_size};`}
					${letter_spacing && `letter-spacing: ${letter_spacing};`}
				}
				</style>
				`);
			}

			codeblock.innerHTML = innerHTML;
		}


		const colors = ["rgb(0, 100, 0)", "purple", "rgb(130, 0, 0)", "rgb(88, 0, 158)", "rgb(0, 0, 200)"];

		if (mini_steps) {
// <svg width="300" height="120" viewBox="0 0 300 120" xmlns="http://www.w3.org/2000/svg">


//   <!-- visible frame for reference -->
//   <rect x="10" y="10" width="200" height="80" fill="none" stroke="#333"/>

//   <!-- anything inside this group will be clipped to the rect above -->
//   <defs>
//     <clipPath id="boxClip" clipPathUnits="userSpaceOnUse">
//       <!-- rectangle that defines the clipping box -->
//       <rect x="10" y="10" width="200" height="80" rx="8"/>
//     </clipPath>
//   </defs>
//   <g clip-path="url(#boxClip)">
//     <!-- content that extends beyond the rect -->
//     <rect x="0" y="0" width="260" height="120" fill="lightblue"/>
//     <text x="20" y="60" font-size="28">This gets clipped →</text>
//   </g>
// </svg>

			codeblock.innerHTML = `
			<defs>
			  <clipPath id="${codeblock_id}-clipper" clipPathUnits="userSpaceOnUse">
			    <rect x="${x}" y="${y}" width="${1920-x}" height="${1250}"/>
			  </clipPath>
			</defs>
			<g clip-path="url(#${codeblock_id}-clipper)">
			<g id="${codeblock_id}-translator">
			<rect id="${codeblock_id}-box" width="700"></rect>
			${codeblock.innerHTML}
			</g>
			</g>`;

			let last_translation = 0;
			let last_height = 0;
			let last_x = x + 40;
			let last_y = y;

			const mini_step_data = mini_steps.split(',').map((str, i) => {
				let [line, len] = str.split(':');
				len = i && +(len || 1);
				line = +line;

				return {
					prev_y: last_translation,
					y: last_translation = -line_height * Math.max(0, line - 4) - 10,
					prev_height: last_height,
					height: last_height = line_height * len,

					prev_box_y: last_y,
					box_y: last_y = y + line_height * (line + 1) + 10,

					prev_color: colors[(click + i + 4) % colors.length],
					color: colors[(click + i + 5) % colors.length],
				};
			});

			mini_step_data.push({
				prev_y: y,
				y: y,
				prev_height: 0,
				height: 0,

				prev_box_y: y,
				box_y: y,

				prev_color: colors[(click + mini_step_data.length + 0) % colors.length],
				color: colors[(click + mini_step_data.length + 1) % colors.length],
			});

			Array.prototype.push.apply(global_animations, mini_steps.split(',').map((str, i) => {
				let [line, len] = str.split(':');
				len = +len || 0;
				line = +line;

				const current_step = mini_step_data[i];
				const next_step = mini_step_data[i + 1];
				const animation_duration = i !== 0 ? "0.25s" : "2s";

				return [{
					section: slide_id,
					selector: `#${codeblock_id}-translator`,
					slide_num: click + i,
					forward_only: true,
					skip_auto_prev_state: true,
					animation_delay: i ? "0s" : "1s",
					animation_duration: i !== 0 ? "0.25s" : "2s",
					keyframes: {
						0:   { transform: `translateY(${current_step.prev_y}px)` },
						100: { transform: `translateY(${current_step.y}px)` },
					}
				}, {
					section: slide_id,
					selector: `#${codeblock_id}-box`,
					slide_num: click + i,
					forward_only: true,
					skip_auto_prev_state: true,
					animation_delay: i ? "0s" : "1s",
					animation_duration: i !== 0 ? "0.25s" : "2s",
					keyframes: {
						0:   { height: `${current_step.prev_height}px`, fill: current_step.prev_color, x: last_x, y: current_step.prev_box_y },
						100: { height: `${current_step.height}px`, fill: current_step.color, x: last_x, y: current_step.box_y },
					}
				}, {
					section: slide_id,
					selector: `#${codeblock_id}-translator`,
					slide_num: click + i,
					backward_only: true,
					skip_auto_prev_state: true,
					animation_duration: "0.25s",
					keyframes: {
						0:   { transform: `translateY(${next_step.y}px)` },
						100: { transform: `translateY(${current_step.y}px)` },
					}
				}, {
					section: slide_id,
					selector: `#${codeblock_id}-box`,
					slide_num: click + i,
					backward_only: true,
					skip_auto_prev_state: true,
					animation_duration: "0.25s",
					keyframes: {
						0:   { height: `${next_step.height}px`, fill: next_step.color, x: last_x, y: next_step.box_y },
						100: { height: `${current_step.height}px`, fill: current_step.color, x: last_x, y: current_step.box_y },
					}
				}];
			}).flat());

		}

		if (steps) {
			codeblock.insertAdjacentHTML("afterbegin", `<rect id="${codeblock_id}-rect" width="1950" fill="purple" style="opacity: 0.6"></rect>`)
			let last = 0;
			let last_height = "0px";
			let last_y = "0px";
			Array.prototype.push.apply(global_animations, steps.split(",").map((av, i, k) => {
				const isLast = k.length === i + 1;
				let [v, num_lines] = av.split(":");
				num_lines ||= '1';
				const prev = last;

				// (8 - num_lines)
				// 2076

				const next = last = Math.min(0, (-v + Math.max(2, 3 - num_lines)) * line_height) - 9;
				let anim_duration = Math.max(0.2, Math.abs(next - prev) / (10000));
				if (anim_duration > 1) {
					anim_duration = 2;
				}
				const animation_duration = `${(i === 0 ? 1/0.9 : 1.25) * anim_duration}s`;
				// console.log({ prev, next, animation_duration });
				// console.log([v, y + (line_height*(v - 1)) + 10]);

				const prev_height = last_height;
				const next_height = last_height = `${line_height*(num_lines || 1) + line_height / 7}px`;

				const prev_y = last_y;
				const next_y_num = y + (line_height*(v - 1)) + line_height / 7;
				const next_y = last_y = `${next_y_num}px`;

				global_scrolls.push({
					section: slide_id,
					slide_num: i + 1,
					animation_duration,
					linear: true,
					pos: +v,
					selector: `#${codeblock_id}-rect`,
				});

				// console.log({codeblock_id,v,animation_duration,prev_height, prev_y, next_height, next_y})


				return [

				// {
				// 	section: slide_id,
				// 	selector: "#" + codeblock_id,
				// 	slide_num: i + 1,
				// 	forward_only: true,
				// 	skip_auto_prev_state: true,
				// 	animation_duration,
				// 	keyframes: {
				// 		0:   { transform: `translateY(${prev}px)` },
				// 		100: { transform: `translateY(${next}px)` },
				// 	}
				// }, {
				// 	section: slide_id,
				// 	selector: "#" + codeblock_id,
				// 	slide_num: i,
				// 	backward_only: true,
				// 	skip_auto_prev_state: true,
				// 	animation_duration,
				// 	keyframes: {
				// 		0:   { transform: `translateY(${next}px)` },
				// 		100: { transform: `translateY(${prev}px)` },
				// 	}
				// },
				{
					section: slide_id,
					selector: `#${codeblock_id}-rect`,
					slide_num: i + 1,
					forward_only: true,
					skip_auto_prev_state: true,
					animation_duration,
					keyframes: {
						0:   { height: prev_height, y: prev_y, fill: colors[(click + i + 0) % colors.length] },
						90: i === 0 ? { y: next_y, height: 0 } : undefined,
						100: { height: next_height, y: next_y, fill: colors[(i + 1) % colors.length] },
					}
				}, {
					section: slide_id,
					selector: `#${codeblock_id}-rect`,
					slide_num: i,
					backward_only: true,
					skip_auto_prev_state: true,
					animation_duration,
					keyframes: {
						0:   { height: next_height, y: next_y, fill: colors[(click + i + 1) % colors.length] },
						10: i === 0 ? { height: 0 } : undefined,
						100: { height: prev_height, y: prev_y, fill: colors[(click + i + 0) % colors.length] },
					}
				}, isLast && {
					section: slide_id,
					selector: `#${codeblock_id}-rect`,
					slide_num: i + 1,
					backward_only: true,
					skip_auto_prev_state: true,
					animation_duration,
					keyframes: {
						0:   { height: next_height, y: next_y },
						90: i === 0 ? { y: next_y, height: 0 } : undefined,
						100: { height: next_height, y: next_y },
					}
				},
				// isLast && {
				// 	section: slide_id,
				// 	selector: "#" + codeblock_id,
				// 	slide_num: i + 1,
				// 	backward_only: true,
				// 	skip_auto_prev_state: true,
				// 	animation_duration,
				// 	keyframes: {
				// 		0:   { transform: `translateY(${next}px)` },
				// 		100: { transform: `translateY(${next}px)` },
				// 	}
				// }
			];
			}).flat())
		}
	}

	for (const text of [...document.getElementsByTagName("text")]) {
		const align = text.getAttribute("align");
		if (align) {
			const line = +text.getAttribute("line");
			const info = code_info.get(align);

			text.setAttribute("x", info.x + info.line_indent);
			text.setAttribute("y", info.y + (info.line_height*(line+1)));

			for (const cl of ["label", "small-label", "xsmall-label", "ysmall-label", "big-label"]) {
				const label = text.getAttribute(cl);

				if (label) {
					const click = text.getAttribute("click");
					text.insertAdjacentHTML("beforebegin", `<text id="${text.getAttribute("id")}-label" class="${cl}" ${click ? `click=${click}` : ""} text-anchor="end" x="${info.x + info.line_indent}" y="${info.y + (info.line_height*(line+1))}">${label.replaceAll(">>", "»").replaceAll("<<", "«")}${label.length === 1 ? '' : `:`}&nbsp;</text>`)
				}
			}
		}
	}

	for (const bits of document.getElementsByClassName("bits-auto-color")) {
		bits.innerHTML = bits.innerHTML.replaceAll(/1+/g, e => `<tspan class="bit-1">${e}</tspan>`);
	}

	// const indexToChar = new Array(64).fill('').map((_, i) => i < 62 ? i < 36 ? i.toString(36) : (i - 26).toString(36).toUpperCase() : '&$'[i - 62]);


	for (const bits of document.getElementsByClassName("bits-match-color")) {
		const align = bits.getAttribute("align");
		if (!align) throw new Error("bits-match-color must use the 'align' property to be paired up with something!")
		const info = code_info.get(align);
		// console.log(bits.innerHTML);
		bits.innerHTML = processRanges(info.ranges, bits.innerHTML).join('\n');
	}

	{
		let i = 0;
		for (const bits of document.getElementsByClassName("bits-match-color2")) {
			const align = bits.getAttribute("align");
			if (!align) throw new Error("bits-match-color2 must use the 'align' property to be paired up with something!")
			const info = code_info.get(align);

			const [smally] = bits.getElementsByClassName("bits-small")

			for (const [kind, bottom, top] of info.ranges) {
				if (bottom <= i && i < top) {
					smally.classList.add("code-" + kind);
					break;
				}
			}
			// bits.innerHTML = processRanges(info.ranges, bits.innerHTML).join('\n');
			i++;
		}
	}

	for (const post_process of post_processes) post_process();

	const all_styles = new Map();

{
	let i = 0;
	let styles = new Array();
	let prev_selector;
	let prev_slide_num;
	let prev_section;
	let prev_mobile_full_screen_only;
	const animations = new Array();

	function getSelectorForInternal(ge, num_clicks) {
		if (ge === num_clicks) throw new Error("num_clicks must be higher than the target click (clicks start at 0)")
		let arr = [];
		let y = ge;
		for (; y % 10; y++) {
			if (y >= num_clicks) return arr;
			arr.push(`[click="${y}"]`);
		}

		let z = y;
		let i = -1;
		for (; z % 100; z += 10) {
			if (z >= num_clicks) return arr;
			if (z / 10 === ge) {
				for (; z % 100; z += 10) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 10}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			arr.push(`[click^="${z / 10}"]:not([click="${z / 10}"])`);
		}

		let q = z;
		i = -1;
		for (; z % 1000; z += 100) {
			if (z >= num_clicks) return arr;
			// console.log(z, ge)
			if (z / 100 === ge) {
				for (; z % 1000; z += 100) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 100}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			for (let j = 0; j < 10; j++) {
				const k = z / 10 + j;

				arr.push(`[click^="${k}"]${ge <= k && k < num_clicks ? '' : `:not([click="${k}"])`}`);
			}
		}

		return arr;
	}

	function getSelectorFor(ge, num_clicks) {
		return `:is(${getSelectorForInternal(+ge, +num_clicks).join(", ")})`;
	}

	function getSelectorForRangeInternal(num_clicks, ge, lt) {
		if (ge === num_clicks) throw new Error("num_clicks must be higher than the target click (clicks start at 0)")
		let arr = [];
		let y = ge;
		for (; y % 10; y++) {
			if (y >= num_clicks) return arr;
			arr.push(`[click="${y}"]`);
		}

		let z = y;
		let i = -1;
		for (; z % 100; z += 10) {
			if (z >= num_clicks) return arr;
			if (z / 10 === ge) {
				for (; z % 100; z += 10) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 10}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			arr.push(`[click^="${z / 10}"]:not([click="${z / 10}"])`);
		}

		let q = z;
		i = -1;
		for (; z % 1000; z += 100) {
			if (z >= num_clicks) return arr;
			// console.log(z, ge)
			if (z / 100 === ge) {
				for (; z % 1000; z += 100) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 100}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			for (let j = 0; j < 10; j++) {
				const k = z / 10 + j;

				arr.push(`[click^="${k}"]${ge <= k && k < num_clicks ? '' : `:not([click="${k}"])`}`);
			}
		}

		return arr;
	}

	function getSelectorForRange(num_clicks, ge, lt) {
		return `:is(${getSelectorForRangeInternal(+num_clicks, +ge, +lt).join(", ")})`;
	}

	// console.log(getSelectorFor('5', '23'));
	// console.log(getSelectorFor('23', '33'));
	// console.log(getSelectorFor('20', '30'));

	const elements_to_selectors = new Map();
	const selectors_to_keyframes = new Map();

	for (const { section = (() => { throw "Invalid section" })(), selector, slide_num, keyframes } of global_animations.filter(e => e)) {
		const start_keyframe = keyframes[0];
		const end_keyframe = keyframes[100];

		for (const [, individual_selector] of selector.matchAll(/([^,]+?)(?:, ?|$)/g)) {
			for (const element of document.querySelectorAll(individual_selector)) {
				const old = elements_to_selectors.get(element);
				if (old && old !== individual_selector) {
					throw new Error("Cannot make an object peacefully coexist in two different classes/ids. Please use id's instead. Conflict between `" + individual_selector + "` and `" + old + "`");
				} else {
					elements_to_selectors.set(element, individual_selector);
				}
			}

			let arr = selectors_to_keyframes.get(individual_selector);
			if (arr === undefined) {
				arr = new Array();
				selectors_to_keyframes.set(individual_selector, arr);
			}
			arr.push({ slide_num, start_keyframe, end_keyframe });
		}
	}

	for (const [i, v] of selectors_to_keyframes.entries()) {
		let prev_slide_num = 0;

		for (const { slide_num, start_keyframe, end_keyframe } of v.sort((a, b) => a.slide_num - b.slide_num)) {
			// prev_slide_num, slide_num, new Array(slide_num - prev_slide_num).fill().map((_, i) => i + prev_slide_num);
			// console.log(slide_num, prev_slide_num);
			prev_slide_num = slide_num;
		}
	}

	//
	for (const { section, selector, slide_num, keyframes, animation_delay = '0s', animation_duration = '0s', skip_auto_prev_state = section === prev_section && selector === prev_selector, forward_only = false, backward_only = false, ease = false, linear = false, continuous = false, mobile_full_screen_only = false } of global_animations.filter(e => e)) {
		if (section !== (prev_section ?? section)) {
			all_styles.set(prev_section, styles.join("\n"));
			styles = [all_styles.get(section) ?? ""] ?? new Array();
		}
		i += 1;
		const old_styles_len = styles.length;
		const keyframe_entries = Object.entries(keyframes).filter(e => e[1] !== undefined).map(([a, b]) => [+a, b]).sort((a, b) => a[0] - b[0]);
		if (keyframe_entries[0]?.[0] !== 0) throw "Missing keyframe 0";
		if (keyframe_entries[keyframe_entries.length - 1]?.[0] !== 100) throw "Missing keyframe 100";

		if (selector !== prev_selector || slide_num !== prev_slide_num || mobile_full_screen_only !== prev_mobile_full_screen_only) {
			animations.length = 0;
		}

		const animation = `animation${i} ${animation_duration} ${linear ? "linear" : ease === true ? "ease" : ease || "cubic-bezier(0.69, 0.02, 0.53, 1)"} ${animation_delay} 1 forwards normal`;
		animations.push(animation)

		const mobile_only = mobile_full_screen_only ? "#container[mobile-translate] " : ""
		let selectors = selector.split(',');

		if (!skip_auto_prev_state) {
			styles.push(`${mobile_only}.slide#${section} ${selector} {
		${Object.entries(keyframe_entries[0][1]).map(([a, b]) => `${a}: ${b};`).join("\n\t")}
	}`);
		}


		// if (selector.startsWith('.')) {
		// 	Array.prototype.push.apply(selectors, [...document.querySelectorAll(selector)].filter(x => x.id).map(x => `${selector}#${x.id}`));
		// }

		styles.push(`${selectors.map(selector => `${mobile_only}.slide#${section}[${continuous ? 'fragment-' : 'click="'}${slide_num}${continuous ? '' : '"'}]${forward_only ? "[present-went-forward]" : backward_only ? "[present-went-backward]" : ""} ${selector}`).join(',\n')} {
		animation: ${animations.join(",\n\t")};
	}`);

		if (!continuous) styles.push(`${selectors.map(selector => `${mobile_only}.slide#${section}[fragment-${slide_num + 1}] ${selector}`).join(',\n')} {
		${Object.entries(keyframe_entries[keyframe_entries.length - 1][1]).map(([a, b]) => `${a}: ${b};`).join("\n\t")}
	}`);

	// 	if (forward_only) styles.push(`${`${selectors.map(selector => `.slide#${section}[click="${slide_num}"][present-went-backward] ${selector}`).join(',\n')} {
	// 	${Object.entries(keyframe_entries[keyframe_entries.length - 1][1]).map(([a, b]) => `${a}: ${b};`).join("\n\t")}
	// }`}`);

		styles.push(`@keyframes animation${i} {
		${keyframe_entries.map(([a, b]) => `${a}% { ${Object.entries(b).map(([a, b]) => `${a}: ${b};`).join(" ")} }`).join("\n\t")}
	}`);

		if (mobile_full_screen_only) {
			// for (let n = old_styles_len; n < styles.length; n++)
				// console.log(styles[n]);
			// console.log(styles[styles.length - 1]);
		}

		prev_selector = selector;
		prev_slide_num = slide_num;
		prev_section = section;
		prev_mobile_full_screen_only = mobile_full_screen_only;
	}

	all_styles.set(prev_section, styles.join("\n"));

	var styleSheet = document.createElement("style");
	styleSheet.id = "slide-animations";
	styleSheet.innerHTML = [...all_styles.values()].join('\n');
	document.head.appendChild(styleSheet);
}

	const getStateFromURL = () => {
		const slide_arg = window.location.href.split("#").pop();
		const [slide_title, clicks_amt] = slide_arg.split("?");
		let cur_slide = slide_title || slide_elements[0].id;
		if (!clicks.has(cur_slide)) [[cur_slide]] = clicks;

		return [
			cur_slide,
			(clicks_amt || "").startsWith("click=")
			? Math.min(clicks.get(cur_slide) - 1, parseInt(clicks_amt.slice("click=".length)) || 0)
			: 0
		];
	}

	let [cur_slide, cur_click] = getStateFromURL();

	const updateURL = () => window.location.href = "#" + cur_slide + (cur_click === 0 ? '' : `?click=${cur_click}`);

	const updateContainerSlideAttribute = () => {
		container.setAttribute("slide", cur_slide);
		overlay.setAttribute("slide", cur_slide + "-overlay");
	}


	// window.onhashchange = function() {
	// 	const targetState = getSlideFromURL();
	// 	setState(targetState)
	// };

	function applyTransitions() {
		for (const cur_slide_element of slidesById.get(cur_slide)) {
			cur_slide_element.setAttribute("click", "" + cur_click);
			for (let i = 0; i <= cur_click; i++) cur_slide_element.setAttribute(`fragment-${i}`, "");
			const max_clicks = clicks.get(cur_slide);
			for (let i = cur_click; ++i < max_clicks; ) cur_slide_element.removeAttribute(`fragment-${i}`);
		}

		for (const state_transition of state_transitions.get(cur_slide)[cur_click]) {
			state_transition();
		}
	}

	function applyStateTransitionsUpToCurrentClickInSlide() {
		for (let i = 0; i <= cur_click; i++) {
			for (const state_transition of state_transitions.get(cur_slide)[i]) {
				state_transition();
			}
		}
	}

	function nextSlide() {
		let next_slide;
		let wasPreviousCurrentSlide = false;
		for (const [slide] of clicks) {
			if (wasPreviousCurrentSlide) {
				next_slide = slide;
				break;
			}
			wasPreviousCurrentSlide = cur_slide === slide;
		}
		if (!next_slide) return false;
		for (const cur_slide_element of slidesById.get(cur_slide)) {
			for (let i = 0; i < cur_click; i++) {
				cur_slide_element.removeAttribute(`fragment-${i}`);
			}
			cur_slide_element.removeAttribute("click");
			cur_click = 0;
		}

		cur_slide = next_slide;
		updateContainerSlideAttribute();
		return true;
	}

	function goForward() {
		const old_slide = cur_slide;
		const max_click = clicks.get(cur_slide) - 1;
		cur_click++;
		let is_new_slide = true;
		if (cur_click > max_click) {
			is_new_slide = nextSlide();
			if (!is_new_slide)
				cur_click--;
		}
		for (const old_slide_element of slidesById.get(old_slide)) {
			old_slide_element.removeAttribute("present-went-backward");
			if (old_slide !== cur_slide) old_slide_element.removeAttribute("present-went-forward");
		}
		for (const cur_slide_element of slidesById.get(cur_slide)) cur_slide_element.setAttribute("present-went-forward", "");
		if (is_new_slide) {
			applyTransitions();
			updateURL();
		}
	}

	function prevSlide() {
		for (const slide of slidesById.get(cur_slide)) {
			slide.removeAttribute("click");
			slide.removeAttribute("fragment-0");
		}
		let [[previous_slide]] = clicks
		for (const [slide] of clicks) {
			if (cur_slide === slide) break;
			previous_slide = slide;
		}
		cur_slide = previous_slide;
		cur_click = clicks.get(cur_slide) - 1;
		applyStateTransitionsUpToCurrentClickInSlide();
		updateContainerSlideAttribute();
	}

	function goBackward() {
		const old_slide = cur_slide;

		if (cur_click === 0) {
			prevSlide();
		} else {
			cur_click--;
		}

		for (const old_slide_element of slidesById.get(old_slide)) {
			old_slide_element.removeAttribute("present-went-forward");
			if (old_slide !== cur_slide) old_slide_element.removeAttribute("present-went-backward");
		}
		for (const slide of slidesById.get(cur_slide)) slide.setAttribute("present-went-backward", "");

		applyTransitions();
		updateURL();
	}

	let is_control_depressed = false;

	window.addEventListener("touchend", () => {
		document.body.requestFullscreen({ navigationUI: "hide" })
		.then(() => {
			IS_MOBILE_FULL_SCREEN = true;
			container.setAttribute("mobile-translate", "");
		})
		.catch(err => {
			console.error("Fullscreen request failed:", err);
		});
	});
	// window.addEventListener("touchstart", () => void (document.querySelector("body").requestFullscreen({ navigationUI: "hide" })));
	window.addEventListener("keyup", function (event) {
		// Do nothing if the event was already processed
		if (event.defaultPrevented) return;
		switch (event.key) {
		case "Control":
			is_control_depressed = false;
			break;
		default:
			return; // Quit when this doesn't handle the key event.
		}
	});

	window.addEventListener("keydown", function (event) {
		// Do nothing if the event was already processed
		if (event.defaultPrevented) return;

		switch (event.key) {
		case "ArrowLeft":
			goBackward();
			break;
		case "ArrowRight":
			goForward();
			break;
		case "Control":
			is_control_depressed = true;
			break;
		case 'c':
			if (is_control_depressed) {
				navigator.clipboard.writeText(code_snippets.get(cur_slide));
			}
		default:
			return; // Quit when this doesn't handle the key event.
		}

		// Cancel the default action to avoid it being handled twice
		event.preventDefault();
	}, true);

	applyTransitions();
	updateURL();
	applyStateTransitionsUpToCurrentClickInSlide();
	updateContainerSlideAttribute();
	for (const slide of slidesById.get(cur_slide)) slide.setAttribute("present-went-forward", "");
</script>


<script>
function subtractBinary(a, b) {
    // Convert binary strings to integers
    const intA = BigInt(`0b${[...a.replaceAll('.', '0')].reverse().join('')}`);
    const intB = BigInt(`0b${[...b.replaceAll('.', '0')].reverse().join('')}`);

    // Subtract
    let result = intA - intB;
	const flip_around = result < 0n;

    // If negative, handle appropriately
    if (flip_around) {
        result = ~result;
    }

	let str = result.toString(2).padStart(64, '0');

	if (flip_around) {
        str = str.replaceAll(/[01]/g, e => ['1', '0'][+e]);
    }

    // Convert back to binary string
    return [...str.replaceAll('0', '.')].reverse().join('');
}

function opBinary(a, b, op) {
    // Convert binary strings to integers
    const intA = BigInt(`0b${[...a.replaceAll('.', '0')].reverse().join('')}`);
    const intB = BigInt(`0b${[...b.replaceAll('.', '0')].reverse().join('')}`);

    // Subtract

    let result = undefined;

	switch (op) {
		case '-': result = intA - intB; break;
		case '^': result = intA ^ intB; break;
		case '&': result = intA & intB; break;
		case '&~': result = intA & ~intB; break;
		case '|': result = intA | intB; break;
	}

	const flip_around = result < 0n;

    // If negative, handle appropriately
    if (flip_around) {
        result = ~result;
    }

	let str = result.toString(2).padStart(64, '0');

	if (flip_around) {
        str = str.replaceAll(/[01]/g, e => ['1', '0'][+e]);
    }

    // Convert back to binary string
    return [...str.replaceAll('0', '.')].reverse().join('');
}

// Example:
const even_series = opBinary(
	"0111.111.1..1111.1.11111.11111.111111111.11111.1111.1111111111.1",
	"11..111....111....1111...1111..111.1111.11111.1111.1111111.11.11", '-');

const esc_and_term = opBinary(even_series, '.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1', '^');
const escaped = opBinary(esc_and_term, "11..111....111....1111...1111..111.1111.11111.1111.1111111.11.11", "^");
// console.log(even_series);
// console.log(esc_and_term);
// console.log(escaped);

// console.log(opBinary(
// 	"1....1.....1...11...1.1..1.......11............11............1..",
// 	"1...............1.................1..............1..............", "-"));

// const starts_and_quote_bounds = opBinary("...............1.................1..............1...............", opBinary("1..........1....1.....1........................1................", opBinary("...............1.................1..............1...............",
// opBinary("1...............1.................1..........................1.." & "1..........1....1.....1........................1................", "&"), '-'), '&'), '|');

const starts = "1...............1.................1..........................1..";
const quote_bounds_incl_carry = "1..........1....1.....1........................1................";
const starts_and_quote_bounds = opBinary(starts, quote_bounds_incl_carry, '&');
const carriages_or_newlines_or_eof = "...............1.................1..............1...............";
const subbed = opBinary(carriages_or_newlines_or_eof, starts_and_quote_bounds, '-');
const imm = opBinary(quote_bounds_incl_carry, subbed, '&');
let imm2 = opBinary(carriages_or_newlines_or_eof, imm, '|');
imm2 = opBinary(imm2, starts, '&~');

const cur_ends = opBinary(imm2, opBinary(imm2, starts, '-'), '&~');


// console.log({cur_ends});

</script>

<style>
	.bits-small {
		font-size: 25px;
		letter-spacing: -2px;
		text-align: center;
	}
</style>

</body>
</html>
