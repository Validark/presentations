<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="utf-8">
	<title>HHID Cache in Zig</title>

	<link rel="stylesheet" type="text/css" href="./fonts/Iosevka/Iosevka.css">

	<style>
		[hidden] {
		  display: none;
		}

		g.slide:not([hidden]) > .h2:first-child:not(.code),
		g.slide:not([hidden]) > [click]:not([hidden]):not(.no-slide-in):not(.no-slide-in2):not(.code),
		g.slide:not([hidden]) > [click]:not([hidden]):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > [click]:not([hidden]):not(.code) tspan:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg):not(.code) tspan:not(.highlighted):not(.highlighted-blue),

		g.slide:not([hidden]) > g:not(.no-slide-in) > .h2:first-child:not(.code),
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]):not(.no-slide-in):not(.no-slide-in2):not(.code),
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]):not(.code) tspan:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg):not(.code) text:not(.highlighted):not(.highlighted-blue),
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg):not(.code) tspan:not(.highlighted):not(.highlighted-blue)
		{
			animation: unhide 1s cubic-bezier(0, 0, 0.53, 1) 0s 1 forwards;
		}


		g.slide:not([hidden]) > [click]:not([hidden]) text.highlighted,
		g.slide:not([hidden]) > [click]:not([hidden]) tspan.highlighted,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) text.highlighted,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) tspan.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) text.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) tspan.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) text.highlighted,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) tspan.highlighted
		{
			animation: unhide-highlighted 1s cubic-bezier(0, 0, 0.53, 1) 0s 1 forwards;
		}

		g.slide:not([hidden]) > [click]:not([hidden]) text.highlighted-blue,
		g.slide:not([hidden]) > [click]:not([hidden]) tspan.highlighted-blue,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) text.highlighted-blue,
		g.slide:not([hidden]) > :first-child:not([hidden]):not(svg) tspan.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) text.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > [click]:not([hidden]) tspan.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) text.highlighted-blue,
		g.slide:not([hidden]) > g:not(.no-slide-in) > :first-child:not([hidden]):not(svg) tspan.highlighted-blue,
		g.slide > g > text > tspan > tspan.highlighted-blue
		{
			animation: unhide-highlighted-blue 1s cubic-bezier(0, 0, 0.53, 1) 0s 1 forwards;
		}

		g.slide:not([hidden]) {
			animation: unhide-slide 1s ease 0s 1 forwards;
		}

		.unhide-slide:not(.no-slide-in):not(.no-slide-in2) {
			animation: unhide-slide 1s ease 0s 1 forwards;
		}

		.unhide-slide.no-slide-in {
			animation: no-unhide-slide 1s ease 0s 1 forwards;
		}

		.unhide-slide.no-slide-in2 {
			animation: no-unhide-slide2 1s ease 0s 1 forwards;
		}

		.hide-slide {
			animation: hide-slide 1s ease 0s 1 forwards;
		}


		@keyframes unhide {
			0%   { transform: translateY(-60px); stroke: rgba(255, 255, 255, 1); stroke-width: 5px; }
			100% { transform: translateY(0); stroke: rgba(255, 255, 255, 0) }
		}

		@keyframes unhide-highlighted {
			0%   { transform: translateY(-60px); stroke: rgba(255, 255, 255, 1); stroke-width: 5px; }
			100% { transform: translateY(0); stroke: rgba(0, 255, 255, 1); stroke-width: 2px; }
		}

		@keyframes unhide-highlighted-blue {
			0%   { transform: translateY(-60px); stroke: rgba(255, 255, 255, 1); stroke-width: 5px; }
			100% { transform: translateY(0); stroke: rgb(255, 177, 100); stroke-width: 2px; }
		}

		@keyframes unhide-slide {
			from   { transform: translateY(-60px); }
		}

		@keyframes no-unhide-slide {
			from   { transform: translateY(60px); }
		}

		@keyframes no-unhide-slide2 {
			/* from   { transform: translate(150px, -550px) rotate(45deg); } */
		}

		@keyframes hide-slide {
			to   { transform: translateY(-60px); opacity: 0; }
		}

		g.slide#title {
			animation: unhide-svg 10s cubic-bezier(0, 1, 0, 1) 0s 1 forwards !important;
		}

		@keyframes unhide-svg {
			0%   { transform: scale(0) translate(1100px, 1600px); }
			100% { transform: scale(1) translate(0, 0); }
		}

		@font-face {
			font-family: 'Press Start 2P';
			src: url('./fonts/Press_Start_2P/PressStart2P-Regular.ttf') format('truetype');
			font-weight: 400;
			font-style: normal;
			font-display: block;
		}

		@font-face {
			font-family: 'Ysabeau Office';
			src: url('./fonts/Ysabeau_Office/static/YsabeauOffice-Regular.ttf') format('truetype');
			font-weight: 400;
			font-style: normal;
			font-display: block;
		}

		@font-face {
			font-family: 'Ysabeau Office';
			src: url('./fonts/Ysabeau_Office/static/YsabeauOffice-Medium.ttf') format('truetype');
			font-weight: 500;
			font-style: normal;
			font-display: block;
		}

		* {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
		}

		html, body, #container, #overlay {
			height: 100%;
			width: 100%;
			font-size: 12pt
		}

		.h1, .h2, .h3, .h4 {
			font-family: "Press Start 2P";
			color: hsl(265, 89%, 78%);
			text-align: center;
			line-height: 1.25;
		}

		.h2, .h3, .h4 {
			fill: hsl(265, 89%, 78%);
		}

		h1, .h1 {
			font-size: 8rem;
		}

		h2, .h2 {
			font-size: 4.25rem;
		}

		.h3 {
			font-size: 2.75rem;
		}

		.h4 {
			font-size: 2rem;
		}

		#container, #overlay {
			height: 100%;
			width: 100%;
			position: absolute;
			background-color: #000
			/* animation: container-background 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0s 1 forwards; */
		}

		#overlay {
			position: fixed;
			background: none;
		}

		@keyframes container-background {
			0% { background-color: hsl(231, 15%, 18%) }
			100%   { background-color: #000 }
		}

		/* .slide {
			padding-top: 1in;
			padding-bottom: 1in;
			padding-left: 1in;
			padding-right: 1in;
		} */

		ol, ul, p, pre {
			font-size: 2.5rem;
			color: #F8F8F2;
			font-family: "Press Start 2P";
			line-height: 1.25;
			letter-spacing: -2px;
		}

		ol, ul, p {
			margin-left: 4rem;
		}

		.slide > p,
		.slide > ul,
		.slide > ol {
			margin-top: 1rem;
		}

		ol ol {
			list-style-type: lower-alpha;
		}

		a {
			color:aqua
		}
	</style>

	<script>
	    const global_animations = [];
		const global_scrolls = [];
		const state_transitions = new Map();
		const post_processes = [];
	</script>
</head>

<body style="padding-bottom: 0px; padding-right: 0px">

<svg id="container" viewBox="0 0 1920 1080" version="1.1" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMin meet">
	<g class="slide" id="title">
		<text class="h1 title-line" x="965" y="325" fill="#F7A41D" text-anchor="middle">HHIDv2</text>
		<!-- <text class="h1 title-line" x="965" y="575" fill="#F7A41D" text-anchor="middle">HHID Cache</text> -->

		<g class="title-line">
			<text class="h1" x="965" y="575" fill="#F7A41D" text-anchor="middle">in &nbsp;&nbsp;&nbsp;</text>

			<svg id="zig-logo" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="-1 0 154 140" height="280" width="280" x="965" y="350">
				<g fill="#F7A41D">
					<g id="logo-left-side">
						<polygon points="46,22 28,44 19,30"></polygon>
						<polygon points="46,22 33,33 28,44 22,44 22,95 31,95 20,100 12,117 0,117 0,22" shape-rendering="crispEdges"></polygon>
						<polygon points="31,95 12,117 4,106"></polygon>
					</g>
					<g id="logo-middle">
						<polygon points="56,22 62,36 37,44"></polygon>
						<polygon points="56,22 111,22 111,44 37,44 56,32" shape-rendering="crispEdges"></polygon>
						<polygon points="116,95 97,117 90,104"></polygon>
						<polygon points="116,95 100,104 97,117 42,117 42,95" shape-rendering="crispEdges"></polygon>
						<polygon points="150,0 52,117 3,140 101,22"></polygon>
					</g>
					<g id="logo-right-side">
						<polygon points="141,22 140,40 122,45"></polygon>
						<polygon points="153,22 153,117 106,117 120,105 125,95 131,95 131,45 122,45 132,36 141,22" shape-rendering="crispEdges"></polygon>
						<polygon points="125,95 130,110 106,117"></polygon>
					</g>
				</g>
			</svg>
		</g>


		<text class="h2" id="by-line-1" x="960" y="775" text-anchor="middle">by Niles Salter</text>
		<text class="h2" id="by-line-2" x="960" y="875" text-anchor="middle"><tspan style="stroke: rgb(0, 255, 255); stroke-width: 2px">https://validark.dev</tspan></text>

		<script>
			global_animations.push({
				section: "title",
				selector: ".title-line, #zig-logo",
				slide_num: 0,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { "letter-spacing": "-1em", opacity: 0, transform: "scale(0.25) translate(140rem, 50rem)", "font-size": "1rem" },
					30:  { opacity: 1, "font-size": "8rem" },
					100: { "letter-spacing": 0, opacity: 1, transform: "scale(1) translate(0, 0)", "font-size": "8rem" },
				}
			}, {
				section: "title",
				selector: ".title-line > text",
				slide_num: 0,
				animation_duration: "3s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { "letter-spacing": "-1em" },
					100: { "letter-spacing": 0 },
				}
			}, {
				section: "title",
				selector: "#by-line-1, #by-line-2",
				slide_num: 0,
				animation_delay: "2s",
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { "letter-spacing": "-1em", opacity: 0 },
					25:  { opacity: 1 },
					100: { "letter-spacing": "-7px", opacity: 1 },
				}
			}, {
				section: "title",
				selector: "#logo-left-side",
				slide_num: 0,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { transform: "scaleX(0) translateX(75px)" },
					100: { transform: "scaleX(1) translateX(0)" },
				}
			}, {
				section: "title",
				selector: "#logo-right-side",
				slide_num: 0,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { transform: "scaleX(0) translateX(-75px)" },
					100: { transform: "scaleX(1) translateX(0)" },
				}
			}, {
				section: "title",
				selector: "#logo-middle",
				slide_num: 0,
				animation_duration: "5s",
				ease: "cubic-bezier(0, 1, 0, 1)",
				keyframes: {
					0:   { transform: "scaleX(0) translateX(0)" },
					100: { transform: "scaleX(1) translateX(0)" },
				}
			});
		</script>
	</g>

	<!-- <g class="slide" id="itinerary">
		<text id="itinerary-title" class="h2" x="960" y="125" text-anchor="middle">Itinerary:</text>

		<script>
			document.getElementById("itinerary-title").insertAdjacentHTML("afterend", [
				"What is SIMD & Why?",
				"How do I wield it?"
			].map((x, i) => `&lt;text click class="h2" id="itinerary-${i}" x="160" y="${225+50+i*125}" text-anchor="start"&gt;- ${x}&lt;/text&gt;`).join(""))

			document.getElementById("itinerary-1").insertAdjacentHTML("afterend", [
				"How do I setup Godbolt?",
				"How much can the compiler do?",
				"What can SIMD do?",
				"How do I find intrinsics?",
				"Other resources?",
			].map((x, i) => `&lt;text click class="h2" style="font-size: 3rem;" x="300" y="${225+50+1.75*125+i*75}" text-anchor="start"&gt;${i + 1}. ${x}&lt;/text&gt;`).join(""))
		</script>
	</g> -->

	<!-- <g class="slide" id="definitions">
		<text id="definitions-title" class="h2" x="960" y="125" text-anchor="middle">Definitions:</text>

		<script>
			document.getElementById("definitions-title").insertAdjacentHTML("afterend", [
				"SIMD: Single Instruction, Multiple Data",
				"SWAR: SIMD within a Register",
			].map((x, i) => `&lt;text click class="h3" x="60" y="${225+50+i*125}" text-anchor="start"&gt;- ${x}&lt;/text&gt;`).join(""))
		</script>
	</g> -->

<!-- 675 -->
	<g class="slide" id="basic-idea">
		<text id="basic-idea-title" class="h2" x="960" y="125" text-anchor="middle">Last time</text>

		<!-- <text click id="basic-solution-title" class="h2" x="960" y="765" text-anchor="middle">The Solution</text> -->
		<!-- <text click class="h2" id="basic-utility" x="250" y="600" text-anchor="start">Why this is helpful:</text> -->

		<script>
		{
			let iter = 0;
			let iter2 = 0;
			let y = 225+50+4.5*100-65-50-400;
			let tmp = 0;

		document.getElementById("basic-idea-title").insertAdjacentHTML("afterend", [
				"-- We made a &lt;tspan class=\"highlighted-blue\"&gt;Map(&lt;/tspan&gt;&lt;tspan class=\"highlighted\"&gt;IPv4&lt;/tspan&gt; &lt;tspan class=\"highlighted\" style=\"letter-spacing: -22px\"&gt;=>&lt;/tspan&gt;&lt;tspan style=\"letter-spacing: 13px\"&gt; &lt;/tspan&gt;&lt;tspan class=\"highlighted\"&gt;cluster&lt;/tspan&gt;&lt;tspan class=\"highlighted-blue\"&gt;)&lt;/tspan&gt;",
				<!-- "-- Our data set contains ~170 million &lt;tspan class=\"highlighted\"&gt;IPv4&lt;/tspan&gt;s", -->
				"-- Instead of storing each &lt;tspan class=\"highlighted\"&gt;IPv4&lt;/tspan&gt; as a &lt;tspan class=\"highlighted\"&gt;u32&lt;/tspan&gt;, we can save",
				"memory by storing 2^32 bits which represents the entire",
				"universe of possible &lt;tspan class=\"highlighted\"&gt;IPv4&lt;/tspan&gt; addresses.",
				"-- To indicate that a particular &lt;tspan class=\"highlighted\"&gt;IPv4&lt;/tspan&gt; is in the set,",
				"simply find the bit position corresponding to the &lt;tspan class=\"highlighted\"&gt;IPv4&lt;/tspan&gt;",
				"encoded as a &lt;tspan class=\"highlighted\"&gt;u32&lt;/tspan&gt; and set that bit to &lt;tspan class=\"highlighted-blue\"&gt;1&lt;/tspan&gt;.",

//				"-- 170 million * @sizeOf(u32) = 0.68GB",
//				"-- 2^32 bits&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 0.53GB",
		].map((x, i) =>
			x.slice(0, 2) === '--'
				? `&lt;text click class="h4" x="80" y="${tmp=y,y+=50+10+30,y}" text-anchor="start"&gt;${["&nbsp;&nbsp;i", "&nbsp;ii", "iii"][iter2++]}. ${x.slice(2)}&lt;/text&gt;`
				: x[0] === '-'
					? `&lt;text click class="h4" x="60" y="${tmp=y,y+=50+10+30,y}" text-anchor="start"&gt;${x}&lt;/text&gt;`
					: `&lt;text click class="h4" x="30" y="${tmp=y,y+=65-10,y}" text-anchor="start"&gt;${x}&lt;/text&gt;`
		).join(""));
		}
		</script>
	</g>

	<g class="slide" id="example" clicks="23">
		<text id="" class="h2" x="960" y="125" text-anchor="middle">Example</text>

		<text click class="h2" id="bitstr-ex" x="380" y="250" text-anchor="start">00<tspan class="highlighted">1</tspan>000<tspan class="highlighted">1</tspan>0<tspan class="highlighted">1</tspan>00<tspan click="15" class="highlighted-blue">1</tspan><tspan click="1-15" class="highlighted">1</tspan><tspan class="highlighted">1</tspan>000</text>

		<text click="14" class="h2" id="bitstr-ex3" x="380" y="350" text-anchor="start">&nbsp;&nbsp;<tspan class="highlighted">0</tspan>&nbsp;&nbsp;&nbsp;<tspan class="highlighted">1</tspan>&nbsp;<tspan class="highlighted">2</tspan>&nbsp;&nbsp;<tspan click="14-15" class="highlighted">3</tspan><tspan click="15" class="highlighted-blue" id="kept-address">3</tspan><tspan class="highlighted">4</tspan>&nbsp;&nbsp;&nbsp;</text>


		<g click="2-3" class="no-slide-in">
			<text class="h2" id="" x="380" y="325" text-anchor="start">&nbsp;&nbsp;<tspan class="highlighted-blue">^</tspan> This tells us <tspan class="highlighted-blue">2</tspan></text>
			<text class="h2" id="" x="380" y="425" text-anchor="start">&nbsp;&nbsp;&nbsp;&nbsp;is in the set</text>
		</g>

		<g click="3-4" class="no-slide-in">
			<text class="h2" id="" x="380" y="325" text-anchor="start">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<tspan class="highlighted-blue">^</tspan> <tspan class="highlighted-blue">6</tspan></text>
		</g>

		<g click="4-5" class="no-slide-in">
			<text class="h2 no-slide-in" id="" x="380" y="325" text-anchor="start">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<tspan class="highlighted-blue">^</tspan> <tspan class="highlighted-blue">8</tspan></text>
		</g>

		<g click="5-6" class="no-slide-in">
			<text class="h2 no-slide-in" id="" x="380" y="325" text-anchor="start">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<tspan class="highlighted-blue">^</tspan> <tspan class="highlighted-blue">11</tspan></text>
		</g>

		<g click="6-7" class="no-slide-in">
			<text class="h2 no-slide-in" id="" x="380" y="325" text-anchor="start">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<tspan class="highlighted-blue">^</tspan> <tspan class="highlighted-blue">12</tspan></text>
		</g>

		<text click="7-9" class="h3" x="960" y="330" text-anchor="middle">We also want associated data:</text>

		<text click="8" class="h2 tableau" x="960" y="395" text-anchor="middle" style="letter-spacing: -8">______________</text>
		<text click="8" class="h2 tableau" x="960" y="475" text-anchor="middle">|&ThinSpace;<tspan class="highlighted">a</tspan>&ThinSpace;|&ThinSpace;<tspan class="highlighted">b</tspan>&ThinSpace;|&ThinSpace;<tspan class="highlighted">c</tspan>&ThinSpace;|&ThinSpace;<tspan click="8-15" class="highlighted">d</tspan><tspan click="15" class="highlighted-blue">d</tspan>&ThinSpace;|&ThinSpace;<tspan class="highlighted">e</tspan>&ThinSpace;|</text>
		<text click="8" class="h2 tableau" x="960" y="491" text-anchor="middle" style="letter-spacing: -8">______________</text>



		<g click="15" class="no-slide-in">
			<text class="h2 no-slide-in" id="" x="380" y="320" text-anchor="start">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<tspan class="highlighted-blue">^</tspan> <tspan class="highlighted-blue">11</tspan></text>
		</g>

		<text click="17" class="h2" id="bitstr-ex2" x="380" y="450" text-anchor="start"><tspan id="expand-me-ples"><tspan click="17-18" id="zero-0">0</tspan><tspan click="18" id="zero-0" class="highlighted">1</tspan><tspan click="17-18" id="zero-1">0</tspan><tspan click="18" id="zero-1" class="highlighted">1</tspan><tspan click="17-18" id="zero-2">0</tspan><tspan click="18" id="zero-2" class="highlighted">1</tspan><tspan click="17-18" id="zero-3">0</tspan><tspan click="18" id="zero-3" class="highlighted">1</tspan><tspan click="17-18" id="zero-4">0</tspan><tspan click="18" id="zero-4" class="highlighted">1</tspan><tspan click="17-18" id="zero-5">0</tspan><tspan click="18" id="zero-5" class="highlighted">1</tspan><tspan click="17-18" id="zero-6">0</tspan><tspan click="18" id="zero-6" class="highlighted">1</tspan><tspan click="17-18" id="zero-7">0</tspan><tspan click="18" id="zero-7" class="highlighted">1</tspan><tspan click="17-18" id="zero-8">0</tspan><tspan click="18" id="zero-8" class="highlighted">1</tspan><tspan click="17-18" id="zero-9">0</tspan><tspan click="18" id="zero-9" class="highlighted">1</tspan><tspan click="17-18" id="zero-10">0</tspan><tspan click="18" id="zero-10" class="highlighted">1</tspan></tspan><tspan click="17-18" class="highlighted-blue">1</tspan><tspan click="18">0<tspan click="19">0000</tspan></tspan></text>

		<text click="19" class="h2" x="280" y="450" text-anchor="start">&</text>
		<text click="19" class="h2" x="280" y="458" text-anchor="start" style="letter-spacing: -9px">____________________</text>

		<g>
			<text click="17" class="h2 op-desc" x="1476" y="450" text-anchor="start"><tspan style="letter-spacing: -16px">(1</tspan></text>
			<text click="17" class="h2 op-desc" x="1605" y="450" text-anchor="start"><tspan style="letter-spacing: -35px">&lt;&lt;</tspan></text>
			<text click="17" class="h2 op-desc" x="1718" y="450" text-anchor="start"><tspan style="letter-spacing: -8px"><tspan class="highlighted-blue">11</tspan>)</tspan></text>
			<text click="18" class="h2" x="1718" y="475" text-anchor="start"><tspan style="letter-spacing: -20px">- 1</tspan></text>
		</g>

		<text click="20" class="h2" id="bitstr-exy" x="380" y="250" text-anchor="start">00<tspan class="highlighted">1</tspan>000<tspan class="highlighted">1</tspan>0<tspan class="highlighted">1</tspan>00<tspan id="dots-fade">.....</tspan></text>

		<line click="21-23" class="no-slide-in2" x1="553" y1="550" x2="553" y2="550"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)"
		click-21="553, 721, 550, 629"
		damping="0.8" stiffness="0.005"
		></line>

		<line click="21-23" class="no-slide-in2" x1="820" y1="550" x2="820" y2="550"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)"

		click-21="820, 751, 550, 629"
		damping="0.8" stiffness="0.005"
		></line>

		<line click="21-23" class="no-slide-in2" x1="957" y1="550" x2="957" y2="550"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)"

		click-21="957, 781, 550, 629"
		damping="0.8" stiffness="0.005"
		></line>

		<line click="22-23" class="no-slide-in2" x1="741" y1="730" x2="741" y2="730"
        stroke="rgb(255, 177, 100)" stroke-width="3"
        marker-end="url(#arrowhead-orange)"
		click-22="741, 1129, 730, 830"
		damping="0.8" stiffness="0.005"
		></line>

		<text click="21" class="h2" x="710" y="720" id="fade-3-delayed" text-anchor="start"><tspan class="highlighted-blue">3</tspan></text>

		<script>
			global_animations.push({
				section: "example",
				selector: ".op-desc",
				slide_num: 18,
				animation_delay: "0s",
				animation_duration: "0.6s",
				continuous: true,
				keyframes: {
					0:   { transform: "translateY(0px)" },
					100: { transform: "translateY(-50px)" },
				}
			}, {
				section: "example",
				selector: "#expand-me-ples",
				slide_num: 17,
				animation_delay: "1s",
				animation_duration: "5s",
				keyframes: {
					0:   { "letter-spacing": "-1em", opacity: 0 },
					30:  { opacity: 1 },
					100: { "letter-spacing": 0, opacity: 1 },
				}
			}, {
				section: "example",
				selector: "#bitstr-ex3 :not(#kept-address)",
				slide_num: 15,
				animation_duration: "1s",
				continuous: true,
				keyframes: {
					0:   { opacity: 1 },
					100:  { opacity: 0.3 },
				}
			}, {
				section: "example",
				selector: "#bitstr-ex3",
				slide_num: 16,
				animation_duration: "1s",
				continuous: true,
				keyframes: {
					0:   { opacity: 1 },
					100:  { opacity: 0 },
				}
			}, {
				section: "example",
				selector: ".tableau",
				slide_num: 16,
				animation_duration: "1s",
				continuous: true,
				keyframes: {
					0:   { transform: "translateY(0)" },
					100:  { transform: "translateY(450px)" },
				}
			}, {
				section: "example",
				selector: "#bitstr-exy",
				slide_num: 20,
				animation_delay: "0.1s",
				animation_duration: "3s",
				continuous: true,
				keyframes: {
					0:   { transform: "translateY(0)" },
					100:  { transform: "translateY(300px)" },
				}
			}, {
				section: "example",
				selector: "#dots-fade",
				slide_num: 20,
				animation_delay: "2s",
				animation_duration: "1s",
				continuous: true,
				keyframes: {
					0:   { opacity: 0 },
					100:  { opacity: 1 },
				}
			}, {
				section: "example",
				selector: "#fade-3-delayed",
				slide_num: 21,
				animation_delay: "2s",
				animation_duration: "1s",
				continuous: true,
				keyframes: {
					0:   { opacity: 0 },
					100:  { opacity: 1 },
				}
			});

			for (let i = 0; i <= 10; i++)
				global_animations.push({
					section: "example",
					selector: `.unhide-slide#zero-${i}`,
					slide_num: 17,
					animation_delay: "1s",
					animation_duration: "5s",
					keyframes: {
						0:   { opacity: 0 },
						[Math.min(99, i*30)]:  { opacity: 1 },
						100: { "letter-spacing": 0, opacity: 1 },
					}
				});
		</script>

		<!-- <text click="9" class="h2 no-slide-in2" x="960" y="341" text-anchor="middle" style="letter-spacing: -22px;" style=
		"transform: rotate(45 50 100) !important">====></text> -->

  <!-- Define arrowhead marker -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7"
            refX="8" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" stroke="rgb(0, 255, 255)"/>
    </marker>

	<marker id="arrowhead-orange" markerWidth="10" markerHeight="7"
            refX="8" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" stroke="rgb(255, 177, 100)"/>
    </marker>
  </defs>

  <!-- Draw line with arrow -->
   <!-- [553, 631], [820, 787], [957, 958], [1157.25, 1129], [1224, 1278] -->

   <!-- <svg width="400" height="200">
  <line id="myLine" x1="50" y1="50" x2="150" y2="50"
        stroke="black" stroke-width="2">
    <animate attributeName="x1" from="50" to="100" dur="2s" fill="freeze" />
    <animate attributeName="y1" from="50" to="100" dur="2s" fill="freeze" />
    <animate attributeName="x2" from="150" to="200" dur="2s" fill="freeze" />
    <animate attributeName="y2" from="50" to="120" dur="2s" fill="freeze" />
  </line>
</svg> -->


  <line id="slidable-line" class="no-slide-in2" click="9-14" x1="300" y1="250" x2="-1000" y2="429"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)"

		click-9="553, 631"
		click-10="820, 787"
		click-11="957, 958"
		click-12="1157.25, 1129"
		click-13="1224, 1278"
		>
	</line>

		<!-- <line class="no-slide-in2" click="10-11" x1="820" y1="250" x2="787" y2="429"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)" /> -->

		<!-- <line class="no-slide-in2" click="11-12" x1="957" y1="250" x2="958" y2="429"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)" />

		<line class="no-slide-in2" click="12-13" x1="1157.25" y1="250" x2="1129" y2="429"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)" />

		<line class="no-slide-in2" click="13-14" x1="1224" y1="250" x2="1278" y2="429"
        stroke="rgb(0, 255, 255)" stroke-width="3"
        marker-end="url(#arrowhead)" /> -->





	</g>

	<g class="slide" id="tree" clicks="18:12,25:7,31:3,44:5,55,1">
		<g class="code" id="phase-1-code" x="0" y="0" width="1920" line-height="80" line-num-indent="80" line-indent="100" hide-background lang="zig" steps="95,96:4,100,101,102,104:5,110:3,114:5,120:3,124:7,127,176:4,177,178,180,181:3,185,186,187,188,189,192:2,192:2,191:4,196:2,198:2,198:2,201,125,124:7">
/// An HHID cache that maps u32's to u16's.
/// Design: https://docs.google.com/document/d/1rlY03DLHRMWOFxCX8THchSgx5AMmm_dAb8x5WJnZYvA/edit?tab=t.0#heading=h.j0zhsan4bqvs
/// If we get to the point where we have billions of IP addresses in this cache,
/// we can switch  this buffer to just be a flat array of u16's.
const CHECKPOINT_INTERVAL = 2048; // The interval number of bits for how often we cache the popcount.

const CHECKPOINT_BYTE_INTERVAL = @divExact(CHECKPOINT_INTERVAL, @bitSizeOf(u8));
const VLEN = @bitSizeOf(Vector(u8));
const NUM_VECS_PER_CHECKPOINT = blk: {
    const num_vecs_per_checkpoint = CHECKPOINT_INTERVAL / VLEN;
    if (!std.math.isPowerOfTwo(CHECKPOINT_INTERVAL))
        @compileError("CHECKPOINT_INTERVAL must be a power of 2");

    if (num_vecs_per_checkpoint * @bitSizeOf(u8) > std.math.maxInt(u8))
        @compileError("For machines lacking AVX512_VPOPCNTDQ, we prefer to use a technique that assumes we can add vectors of u8's together without overflowing.\n" ++
            "This is because we have the `cnt` instruction on ARM, and on impoverished versions of x86-64 the compiler will use vpshufb's to popcount u4's.\n" ++
            std.fmt.comptimePrint("With `CHECKPOINT_INTERVAL` set to {}, we may have to add {} byte popcounts together, which gives our u8 a maximum value of {}.\n" ++
                "Please decrease `CHECKPOINT_INTERVAL`.", .{ CHECKPOINT_INTERVAL, num_vecs_per_checkpoint, num_vecs_per_checkpoint * @bitSizeOf(u8) }));

    break :blk num_vecs_per_checkpoint;
};

const reduce_uint = std.meta.Int(.unsigned, @max(8, std.math.ceilPowerOfTwo(u16, std.math.log2(NUM_VECS_PER_CHECKPOINT * @bitSizeOf(u8) * @sizeOf(Vector(u8)))) catch unreachable));

const std = @import("std");
const builtin = @import("builtin");
const utils = @import("../utils.zig");
const caches = @import("../caches.zig");
const simd = utils.simd;

const HHID = utils.StringifyableEnum(u16, .hhid);
const Vector = simd.Vector;

const IPV4_CARDINALITY = 1 << 32;
const UNIVERSE_BYTE_LEN = IPV4_CARDINALITY / @bitSizeOf(u8);

universe: *[UNIVERSE_BYTE_LEN]u8 = undefined,
hhids: []HHID = &.{},
date: ["2025-07-01".len]u8 = "2025-07-01".*,
checkpoints: *[(@as(usize, 1) << 32) / CHECKPOINT_INTERVAL]u32 = undefined,

pub const MAX_READABLE_BUFFER_SIZE = @sizeOf(std.meta.Child(@FieldType(@This(), "universe"))) +
    @bitSizeOf(std.meta.Child(@FieldType(@This(), "universe"))) * @sizeOf(u16) + // hhids memory
    "2025-07-01".len;

pub fn deinit(self: @This(), allocator: std.mem.Allocator) void {
    allocator.destroy(self.universe);
    allocator.destroy(self.checkpoints);
    allocator.free(self.hhids);
}

pub fn init(allocator: std.mem.Allocator, buffer: []const u8) !@This() {
    var self: @This() = undefined;

    self.universe = try allocator.create(@TypeOf(self.universe.*));
    errdefer allocator.destroy(self.universe);

    @memcpy(self.universe[0..UNIVERSE_BYTE_LEN], buffer[0..UNIVERSE_BYTE_LEN]);

    self.checkpoints = try allocator.create(@TypeOf(self.checkpoints.*));
    errdefer allocator.destroy(self.checkpoints);

    var running_popcnt: u32 = 0;

    for (
        @as(*[@divExact(UNIVERSE_BYTE_LEN, CHECKPOINT_BYTE_INTERVAL)][CHECKPOINT_BYTE_INTERVAL]u8, @ptrCast(self.universe)),
        self.checkpoints,
    ) |interval, *checkpoint| {
        checkpoint.* = running_popcnt;
        comptime var remaining_bits = CHECKPOINT_INTERVAL;
        var cur: []const u8 = interval[0..];
        var rank_accumulators: Vector(u8) = @splat(0);

        inline while (remaining_bits >= VLEN) : (remaining_bits -= VLEN) {
            const chunk: Vector(u8) = cur[0 .. VLEN / 8].*;
            rank_accumulators += @popCount(chunk);
            cur = cur[VLEN / 8 ..];
        }

        running_popcnt += @reduce(.Add, @as(@Vector(@sizeOf(Vector(u8)), reduce_uint), rank_accumulators));
    }

    self.hhids = try allocator.alloc(HHID, running_popcnt);
    errdefer allocator.free(self.hhids);

    const hhid_byte_len = running_popcnt * @sizeOf(HHID);
    @memcpy(std.mem.sliceAsBytes(self.hhids), buffer[UNIVERSE_BYTE_LEN..][0..hhid_byte_len]);

    self.date = buffer[UNIVERSE_BYTE_LEN + hhid_byte_len ..][0..self.date.len].*;
    std.debug.assert(UNIVERSE_BYTE_LEN + hhid_byte_len + self.date.len == buffer.len);

    return self;
}

pub fn query(self: @This(), ip_: caches.IpAddress) ?HHID {
    // If we are working with an empty data structure, do nothing.
    // We support this because we unfortunately support initializing
	// this structure without allocating
    if (self.hhids.len == 0) return null;
    const ip: u32 = @intFromEnum(ip_);
	const bit: u1 = @truncate(self.universe[ip / 8] >> @truncate(ip));
    if (bit == 0) return null;

    const most_recent_checkpoint_bit_position = std.mem.alignBackward(
		u32,
		ip,
		CHECKPOINT_INTERVAL,
	);

    const checkpoint = self.checkpoints[
		most_recent_checkpoint_bit_position / CHECKPOINT_INTERVAL
	];

    const checkpoint_vec:
		*align(1) const @Vector(CHECKPOINT_BYTE_INTERVAL, u8) =
		self.universe
			[most_recent_checkpoint_bit_position / 8 ..]
			[0..CHECKPOINT_BYTE_INTERVAL];

	const remaining_bits: std.math.Log2Int(
		std.meta.Int(.unsigned, CHECKPOINT_INTERVAL)
	) = @truncate(ip);

    return self.hhids[
        checkpoint + switch (builtin.cpu.arch) {
            .aarch64 => popcount_bits_arm(checkpoint_vec, remaining_bits),
            .x86_64 => popcount_bits(checkpoint_vec, remaining_bits),
            else => popcount_bits(checkpoint_vec, remaining_bits),
        }
    ];
}

const IS_ZEN4_OR_HIGHER = blk: {
    const cpu_name = builtin.cpu.model.name;
    break :blk std.mem.startsWith(u8, cpu_name, "znver") and
		(
			cpu_name["znver".len] > '3' or
			cpu_name["znver".len..].len > 1
		);
};

fn masked_popcnt(
	vec_1: @Vector(8, u64),
	mask_: @Vector(32, bool),
	mask_offset: comptime_int
) @Vector(8, u8) {
	const mask = std.simd.extract(mask_, mask_offset, 8);
    return if (IS_ZEN4_OR_HIGHER) // masked vpmovqb is slower on Intel
         std.simd.extract(asm (
            \\ vpmovqb %[vec_1], %[sum] {%[mask]}
            : [sum] "=x" (-> @Vector(16, u8)),
            : [vec_1] "x" (@as(@Vector(8, u8), @popCount(vec_1))),
                [mask] "^Yk" (mask),
        ), 0, 8)
    else
        @select(
			u8,
			mask,
			@as(@Vector(8, u8), @popCount(vec_1)),
			@as(@Vector(8, u8), @splat(0)),
		);
}

fn h_add_lane(x: @Vector(8, u8)) @Vector(1, u64) {
    return std.simd.extract(struct {
        extern fn @"llvm.x86.sse2.psad.bw"(
			@Vector(16, u8),
			@Vector(16, u8)
		) @Vector(2, u64);
    }.@"llvm.x86.sse2.psad.bw"(
		std.simd.join(x, @as(@Vector(8, u8), @splat(0))),
		@splat(0),
	), 0, 1);
}

fn popcount_bits(
	vec: *align(1) const @Vector(256, u8),
	bit_pos: u11,
) u64 {
	const _8_byte_pos: u5 = @truncate(bit_pos >> 6);
    const u64s_to_keep: @Vector(32, bool) = @bitCast(
		bzhi(~@as(u32, 0), _8_byte_pos),
	);

    const u64_vecs: [4]@Vector(8, u64) = @bitCast(vec.*);
    const a = masked_popcnt(u64_vecs[0], u64s_to_keep,  0);
    const b = masked_popcnt(u64_vecs[1], u64s_to_keep,  8);
    const c = masked_popcnt(u64_vecs[2], u64s_to_keep, 16);
    const d = masked_popcnt(u64_vecs[3], u64s_to_keep, 24);

    const popcounts_up_to_last_8_bytes = (
		h_add_lane(a + b) +
		h_add_lane(c + d)
	)[0];

    const _8_byte =
		@as(*align(1) const [32]u64, @ptrCast(vec))[_8_byte_pos];
    const last_8_byte_popcount: u64 =
		@popCount(bzhi(_8_byte, @as(u6, @truncate(bit_pos))));

    return popcounts_up_to_last_8_bytes + last_8_byte_popcount;
}









		</g>
	<script>
		document.getElementById("tree").setAttribute("clicks", document.getElementById("phase-1-code").getAttribute("steps"));
	</script>
	</g>


	<g class="slide" id="conclusion">
		<text id="mem-tradeoffs" class="h2" id="" x="250" y="100" text-anchor="start">Memory Tradeoffs:</text>
		<!-- <text class="h4" id="" x="250" y="300" text-anchor="start"></text>
		<text class="h4" id="" x="250" y="425" text-anchor="start">with guaranteed space</text>
		<text class="h4" id="" x="250" y="550" text-anchor="start">and memory constraints!</text> -->


<style>

.stroke-rain {
	stroke: hsl(0, 100%, 50%);
	animation: strokeHue 2s linear infinite !important;
}

@keyframes strokeHue {
	0%   { stroke: hsl(0,   100%, 50%); }   /* red */
	25%  { stroke: hsl(90,  100%, 50%); }   /* green */
	50%  { stroke: hsl(180, 100%, 50%); }   /* cyan */
	75%  { stroke: hsl(270, 100%, 50%); }   /* purple */
	100% { stroke: hsl(360, 100%, 50%); }   /* back to red */
}

.sub {
	font-size: 60%;
	baseline-shift: -10px;
	letter-spacing: -8px;
}

.super {
	font-size: 60%;
	baseline-shift: 20px;
	letter-spacing: -8px;
}

.sub-space {
	letter-spacing: -11px;
}

.undies {
	font-size: 80%;
}

.ceil {
	baseline-shift: 13px;
}

.hidey-ones {
	opacity: 0;
}

</style>

		<script>
			{
			let iter = 0;
			let iter2 = 0;
			let y = 225+50+4.5*100-65-50-400;
			let tmp = 0;

		document.getElementById("mem-tradeoffs").insertAdjacentHTML("afterend", [
				"-- Naive storage: 160&lt;tspan class=\"undies\"&gt;_&lt;/tspan&gt;101&lt;tspan class=\"undies\"&gt;_&lt;/tspan&gt;556 * 4 bytes = 640.4MB",
				"-- Universe Idea: 2&lt;tspan class=\"super\"&gt;3&lt;tspan class=\"sub-space\"&gt; &lt;/tspan&gt;2&lt;/tspan&gt; bits = 536.9MB",
				"-- &lt;tspan class=\"stroke-rain\"&gt;Elias Fano: 133.6MB&lt;/tspan&gt;",
				"-- Information-theoretic lower bound: 123.3MB",
					"- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log&lt;tspan class=\"sub\"&gt;2&lt;/tspan&gt;(2&lt;tspan class=\"super\"&gt;3&lt;tspan class=\"sub-space\"&gt; &lt;/tspan&gt;2&lt;/tspan&gt; nCr 160&lt;tspan class=\"undies\"&gt;_&lt;/tspan&gt;101&lt;tspan class=\"undies\"&gt;_&lt;/tspan&gt;556)"
		].map((x, i) =>
			x.slice(0, 2) === '--'
				? `&lt;text click class="h4" x="80" y="${tmp=y,y+=50+10+30,y}" text-anchor="start"&gt;${["&nbsp;&nbsp;i", "&nbsp;ii", "iii", "&nbsp;iv"][iter2++]}. ${x.slice(2)}&lt;/text&gt;`
				: x[0] === '-'
					? `&lt;text click class="h4" x="80" y="${tmp=y,y+=50+10+30,y}" text-anchor="start"&gt;${x.slice(2)}&lt;/text&gt;`
					: `&lt;text click class="h4" x="30" y="${tmp=y,y+=65-10,y}" text-anchor="start"&gt;${x}&lt;/text&gt;`
		).join(""));
		}
		</script>
	</g>

	<g class="slide" id="elias-fano-intro" clicks="11">
		<text class="h2" id="" x="980" y="100" text-anchor="middle">Elias-Fano?</text>
		<text click class="h4" id="" x="80" y="175" text-anchor="start">Also called <tspan class="highlighted-blue">"Elias delta coding"</tspan>, it is a scheme for</text>
		<text click class="h4" id="llk" x="80" y="225" text-anchor="start">encoding "monotonically increasing integers".</text>
		<text click="4" class="h4" id="" x="80" y="275" text-anchor="start">1. We split each integer into 2 groups, <tspan style="letter-spacing: -24px">|<tspan class="ceil">-</tspan></tspan><tspan style="letter-spacing: -8px"> </tspan>log<tspan class="sub">2</tspan><tspan style="letter-spacing: -19px"> </tspan>n<tspan style="letter-spacing: -24px"><tspan class="ceil">-</tspan>|</tspan><tspan style="letter-spacing: 14px"> </tspan>upper</text>

		<text click="5" class="h4" id="" x="80" y="325" text-anchor="start">bits and the remainder in low bits. We split 28:4</text>
		<text click="6" class="h4" id="" x="80" y="375" text-anchor="start">2. Low 4 bits are stored in a contiguous array.</text>
		<text click="8" class="h4" id="" x="80" y="425" text-anchor="start">3. High bits are stored in (inverted) Elias gamma coding.</text>

		<script>
		const nums = "5 10 32 33 35 40 48 52 113".split(' ').map(e => +e);
		// 01 0100
		// 10 0011
		// 10 0011

		const colors2 = [
			"rgb(0, 255, 255)",   // cyan
			"rgb(255, 177, 100)", // orange
			"rgb(255, 99, 132)",  // red-pink
			"rgb(144, 238, 144)", // light green
			"rgb(255, 255, 102)", // bright yellow
			"rgb(255, 112, 255)",
			"rgb(70, 255, 180)",  // steel blue
			"rgb(255, 15, 180)", // hot pink
			"rgb(255, 215, 20)",   // gold
		];

		<!-- stroke: rgb(255, 177, 100); stroke-width: 1px -->


		document.getElementById("llk").insertAdjacentHTML("afterend",
			nums.map((e, i) => `&lt;text click="3" class="h3" id="" x="${120 + i * 200}" y="500" text-anchor="middle"&gt;&lt;tspan style="fill: ${colors2[i]} !important;"&gt;${e}&lt;/tspan&gt;&lt;/text&gt;`).join(" ")
		);

		document.getElementById("llk").insertAdjacentHTML("afterend",
		`&lt;text id="nibbles" click="6" class="h4" style="font-size: 35px" id="" x="49" y="550" text-anchor="start"&gt;` +
			nums.map(e => (e & 0xF).toString(2).padStart(4, '0')).map((e, i) => `&lt;tspan style="fill: ${colors2[i]} !important;"&gt;${e}&lt;/tspan&gt;`).join("&lt;tspan class=\"nibble-space\"&gt;&nbsp;&lt;/tspan&gt;") + "&lt;/text&gt;"
		);

		document.getElementById("llk").insertAdjacentHTML("afterend",
			nums.map(e => e >> 4).map((e, i) => `&lt;text click="8" class="h4" style="font-size: 35px" x="${120 + i * 200}" y="550" text-anchor="middle"&gt;&lt;tspan style="fill: ${colors2[i]} !important;"&gt;${e}&lt;/tspan&gt;&lt;/text&gt;`).join(" ")
		);

		let j = 0;
		const counts = nums.map(e => (e >> 4).toString(2).padStart(2, '0')).reduce((a, c) => a.set(c, 1 + (a.get(c) ?? 0)), new Map());
		const counts_arr = [...counts].reduce((a, [i, v]) => (a[+("0b" + i)] = v, a), new Array(16).fill(0));
		const u28s = nums.map(e => e >> 4);
		const gamma = '1' + counts_arr.map(
			(i) => `&lt;tspan class="zzs"&gt;${
				[..."0".repeat(i)]
					.map(e => `&lt;tspan style="fill: ${colors2[j]} !important;"&gt;${u28s[j++]}&lt;/tspan&gt;`)
					.join("")
			}&lt;/tspan&gt;`).join('1') + '...';

		document.getElementById("llk").insertAdjacentHTML("afterend",
		`&lt;text id="gamma" click="8" class="h4" style="font-size: 35px" id="" x="${79}" y="850" text-anchor="start"&gt;` +
			gamma + "&lt;/text&gt;"
		);

		j = 0;

		const gamma2 = ('1' + counts_arr.map((i) => `&lt;tspan class="zzs"&gt;${"&nbsp;".repeat(i)}&lt;/tspan&gt;`).join('1') + '...').replaceAll('1', () => (j++).toString(16));

		document.getElementById("llk").insertAdjacentHTML("afterend",
		`&lt;text id="gamma2" click="8" class="h4" style="font-size: 35px" id="" x="${79}" y="800" text-anchor="start"&gt;` +
			gamma2 + "&lt;/text&gt;"
		);

		let prev_k = -1;
		let uu = undefined;

		document.getElementById("llk").insertAdjacentHTML("afterend",
		`&lt;text click="9" id="bibsies" class="h4" style="font-size: 35px" x="102" y="550" text-anchor="start"&gt;${
			nums.map(e => e >> 4).map((e, i) => `${e > prev_k ? (uu = e - prev_k, prev_k = e, `&lt;tspan class="hidey-ones"&gt;${"1".repeat(uu)}&lt;/tspan&gt;`) : ""}&lt;tspan style="fill: ${colors2[i]} !important;"&gt;${e}&lt;/tspan&gt;`).join("&lt;tspan class=\"bibble-space\"&gt;&nbsp;&lt;/tspan&gt;")
		}&lt;/text&gt;`
		);

		j = 0;
		const gamma3 = '1' + counts_arr.map(
			(i) => [..."0".repeat(i)]
					.map(e => `&lt;tspan style="fill: ${colors2[j++]} !important;"&gt;0&lt;/tspan&gt;`)
					.join("")
			).join('1') + '...';

		document.getElementById("llk").insertAdjacentHTML("afterend",
		`&lt;text id="gamma3" click="10" class="h4" style="font-size: 35px" id="" x="${79}" y="900" text-anchor="start"&gt;` +
			gamma3 + "&lt;/text&gt;"
		);


		global_animations.push({
			section: "elias-fano-intro",
			selector: `#bibsies`,
			slide_num: 9,
			animation_delay: "0s",
			animation_duration: "4.75s",
			continuous: true,
			keyframes: {
				0:   { transform: "translate(0, 0)" },
				100: { transform: "translate(-23px, 300px)" },
			}
		});

		global_animations.push({
			section: "elias-fano-intro",
			selector: `.hidey-ones`,
			slide_num: 9,
			animation_delay: "0s",
			animation_duration: "4.75s",
			continuous: true,
			keyframes: {
				0:   { "letter-spacing": "-35px" },
				100: { "letter-spacing": "0px" },
			}
		});

		global_animations.push({
			section: "elias-fano-intro",
			selector: `.bibble-space`,
			slide_num: 9,
			animation_delay: "0s",
			animation_duration: "4.75s",
			continuous: true,
			keyframes: {
				0:   { "letter-spacing": "130px" },
				100: { "letter-spacing": "-35px" },
			}
		});

		global_animations.push({
			section: "elias-fano-intro",
			selector: `.zzs`,
			slide_num: 9,
			animation_delay: "0s",
			animation_duration: "5s",
			continuous: true,
			keyframes: {
				0: { "letter-spacing": "-35px", opacity: 0 },
				100:   { "letter-spacing": "0px", opacity: 0 },
			}
		});

		global_animations.push({
			section: "elias-fano-intro",
			selector: `.nibble-space`,
			slide_num: 7,
			animation_delay: "0s",
			animation_duration: "2s",
			continuous: true,
			keyframes: {
				0:   { "letter-spacing": "25px" },
				100: { "letter-spacing": "-32px" },
			}
		});

		global_animations.push({
			section: "elias-fano-intro",
			selector: `#nibbles`,
			slide_num: 7,
			animation_delay: "0s",
			animation_duration: "2s",
			continuous: true,
			keyframes: {
				0:   { transform: "translate(0px, 0px)" },
				100: { transform: "translate(570px, 500px)" },
			}
		});

		</script>
	</g>

	<g class="slide" id="querying-intro" clicks="12">
		<text class="h2" id="" x="980" y="100" text-anchor="middle">How to query?</text>
		<text click class="h3" id="" x="60" y="200" text-anchor="start">First, some definitions:</text>
		<text click class="h4" id="" x="100" y="260" text-anchor="start">rank<tspan class="highlighted-blue sub">b</tspan>(<tspan class="highlighted">p</tspan>) <tspan style="letter-spacing: -18px;">=> </tspan>&nbsp;the # of <tspan class="highlighted-blue">b</tspan>'s up to pos <tspan class="highlighted">p</tspan></text>
		<text click class="h4" id="select-def" x="100" y="310" text-anchor="start">select<tspan class="highlighted-blue sub">b</tspan>(<tspan class="highlighted">k</tspan>) <tspan style="letter-spacing: -18px;">=> </tspan>&nbsp;the pos of the <tspan class="highlighted">k</tspan>th <tspan class="highlighted-blue">b</tspan></text>

		<text click class="h4" x="100" y="360" text-anchor="start">find(<tspan class="highlighted">u4</tspan>, <tspan class="highlighted">p</tspan>, <tspan class="highlighted">k</tspan>) <tspan style="letter-spacing: -18px;">=> </tspan>&nbsp;matches <tspan class="highlighted">u4</tspan> to one of <tspan class="highlighted">k</tspan> low bits at pos <tspan class="highlighted">p</tspan></text>

		<text click class="h3" id="" x="60" y="450" text-anchor="start">To find the index of an integer in the set:</text>

		<text click class="h4" x="466" y="520" text-anchor="start"><tspan class="highlighted">a</tspan> <tspan style="letter-spacing: -12px">:=</tspan> rank<tspan class="highlighted-blue sub">0</tspan>(select<tspan class="highlighted-blue sub">1</tspan>(<tspan class="highlighted">ip<tspan style="letter-spacing: -25px"> </tspan>»<tspan style="letter-spacing: -25px"> </tspan>4</tspan>))</text>

		<text click class="h4" x="250" y="575" text-anchor="start"><tspan class="highlighted">a</tspan> + find(<tspan class="highlighted">ip & 0xF</tspan>, <tspan class="highlighted">a</tspan>, rank<tspan class="highlighted-blue sub">0</tspan>(select<tspan class="highlighted-blue sub">1</tspan>(<tspan class="highlighted">ip<tspan style="letter-spacing: -25px"> </tspan>»<tspan style="letter-spacing: -25px"> </tspan>4 + 1</tspan>)) - <tspan class="highlighted">a</tspan>)</text>

		<text click class="h3" id="" x="60" y="660" text-anchor="start">Let's query for <tspan class="highlighted">ip = </tspan><tspan fill="rgb(255, 255, 102)">35</tspan></text>

		<text click class="h4" id="" x="60" y="720" text-anchor="start"><tspan fill="rgb(255, 255, 102)">35</tspan><tspan style="letter-spacing: -25px"> </tspan>»<tspan style="letter-spacing: -25px"> </tspan>4 <tspan style="letter-spacing: -18px;">=> </tspan>&nbsp;2</text>

		<text click class="h4" id="" x="60" y="780" text-anchor="start">
			select<tspan class="highlighted-blue sub">1</tspan>(2) <tspan style="letter-spacing: -18px;">=> </tspan>&nbsp;4
		</text>


		<text click class="h4" id="" x="60" y="840" text-anchor="start">
			<tspan class="highlighted">a</tspan> <tspan style="letter-spacing: -12px">:=</tspan> rank<tspan class="highlighted-blue sub">0</tspan>(4) <tspan style="letter-spacing: -18px;">=> </tspan>&nbsp;2
		</text>

		<script>
			document.getElementById("select-def").insertAdjacentHTML("afterend",
	`&lt;text id="gamma2-2" click="8" class="h4" style="font-size: 35px" id="" x="${79}" y="900" text-anchor="start"&gt;` +
		gamma2 + "&lt;/text&gt;"
	);
			document.getElementById("select-def").insertAdjacentHTML("afterend",
		`&lt;text id="gamma3-2" click="8" class="h4" style="font-size: 35px" id="" x="${79}" y="950" text-anchor="start"&gt;` +
			gamma3 + "&lt;/text&gt;"
		);

		document.getElementById("select-def").insertAdjacentHTML("afterend",
		`&lt;text id="nibbles-2" click="8" class="h4" style="font-size: 35px" id="" x="${619}" y="1050" text-anchor="start"&gt;` +
			nums.map(e => (e & 0xF).toString(2).padStart(4, '0')).map((e, i) => `&lt;tspan style="fill: ${colors2[i]} !important;"&gt;${e}&lt;/tspan&gt;`).join("") + "&lt;/text&gt;"
		);

		</script>
	</g>

	<g class="slide" id="end">
		<text class="h2" x="960" y="525" text-anchor="middle" style="font-size: 150px; letter-spacing: 0.1px;">fin</text>
	</g>
</svg>

<svg id="overlay" style="overflow: hidden; width: 100%;" y="5000" viewBox="0 0 1920 1080" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<g class="slide" id="tree-overlay">
		<rect id="backdrop" click="1-29" x="0" y="475" height="1250" width="22000" style="fill: #100020F8;"/>

		<g id="clear-me-pls">
			<text id="bitsos" click="16" class="h3" x="12" y="619" text-anchor="start" style="letter-spacing: 14px">&nbsp;<tspan class="highlighted">111111111111</tspan>00000000000000000000</text>


			<text click="1" class="h3 magnify" x="10" y="650" text-anchor="start"><tspan class="shrink">|-----|-----|-----</tspan><tspan click="1-6">|</tspan><tspan id="zoomy"><tspan class="appeary-g"><tspan class="highlighted-blue" click="6">|</tspan>-<tspan class="appeary" click="12">-----</tspan>-<tspan class="appeary" click="12">-----</tspan>-<tspan class="appeary" click="12">-----</tspan>-<tspan class="appeary" click="12">-----</tspan>-<tspan class="appeary" click="12">-------</tspan></tspan></tspan><tspan class="shrink">|-----|-----|-----|</tspan></text>
			<text click="3" class="h3 vertbar" x="911" y="650" text-anchor="start"><tspan class="highlighted" fill="rgb(0, 255, 255)">|</tspan></text>
		</g>



		<script>
			const bitsos = document.getElementById("bitsos");


			([ 17, 33, 64, 16, 51,  24, 44, 55, 23,
  50, 35, 64, ...new Array(20).fill(0)]).forEach((e, i) => {
	const str =  `&lt;text click="${18+Math.floor(i / 8)}" class="h4 group-${Math.floor(i / 8)}" x="${66 + i * 58}" y="689" text-anchor="start" style="letter-spacing: -5px; font-size: 26px"&gt;${e.toString().padStart(2, '0')}&lt;/text&gt;`;
	bitsos.insertAdjacentHTML("afterend", str);
});

	[17, 33, 64, 16, 51,  24, 44, 55].map((e, i) => {
		const v = e + [23, 50, 35, 64, 0,   0,   0,  0][i];

		const str =  `&lt;text click="22" class="h4 hadd-${i}" x="${66 + i * 58}" y="762" text-anchor="start" style="opacity: 0;letter-spacing: -5px; font-size: 26px; fill:rgb(217.92242417267, 180.94028587497, 225.11508725765)!important"&gt;${v.toString().padStart(2, '0')}&lt;/text&gt;`;
		bitsos.insertAdjacentHTML("afterend", str);
	});

	new Array(8).fill(0).map((v, i) => {
		const str =  `&lt;text click="22" class="h4 hadd-${i}" x="${928+66 + i * 58}" y="762" text-anchor="start" style="opacity: 0;letter-spacing: -5px; font-size: 26px; fill: rgb(179.21986423706, 250.45426473762, 131.46306721922)!important"&gt;${v.toString().padStart(2, '0')}&lt;/text&gt;`;
		bitsos.insertAdjacentHTML("afterend", str);
	});


	new Array(2).fill().forEach((_, i) => {
		const str2 =  `&lt;text click="22" class="h4 group-5" x="${66 + [7.5, 23.5][i] * 58 - 464}" y="723" text-anchor="start" style="letter-spacing: -5px; font-size: 26px; fill: hsl(265, 89%, 78%)!important"&gt;+&lt;/text&gt;`;
		const str3 =  `&lt;text click="22" class="h4 group-5" x="${56 + [8, 24][i] * 58 - 464}" y="728" text-anchor="start" style="letter-spacing: -5px; font-size: 26px; fill: hsl(265, 89%, 78%)!important"&gt;______________________&lt;/text&gt;`;

		bitsos.insertAdjacentHTML("afterend", str2);
		bitsos.insertAdjacentHTML("afterend", str3);
	});


	new Array(2).fill().forEach((_, i) => {		new Array(7).fill().forEach((_, j) => {
			const str2 =  `&lt;text click="23" class="h4 plus-${j}" x="${66 + [7.5, 23.5][i] * 58 - 464}" y="${(j+1)*33 + 762}" text-anchor="start" style="letter-spacing: -5px; font-size: 26px; fill: hsl(265, 89%, 78%)!important"&gt;+&lt;/text&gt;`;
			bitsos.insertAdjacentHTML("afterend", str2);
		});
	const str3 =  `&lt;text click="23" class="h4 group-6" x="${56 + [8, 24][i] * 58 - 464}" y="998" text-anchor="start" style="letter-spacing: -5px; font-size: 26px; fill: hsl(265, 89%, 78%)!important"&gt;___&lt;/text&gt;`;

	bitsos.insertAdjacentHTML("afterend", str3);

	const str4 =  `&lt;text click="23" class="h4" id="total-${i}" x="${66 + [8, 24][i] * 58 - 464 - 21}" y="1031" text-anchor="start" style="letter-spacing: -5px; font-size: 26px; opacity: 0; fill: ${["rgb(217.92242417267, 180.94028587497, 225.11508725765)","rgb(179.21986423706, 250.45426473762, 131.46306721922)"][i]}!important"&gt;${["476&lt;tspan id=\"final-plus\" click=\"24\" style=\"fill: hsl(265, 89%, 78%)!important\"&gt; + &lt;/tspan&gt;", "&nbsp;00"][i]}&lt;/text&gt;`;

	bitsos.insertAdjacentHTML("afterend", str4);
	});


	const str5 =  `&lt;text click="23" class="h4" id="line-7" x="460" y="1037" text-anchor="start" style="letter-spacing: -5px; font-size: 26px"&gt;________&lt;/text&gt;`;
	bitsos.insertAdjacentHTML("afterend", str5);


	const str6 =  `&lt;text click="23" class="h4 group-7" id="ans-8" x="519" y="1072" text-anchor="start" style="letter-spacing: -5px; font-size: 26px; fill: rgb(199.61805622436, 217.61976709789, 186.59712573858)"&gt;476&lt;/text&gt;`;
	document.getElementById("clear-me-pls").insertAdjacentHTML("afterend", str6);



	const str7 =  `&lt;text click="27" class="h4" id="big-chicken" x="519" y="1072" text-anchor="start" style="letter-spacing: -5px; font-size: 26px; fill: rgb(199.61805622436, 217.61976709789, 186.59712573858)"&gt;&nbsp&nbsp;&nbsp;&nbsp;&lt;tspan id="big-chicken-plus"&gt;+&lt;/tspan&gt;&lt;tspan id="big-chicken-13"&gt; 13&lt;/tspan&gt;&lt;/text&gt;`;
	document.getElementById("clear-me-pls").insertAdjacentHTML("afterend", str7);



		</script>



		<line class="no-slide-in2 vertbar" click="4-15"
		stroke="rgb(0, 255, 255)" stroke-width="4"
		marker-end="url(#arrowhead)"

		x1="-1800" x2="-1000" y1="0" y2="1818"

		click-4="856, 926, 719, 659"
		click-5="856, 926, 719, 659"
		click-6="745, 815, 719, 659"
		click-8="745, 815, 719, 659"
		click-9="856, 926, 719, 659"
		click-12="856, 926, 719, 659"
		click-13="250, 180, 719, 659"
		click-14="856, 926, 719, 659"
		>


	</line>

		<g id="zommy">
			<rect class="unzommy" click="25" x="9" width="1912" y="507" height="59" fill="white"></rect>
			<rect class="unzommy" click="25" x="9" width="1912" y="507" height="20" fill="rgb(255, 177, 100)"></rect>
			<rect class="unzommy" click="25" x="9" width="1912" y="546" height="20" fill="rgb(255, 177, 100)"></rect>
			<rect class="unzommy" click="25" x="9" width="20" y="507" height="59" fill="rgb(255, 177, 100)"></rect>
			<rect class="unzommy" click="25" x="1901" width="20" y="507" height="59" fill="rgb(255, 177, 100)"></rect>

			<text click="25" class="h3" id="bits-finally" x="12" y="559" text-anchor="start" style="letter-spacing: 0px;">
				&nbsp;0<tspan class="highlighted">11</tspan>00<tspan class="highlighted">111</tspan>00000<tspan class="highlighted">11</tspan>0<tspan class="highlighted">1</tspan>0<tspan class="highlighted">111</tspan>00<tspan class="highlighted">11</tspan>000000<tspan class="highlighted-blue">1</tspan>000<tspan class="highlighted">1</tspan>000<tspan class="highlighted">1</tspan><tspan style="letter-spacing: -20px">...</tspan>
			</text>
		</g>

		<g id="delete-grp-2">
		<text click="26" class="h3" x="12" y="620" text-anchor="start" style="letter-spacing: 0px;"><tspan class="highlighted">&nbsp;1111111111111111111111111111111</tspan>000000000</text>

		<text click="26" class="h3 and-op" x="-23" y="624" text-anchor="start">&nbsp;<tspan>___________________________________________________________________________</tspan></text>

		<text click="26" class="h3 and-op" x="-16" y="620" text-anchor="start">&nbsp;&</text>

		<text click="25" class="h3" x="12" y="680" id="final-final-result" text-anchor="start" style="letter-spacing: 0px;">&nbsp;0<tspan class="highlighted">11</tspan>00<tspan class="highlighted">111</tspan>00000<tspan class="highlighted">11</tspan>0<tspan class="highlighted">1</tspan>0<tspan class="highlighted">111</tspan>00<tspan class="highlighted">11</tspan>000000.........<tspan style="letter-spacing: -20px">...</tspan>
			</text>
		</g>

		<script>
			const final_result = document.getElementById("final-final-result");

			[1,2,5,6,7,13,14,16,18,19,20,23,24].map((e,i) => {
				const x1 = 120+44*(e-1);
				const str = `&lt;line class="no-slide-in2 deleterious" click="27-30" stroke="rgb(0, 255, 255)" stroke-width="2" marker-end="url(#arrowhead)"
				x1="${x1}" x2="${x1}" y1="680" y2="680"
				click-27="${x1}, ${635+6*i}, 680, 1035"

				damping="0.2" stiffness="0.05"
				&gt;&lt;/line&gt;`;
				// console.log({str})
				final_result.insertAdjacentHTML("afterend", str)
		});
		</script>


		<style>
			html {
				scrollbar-color: white black;
			}

			#zommy {
				transform-origin: 783px 635px;
				display: inline-block;
			}


		</style>

		<script>
		const red = "rgb(255, 121, 198)";
		const green = "rgb(80, 250, 123)";
		const blue = "rgb(139, 233, 253)";
		const yellow = "#F1FA8C";


		Array.prototype.push.apply(global_animations, [
		{
			section: "tree-overlay",
			selector: ".deleterious",
			slide_num: 28,
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				 0:    { opacity: 1 },
				100:   { opacity: 0 },
			}
		},
		{
			section: "tree-overlay",
			selector: "#delete-grp-2, #zommy, #big-chicken, #ans-8",
			slide_num: 29,
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				 0:    { opacity: 1, transform: "translateY(0px)" },
				100:   { opacity: 0, transform: "translateY(0px)" },
			}
		},
		{
			section: "tree-overlay",
			selector: "#big-chicken-13",
			slide_num: 27,
			animation_duration: "2s",
			animation_delay: "3s",
			continuous: true,
			keyframes: {
				 0:    { opacity: 0 },
				100:   { opacity: 1 },
			}
		},
		{
			section: "tree-overlay",
			selector: "#big-chicken-plus",
			slide_num: 28,
			animation_duration: "0.5s",
			continuous: true,
			keyframes: {
				 0:    { opacity: 0 },
				100:   { opacity: 1 },
			}
		},

		{
			section: "tree-overlay",
			selector: "#big-chicken",
			slide_num: 27,
			animation_duration: "2s",
			animation_delay: "3s",
			continuous: true,
			keyframes: {
				 0:    { transform: "translateY(-60px)" },
				100:   { transform: "translateY(0px)" },
			}
		},
		{
			section: "tree-overlay",
			selector: "#final-final-result",
			slide_num: 26,
			animation_duration: "4s",
			animation_delay: "2s",
			continuous: true,
			keyframes: {
				 0:    { opacity: 0, transform: "translateY(-121px)" },
				 20:   { opacity: 1 },
				100:   { opacity: 1, transform: "translateY(0px)" },
			}
		},
		{
			section: "tree-overlay",
			selector: ".and-op",
			slide_num: 26,
			animation_duration: "2s",
			continuous: true,
			keyframes: {
				 0:    { opacity: 1, transform: "translateX(-40px)", "letter-spacing": "-144px" },
				100:   { opacity: 1, transform: "translateX(0px)", "letter-spacing": "-20px" },
			}
		},

		{
			section: "tree-overlay",
			selector: ".unzommy",
			slide_num: 25,
			animation_duration: "5s",
			continuous: true,
			ease: "cubic-bezier(1,-0.01,.96,.81)",
			keyframes: {
				 0:    { opacity: 1 },
				100:   { opacity: 0 },
			}
		},
		{
			section: "tree-overlay",
			selector: "#zommy",
			slide_num: 25,
			animation_duration: "5s",
			continuous: true,
			ease: "cubic-bezier(0.755, 0.05, 0.855, 0.06)",
			keyframes: {
				 0:    { transform: "scale(0.019, 0.1) translate(0px, 0px)" },
				100:   { transform: "scale(1) translate(0px, 0px)" },
			}
		},


		{
			section: "tree-overlay",
			selector: "#bits-finally .highlighted-blue",
			slide_num: 25,
			animation_duration: "5s",
			continuous: true,
			ease: "cubic-bezier(1,-0.01,.96,.81)",
			keyframes: {
				0:   { stroke: "rgb(255, 177, 100)", "stroke-width": "5px" },
				100: { stroke: "rgb(255, 177, 100)", "stroke-width": "2px" },
			}
		},


		{
			section: "tree-overlay",
			selector: "#bits-finally .highlighted",
			slide_num: 25,
			animation_duration: "5s",
			continuous: true,
			ease: "cubic-bezier(1,-0.01,.96,.81)",
			keyframes: {
				0:   { stroke: "rgb(255, 177, 100)", "stroke-width": "5px" },
				80:   { stroke: "rgb(255, 177, 100)", "stroke-width": "5px" },
				100: { stroke: "rgb(0, 255, 255)", "stroke-width": "2px" },
			}
		},

		{
			section: "tree-overlay",
			selector: "#bits-finally",
			slide_num: 25,
			animation_duration: "5s",
			continuous: true,
			ease: "cubic-bezier(1,-0.01,.96,.81)",
			keyframes: {
				0:   { fill: "rgb(255, 177, 100)" },
				100: { fill: "hsl(265, 89%, 78%)" },
			}
		},

		{
			section: "tree-overlay",
			selector: "#clear-me-pls",
			slide_num: 25,
			animation_duration: "3s",
			continuous: true,
			keyframes: {
				0:   { opacity: 1 },
				10:   { opacity: 0.4 },
				100: { opacity: 0 },
			}
		},

		{
			section: "tree-overlay",
			selector: "#ans-8",
			slide_num: 24,
			animation_delay: "2s",
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, transform: "translateY(-33px)" },
				100: { opacity: 1, transform: "translateY(0px)" },
			}
		},

		{
			section: "tree-overlay",
			selector: "#line-7",
			slide_num: 24,
			animation_delay: "1s",
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, transform: "translateX(-40px)" },
				100: { opacity: 1, transform: "translateX(0px)" },
			}
		},

		{
			section: "tree-overlay",
			selector: "#final-plus",
			slide_num: 24,
			animation_delay: "0.8s",
			animation_duration: "0.5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0 },
				100: { opacity: 1 },
			}
		},
		{
			section: "tree-overlay",
			selector: "#total-1",
			slide_num: 24,
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 1, transform: "translate(0px, 0px)" },
				100: { opacity: 1, transform: `translate(-${412}px, 0px)` },
			}
		},

		{
			section: "tree-overlay",
			selector: "#total-0",
			slide_num: 24,
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 1, transform: "translate(0px, 0px)" },
				100: { opacity: 1, transform: "translate(412px, 0px)" },
			}
		},

		{
			section: "tree-overlay",
			selector: "#total-0, #total-1",
			slide_num: 23,
			animation_delay: "2s",
			animation_duration: "1s",
			continuous: false,
			keyframes: {
				0:   { opacity: 0, transform: "translate(0px, -40px)" },
				100: { opacity: 1, transform: "translate(0px, 0px)" },
			}
		},

		{
			section: "tree-overlay",
			selector: ".group-6",
			slide_num: 23,
			animation_delay: "1.45s",
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, transform: "translate(-40px, 0px)" },
				100: { opacity: 1, transform: "translate(0px, 0px)" },
			}
		},

		...new Array(7).fill().map((_, i) => ({
			section: "tree-overlay",
			selector: `.plus-${i}`,
			slide_num: 23,
			animation_delay: `${(i + 1) * 0.15 + 0.25}s`,
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, transform: "translateX(-40px)" },
				100: { opacity: 1, transform: `translateX(0px)` },
			}
		})),

		...new Array(8).fill().map((_, i) => ({
			section: "tree-overlay",
			selector: `.hadd-${i}`,
			slide_num: 23,
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 1, transform: "translate(0px, 0px)" },
				100: { opacity: 1, transform: `translate(${-58*i}px, ${33*i}px)` },
			}
		})), {
			section: "tree-overlay",
			selector: ".hadd-0, .hadd-1, .hadd-2, .hadd-3, .hadd-4, .hadd-5, .hadd-6, .hadd-7",
			slide_num: 22,
			animation_delay: "1s",
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, transform: "translate(0px, -33px)" },
				100: { opacity: 1, transform: "translate(0px, 0px)" },
			}
		}, {
			section: "tree-overlay",
			selector: ".group-5",
			slide_num: 22,
			animation_delay: "0.5s",
			animation_duration: "1s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, transform: "translate(-33px, 0px)" },
				100: { opacity: 1, transform: "translate(0px, 0px)" },
			}
		}, {
			section: "tree-overlay",
			selector: ".group-3",
			slide_num: 22,
			animation_duration: ".5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 1, fill: yellow, transform: "translate(0px, 0px)" },
				100: { opacity: 1, fill: yellow, transform: "translate(-464px, 33px)" },
			}
		}, {
			section: "tree-overlay",
			selector: ".group-1",
			slide_num: 22,
			animation_duration: ".5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 1, fill: red, transform: "translate(0px, 0px)" },
				100: { opacity: 1, fill: red, transform: "translate(-464px, 33px)" },
			}
		}, {
			section: "tree-overlay",
			selector: ".group-3",
			slide_num: 21,
			animation_duration: ".5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0 },
				100: { opacity: 1, fill: yellow },
			}
		}, {
			section: "tree-overlay",
			selector: ".group-2",
			slide_num: 20,
			animation_duration: ".5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0 },
				100: { opacity: 1, fill: green },
			}
		}, {
			section: "tree-overlay",
			selector: ".group-1",
			slide_num: 19,
			animation_duration: ".5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0 },
				100: { opacity: 1, fill: red },
			}
		}, {
			section: "tree-overlay",
			selector: ".group-0",
			slide_num: 18,
			animation_duration: ".5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, fill: blue, },
				100: { opacity: 1, fill: blue, },
			}
		}, {
			section: "tree-overlay",
			selector: ".appeary-g",
			slide_num: 12,
			animation_duration: "5s",
			continuous: true,
			keyframes: {
				0:   { "letter-spacing": "0px", fill: "white", stroke: "rgb(255, 177, 100)", "stroke-width": "3px" },
				100: { "letter-spacing": "14px",fill: "white",  stroke: "rgb(255, 177, 100)", "stroke-width": "3px" },
			}
		}, {
			section: "tree-overlay",
			selector: ".vertbar",
			slide_num: 12,
			animation_duration: "5s",
			continuous: true,
			keyframes: {
				0:   { transform: "translateX(0px)", opacity: 1 },
				20:  {opacity: 0.3 },
				80:  {opacity: 0.3, transform: "translateX(-140px)" },
				100: { opacity: 1, transform: "translateX(-140px)" },
			}
		}, {
			section: "tree-overlay",
			selector: ".appeary",
			slide_num: 12,
			animation_duration: "5s",
			continuous: true,
			keyframes: {
				0:   { opacity: 0, "letter-spacing": "-44px", fill: "white", stroke: "rgb(255, 177, 100)", "stroke-width": "3px" },
				100: { opacity: 1, "letter-spacing": "14px", fill: "white", stroke: "rgb(255, 177, 100)", "stroke-width": "3px" },
			}
		}, {
			section: "tree-overlay",
			selector: ".shrink",
			slide_num: 12,
			animation_duration: "5s",
			continuous: true,
			keyframes: {
				0:   { "letter-spacing": "0px" },
				100: { "letter-spacing": "-44px", opacity: 0 },
			}
		}, {
			section: "tree-overlay",
			selector: ".appeary-g",
			slide_num: 8,
			animation_duration: "0.5s",
			continuous: true,
			keyframes: {
				0:   { fill: "hsl(265, 89%, 78%)", "letter-spacing": "0px", opacity: 1, transform: "translateX(0px)" },
				100: { fill: "white", stroke: "rgb(255, 177, 100)", "stroke-width": "3px", "letter-spacing": "0px", opacity: 1, transform: "translateX(0px)"},
			}
		}, {
			section: "tree-overlay",
			selector: ".magnify",
			slide_num: 1,
			animation_delay: "3s",
			animation_duration: "3s",
			continuous: true,
			keyframes: {
					0:   { "letter-spacing": "-44px", opacity: 0, transform: "translateX(800px)" },
					40:  { opacity: 1 },
				100: { "letter-spacing": "0px", opacity: 1, transform: "translateX(0px)" },
			}
		}, {
			section: "tree-overlay",
			selector: ".shrink, .appeary-g",
			slide_num: 1,
			animation_delay: "3s",
			animation_duration: "3s",
			continuous: true,
			skip_auto_prev_state: true,
			keyframes: {
					0:   { "letter-spacing": "-44px", opacity: 0, transform: "translateX(800px)", fill: "hsl(265, 89%, 78%)", stroke: "rgba(0, 0, 0, 0)" },
					40:  { opacity: 1 },
				100: { "letter-spacing": "0px", opacity: 1, transform: "translateX(0px)", fill: "hsl(265, 89%, 78%)", stroke: "rgba(0, 0, 0, 0)" },
			}
		}, {
			section: "tree-overlay",
			selector: "#backdrop",
			slide_num: 1,
			animation_duration: "1s",
			animation_delay: "3s",
			continuous: true,
			keyframes: {
			0:    { opacity: 0 },
			100:  { opacity: 1 },
			}
		}].reverse());
	</script>

		<!-- <text id="" click="10" class="bits bits-match-color" align="backslash-demo" line="3" small-label="potential_escape">11..111....111....1111...1111..111.1111.11111.1111.1111111.11.11</text> -->
	</g>
</svg>

<style>
	#button-left, #button-right {
		position: fixed;
		font-size: 2rem;
		font-family: 'Press Start 2P';
		bottom: 1rem;
		color: white;
		text-align: center;
		align-content: center;
		height: 1.5rem;
		width: 4rem;
		padding: 0.5rem 0.85rem;
		background: none;
		border: none;
	}

	#button-left {
		left: 0rem;
	}

	#button-right {
		right: 0rem;
	}

	.code-star {
		alignment-baseline: middle;
	}

	.code-color-white { fill: #fff; }
	.code-color-0 { fill: rgb(80, 250, 123); }
	.code-color-1 { fill: #60f4d4; }
	.code-color-2 { fill: rgb(189, 147, 249); }
	.code-color-3 { fill: rgb(255, 121, 198); }
	.code-color-4 { fill: rgb(255, 184, 104); }
	.code-color-5 { fill: #F1FA8C; }
	.code-color-6 { fill: #7960f4; }
	.code-color-7 { fill: #f46060; }
	/* .code-color-8 { fill: #60f4d4; } */

	.code-block-label {
		text-decoration: underline;
		fill: rgb(80, 250, 123);
	}

	.code-builtin {
		fill: rgb(139, 233, 253);
	}

	.code-num {
		fill: rgb(189, 147, 249);
	}

	.code-type, .code-keyword, .code-symbol-1, .code-symbol-2  {
		fill: rgb(255, 121, 198);
	}

	.code-symbol-2 {
		baseline-shift: -14px;
	}

	.code-struct-type {
		fill: rgb(255, 184, 104);
		font-style: italic;
	}

	.code-register {
		fill: #b6c8ff;
	}

	.code-comment {
		font-style: normal;
		fill: #6272a4;
	}

	.code-type {
		font-style: italic;
	}

	.code-string {
		fill: #F1FA8C;
	}

	.code-space {
		fill: rgb(98, 114, 164);
	}

	.bit-1 {
		fill: #F1FA8C;
	}

	.line-of-code, .line-number, .bits, .label, .small-label, .xsmall-label, .ysmall-label, .big-label {
		font-family: 'Iosevka', 'Press Start 2P', 'Courier New', Courier, monospace;
		font-size: 64px;
		letter-spacing: -6px;
		fill: rgb(248, 248, 242)
	}

	.bits, .bits .code-type {
		font-style: normal;
	}

	.line-number {
		font-size: 45px;
	}

	.label {
		font-size: 40px;
		baseline-shift: 10px;
		letter-spacing: -4px;
	}

	.small-label {
		font-size: 28px;
		baseline-shift: 10px;
		letter-spacing: -1px;
	}

	.xsmall-label {
		font-size: 20px;
		baseline-shift: 10px;
		letter-spacing: -1px;
	}

	.ysmall-label {
		font-size: 25px;
		baseline-shift: 10px;
		letter-spacing: -1px;
	}

	.big-label {
		font-size: 70px;
	}

	.code-func-name {
		fill: rgb(80, 250, 123);
	}

	.code-instruction {
		fill: rgb(255, 121, 198);
	}

	.code-keyword-asm {
		fill: rgb(255, 184, 104);
	}

	.code-curly-0 { fill: rgb(248, 248, 242); }
	.code-curly-1 { fill: rgb(255, 121, 198); }
	.code-curly-2 { fill: rgb(139, 233, 253); }
	.code-curly-3 { fill: rgb(80, 250, 123); }
	.code-curly-4 { fill: rgb(189, 147, 249); }
	.code-curly-5 { fill: rgb(255, 184, 104); }
	.code-paren-0 { fill: rgb(248, 248, 242); }
	.code-paren-1 { fill: #F1FA8C; }
	.code-paren-2 { fill: rgb(255, 184, 104); }
	.code-paren-3 { fill: rgb(255, 121, 198); }
 	.code-paren-4 { fill: rgb(189, 147, 249); }
 	.code-paren-5 { fill: rgb(139, 233, 253); }

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Bold-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Bold-Italic.woff') format('woff');
		font-weight: 700;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Bold.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Bold.woff') format('woff');
		font-weight: 700;
		font-style: normal;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold-Italic.woff') format('woff');
		font-weight: 800;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-ExtraBold.woff') format('woff');
		font-weight: 800;
		font-style: normal;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Italic.woff') format('woff');
		font-weight: 400;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Medium-Italic.woff') format('woff');
		font-weight: 500;
		font-style: italic;
		font-display: swap;
	}

	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Medium.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Medium.woff') format('woff');
		font-weight: 500;
		font-style: normal;
		font-display: swap;
	}
	@font-face {
		font-family: 'JetBrains Mono';
		src: url('./fonts/JetBrainsMono/JetBrainsMono-Regular.woff2') format('woff2'),
			url('./fonts/JetBrainsMono/JetBrainsMono-Regular.woff') format('woff');
		font-weight: 400;
		font-style: normal;
		font-display: swap;
	}
</style>

<button id="button-left" onclick="goBackward()">&lt;</button>
<button id="button-right" onclick="goForward()">&gt;</button>

<script>
	const code_snippets = new Map();
	code_snippets.set("title", "HHID Cache in Zig\nby Niles Salter (validark.dev)");

	function processRanges(ranges, joined_lines) {
		return ranges
			.reduce((a, [n, start, end]) =>
				`${a.slice(0, start)}<tspan class="code-${n}">${a.slice(start, end).replaceAll(/ +/g, e => "&nbsp;".repeat(e.length))}</tspan>${a.slice(end)}`,
				joined_lines.replaceAll("&gt;", ">").replaceAll("&lt;", "<")
			)
			.split('\n');
	}

	function preprocess(slide_id, text, lang) {
		let start_pos = text.indexOf("\n");
		let end_pos = text.lastIndexOf("\n");

		if (text.slice(0, start_pos + 1).trim() !== "")
			start_pos = -1;

		if (text.slice(end_pos, -1).trim() !== "")
			end_pos = -1

		let lines = text
			.slice(start_pos + 1, end_pos)
			.split('\n')
			.map(e => e.trimRight().replaceAll('\t', '    '));

		const unnecessary_whitespace = lines
			.filter(e => e)
			.reduce((a, c) => Math.min(a, c.length - c.trimLeft().length), Number.POSITIVE_INFINITY);

		lines = lines.map(e => e.slice(unnecessary_whitespace));
		code_snippets.set(slide_id, (code_snippets.get(slide_id) || "") +
			lines
				.join("\n")
				.replaceAll("&gt;", ">")
				.replaceAll("&lt;", "<")
				.replaceAll("&amp;", "&")
		);
		let curly_depth = 0;
		let paren_depth = 0;

		const joined_lines = lines.join('\n')
			.replaceAll("&gt;&gt;", "&raquo;")
			.replaceAll("<<", "&laquo;")
			.replaceAll("-&gt;", "&RightArrow;")
			.replaceAll("&gt;", ">")
			.replaceAll("&lt;", "<")
			.replaceAll(" => ", " &rArr; ")
			.replaceAll(" != ", " &ne; ")
			.replaceAll(" == ", " &Equal; ");

		const ranges = new Array();

		// for (; )
		// for (let regex = /".+?"/g, cur = regex.exec(joined_lines); cur; cur = regex.exec(joined_lines));

		// const meme = RegExp.prototype.exec.bind(/".+?"/g, joined_lines);
		// joined_lines;

		const in_match = new Array(joined_lines.length).fill(false);

		if (lang === 'zig' || lang === 'ziggy') {
			// console.log(joined_lines);

			// let pos = 0;
			for (const match of joined_lines.matchAll(lang === "ziggy" ? /\/\/([^_]*|$)|"[^_]*?(?<!\\)"|'[^_]*?'|\\\\([^_]*|$)/g : /\/\/([^\n]*|$)|"[^\n]*?(?<!\\)"|'[^\n]*?'|\\\\([^\n]*|$)/g)) {
				const { index, 0: { length } } = match;
				for (let q = 0; q < length; q++) in_match[index + q] = true;
				ranges.push([match[0][0] === '/' ? "comment" : "string", index, index + length]);
			}



			// for (const [regex, name] of [
			// 	[/\/\/([^\n]*|$)/g, "comment"],
			// 	[/"[^\n]*?"|'[^\n]*?'/g, "string"],
			// ]) {
			// 	outer: for (const { index, 0: s } of joined_lines.matchAll(regex)) {
			// 		const { length } = s;
			// 		// console.log({index, length, s})
			// 		for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
			// 		for (let q = 0; q < length; q++) in_match[index + q] = true;
			// 		ranges.push([name, index, index + length]);
			// 	}
			// }

			for (const [regex, name] of [
				[/(?<!\w)(usingnamespace|linksection|threadlocal|unreachable|addrspace|allowzero|nosuspend|anyframe|callconv|comptime|continue|errdefer|noinline|volatile|anytype|noalias|suspend|export|undefined|extern|inline|opaque|orelse|packed|false|true|null|resume|return|struct|switch|align|async|await|break|catch|const|defer|error|union|while|else|enum|test|and|asm|for|pub|try|var|fn|if|or)(?!\w)/g, "keyword"],
				[/(?<!\w)(Carry|HHID|caches)(?!\w+)/g, "struct-type"],
				[/@\w+/g, "builtin"],
				[/ +/g, "space"],
				[/(?:&rArr;)|(?:&amp;)|(?:&ne;)|(?:&Equal;)|(?:&raquo;)|(?:&laquo;)|(?:&RightArrow;)|[:=><!+~?|^/-]|\.(?=\*)|(?<!\.)\*/ug, "symbol-1"],
				[/(?<=\.)\*/g, "symbol-2"],
				[/\w+(?=\()|(?<=fn )\w+/g, "func-name"],
				[/(?<!\w)(?:[ui]\d+|void|bool|uint)(?!\w)/g, "type"],
				[/(?<!\w)0x[\dA-Fa-f]+/g, "num"],
				[/(?<!\w)(?:0[b])?\d+/g, "num"],
				[/\*/g, "star"],
			]) {
				outer: for (const { index, 0: { length } } of joined_lines.matchAll(regex)) {
					for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
					for (let q = 0; q < length; q++) in_match[index + q] = true;
					ranges.push([name, index, index + length]);
				}
			}
		} else if (lang === "asm") {
			for (const [regex, name] of [
				[/"[^\n]+?"|'[^\n]+?'/g, "string"],
				[/;([^\n]+|$)/g, "comment"],
			]) {
				outer: for (const { index, 0: { length } } of joined_lines.matchAll(regex)) {
					for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
					for (let q = 0; q < length; q++) in_match[index + q] = true;
					ranges.push([name, index, index + length]);
				}
			}

			for (const [regex, name] of [
				[/ +/g, "space"],
				[/\*/g, "star"],
				[/(?<!\w)(?:[re]?[abcd]x|[abcd][hl]|[er]?[sb]p|[er]?[ds]i|r[89]|r1[0-5][bwd]?|[xyz]mm[0-9]|zmm[12][0-9]|[xy]mm1[0-5]|zmm3[01]|rip)(?!\w)/g, "register"],
				// [/[:=]/g, "symbol-1"],
				[/.LBB\d+_\d+/g, "block-label"],
				[/(?<!\w)-?\d+/g, "num"],
				[/(?<=call +)[_.\w]+/g, "func-name"],
				[/(?<=\+ )[_.\w]+/g, "func-name"],
				[/(?<=^|\n)[_.\w]+:/g, "func-name"],
				[/(?<!\w)(qword|ptr|dword|byte|word|xmmword|ymmword|zmmword)(?!\w)/g, "keyword-asm"],
				[/(?<=^[ \t]*|\n[ \t]*)\.?\w+/g, "instruction"],
				]) {
					if (name === "instruction") {
						for (const x of joined_lines.matchAll(regex)) {
							const { index, 0: { length } } = x;
							// console.log(index, length, x);
						}
					}

				outer: for (const { index, 0: { length } } of joined_lines.matchAll(regex)) {
					if (length === 0) throw new Error("bad news");
					for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
					for (let q = 0; q < length; q++) in_match[index + q] = true;
					ranges.push([name, index, index + length]);
				}
			}
		} if (lang === "rainbow") {
			let cur_color = 0;
			for (let i = 0; i < joined_lines.length; ) {
				for (; i < joined_lines.length && joined_lines[i] !== '1'; i++) {
					ranges.push([`color-white`, i, i + 1]);
				}
				for (; i < joined_lines.length && joined_lines[i] === '1'; i++) {
					ranges.push([`color-${5}`, i, i + 1]);
				}
				cur_color += 1;
			}
		}


		// .replaceAll(//g, (_, pre, e) => `${pre}<tspan class="code-func-name">${e}</tspan>`)

		for (const [regex, name, [opener, closer]] of [
			[/[{}]/g, "curly", "{}"],
			[/[()]/g, "paren", "()"],
		]) {
			outer: for (const { index, 0: { 0: e, length } } of joined_lines.matchAll(regex)) {
				for (let q = 0; q < length; q++) if (in_match[index + q]) continue outer;
				for (let q = 0; q < length; q++) in_match[index + q] = true;
				if (e === closer) {
					curly_depth--;
				}

				ranges.push([`${name}-${curly_depth % 6}`, index, index + length]);

				if (e === opener) {
					curly_depth++;
				}
			}
		}

		return [
			processRanges(ranges.sort(([, a], [, b]) => b - a), joined_lines),
			ranges
		];
	}

	const container = document.getElementById("container");
	const overlay = document.getElementById("overlay");
	const slide_elements = [...container.children];
	const overlay_elements = slide_elements.map(e => document.getElementById(e.id + "-overlay") || (() => {
		// console.log(e);
		overlay.insertAdjacentHTML("beforeend", `<g class="slide" id="${e.id}-overlay"></g>`)
		return document.getElementById(`${e.id}-overlay`);
	})());

	const EmptyFunction = () => {};

	const clicks = new Map();
	const slidesById = new Map();
	const pane_heights = new Map();



function applyState(line, s) {
  line.setAttribute("x1", s.x1);
  line.setAttribute("y1", s.y1);
  line.setAttribute("x2", s.x2);
  line.setAttribute("y2", s.y2);
}

let my_thread = { id: 0 };

function springTween(line, from, to, opts = {}) {
  let state = { ...from };
  let velocity = { x1:0, y1:0, x2:0, y2:0 };

  const stiffness = opts.stiffness ?? 0.1;  // spring strength
  const damping   = opts.damping   ?? 0.8;  // friction
  const my_thread_id = my_thread.id;

  function animate() {
	let done = true;
	if (my_thread_id === my_thread.id) {
		for (let key in state) {
			const dist = to[key] - state[key];
			velocity[key] += dist * stiffness;
			velocity[key] *= damping;
			state[key] += velocity[key];

			if (Math.abs(dist) > 0.1 || Math.abs(velocity[key]) > 0.1) {
				done = false; // still moving
			}
		}
	}

    if (done) {
		applyState(line, to);
	} else {
		applyState(line, state);
		requestAnimationFrame(animate);
	}
  }

  requestAnimationFrame(animate);
}



// <!-- [553, 631], [820, 787], [957, 958], [1157.25, 1129], [1224, 1278] -->
const startState = { x1: 553, y1: 250, x2: 631, y2: 429 };
const endState   = { x1: 820, y1: 250, x2: 787, y2: 429 };

	function recursivelyHandleChildren(child_state_transitions, child, current_click_num) {
		for (const grandchild of child.children) {
			let click_attr = grandchild.getAttribute("click")
			if (click_attr !== null) {
				grandchild.setAttribute("hidden", "");
				const [click, click2] = click_attr.split('-');
				const clicky = (click === "") ? ++current_click_num : parseInt(click) || 1;

				// if (grandchild.id === "change-highlighted-color") {
				// 	console.log({grandchild})
				// }

				if (grandchild.tagName === "line" && clicky && click && click2) {
					//console.log({clicky, click, click2})
					const data1 = [+grandchild.getAttribute("x1"),
										+grandchild.getAttribute("x2"),
										+grandchild.getAttribute("y1"),
										+grandchild.getAttribute("y2"),];

					data1.stiffness = 0.01;
					data1.damping = 0.8;

					const map = new Map([
						[click - 1, data1]
					]);

					for (let i = +click; i <= +click2; i++) {
						const data = grandchild.getAttribute(`click-${i}`)?.split(', ');
						map.set(i, data);
					}

					//console.log({map});
					const thread_incrementers = new Set();

					for (const [i, data] of map.entries()) {
						if (data) {
							const damping = data.damping ?? grandchild.getAttribute("damping") ?? 0.6;
							const stiffness = data.stiffness ?? grandchild.getAttribute("stiffness") ?? 0.1;
							const [x1, x2, y1=250, y2=429-50] = data;
							// console.log({x1, x2,y1,y2});
							thread_incrementers.add(i);

							child_state_transitions[i].push(() => {
								springTween(grandchild,
									{
										x1: +grandchild.getAttribute("x1"),
										y1: +grandchild.getAttribute("y1"),
										x2: +grandchild.getAttribute("x2"),
										y2: +grandchild.getAttribute("y2"),
									},
									{
										x1: +x1,
										y1: +y1,
										x2: +x2,
										y2: +y2,
									},
									{ stiffness, damping });
							});
						}
					}

					for (const i of thread_incrementers)
						child_state_transitions[i].unshift(() => my_thread.id++)
				}

				const unhide_slide = () => {
					// setTimeout(() => grandchild.removeAttribute("hidden"), 1000);
					grandchild.classList.remove("hide-slide");
					grandchild.classList.add("unhide-slide");
					grandchild.removeAttribute("hidden");
				};


				const hide_slide = () => {
					// console.log("hiding", grandchild);
					grandchild.classList.remove("unhide-slide");
					grandchild.classList.add("hide-slide");
					grandchild.setAttribute("hidden", "");


					// setTimeout(() => {
					// 	console.log({a:+click < +cur_click, b: +cur_click > (+click2 || -Infinity)})
					// 	if (!(+cur_click > (+click2 || -Infinity) || +click < +cur_click))
					// 		grandchild.setAttribute("hidden", "");
					// }, 1000);
				};

				child_state_transitions[clicky].push(unhide_slide);
				child_state_transitions[clicky - 1].push(hide_slide);

				if (click2) {
					child_state_transitions[click2]?.push(hide_slide);
					child_state_transitions[click2 - 1].push(unhide_slide);
				}
			}
			current_click_num = recursivelyHandleChildren(child_state_transitions, grandchild, current_click_num);
		}

		return current_click_num;
	}

	function countClicks(child, state) {
		for (const grandchild of child.children) {
			let click = grandchild.getAttribute("click")
			if (click !== null) {
				grandchild.setAttribute("hidden", "");
				const clicky = (click === "") ? ++state.current_click_num : parseInt(click) || 1;
				if (clicky > state.max_click_num) state.max_click_num = clicky;
			}
			countClicks(grandchild, state);
		}
		return state;
	}

	let IS_MOBILE_FULL_SCREEN = false;

	post_processes.push(() => {
		for (const [is_overlay, elements] of  [[false, slide_elements], [true, overlay_elements]]) {
			for (const [i, child] of elements.entries()) {
				child.setAttribute("hidden", "");
				const id = child.getAttribute("id");
				if (id === null) throw new Error("Please add an ID to slide " + i + ` (after the slide with an id of "${elements[i - 1].id}")`);
				const id_without_overlay = id.replace("-overlay", "");
				const click_attr = child.getAttribute("clicks");
				const num_clicks = is_overlay ? clicks.get(id_without_overlay) : parseInt(click_attr?.split(",").length > 1 ? click_attr.split(",").length + 1 : click_attr) ||
					(1 + countClicks(child, { current_click_num: 0, max_click_num: 0 }).max_click_num);

				clicks.set(id_without_overlay, num_clicks);
				const arr = slidesById.get(id_without_overlay) || [];
				arr.push(child);
				slidesById.set(id_without_overlay, arr);

				const child_state_transitions = is_overlay ? state_transitions.get(id_without_overlay) : new Array(num_clicks).fill(0).map(() => []);
				if (!is_overlay) state_transitions.set(id, child_state_transitions);

				child_state_transitions[0].push(() => {
					child.removeAttribute("hidden")
					if (i > 0) elements[i - 1].setAttribute("hidden", "")
					if (i < elements.length - 1) elements[i + 1].setAttribute("hidden", "")
					if (!is_overlay)
						container.setAttribute("viewBox", `0 0 1920 ${pane_heights.get(id) || 1080}`);
				});

				child_state_transitions[num_clicks - 1].push(() => {
					child.removeAttribute("hidden")
					if (i > 0) elements[i - 1].setAttribute("hidden", "")
					if (i < elements.length - 1) elements[i + 1].setAttribute("hidden", "")
				});

				// if (is_overlay)
				// 	state_transitions.get(id_without_overlay).forEach((a, i) => {
				// 		child_state_transitions.forEach((b, j) => {
				// 			console.log(a);
				// 			a.push(b);
				// 		});
				// 	});

				recursivelyHandleChildren(child_state_transitions, child, 0)
			}
		}
	});

				// 	global_scrolls.push({
				// 	section: slide_id,
				// 	slide_num: i + 1,
				// 	animation_duration,
				// 	pos: next,
				// });

	post_processes.push(() => {
		/**
		 * Create a cubic-bezier easing function.
		 * @param {number} p0x
		 * @param {number} p0y
		 * @param {number} p1x
		 * @param {number} p1y
		 */
		function cubicBezier(p0x, p0y, p1x, p1y) {
		// Helper functions for bezier math
		function cubic(a, b, m) { return ((1 - 3*b + 3*a) * m ** 3) + ((3*b - 6*a) * m ** 2) + (3*a * m); }
		function cubicDerivative(a, b, m) { return (3*(1 - 3*b + 3*a) * m ** 2) + (2*(3*b - 6*a) * m) + (3*a); }

		return function(t) {
			// Newton-Raphson iteration to find the parametric value for time t
			let x = t, i = 0;
			for (; i < 5; i++) {
			const xEstimate = cubic(p0x, p1x, x) - t;
			const dx = cubicDerivative(p0x, p1x, x);
			if (Math.abs(xEstimate) < 1e-6) break;
			x -= xEstimate / dx;
			}
			return cubic(p0y, p1y, x);
		};
		}

		// Your easing curve: cubic-bezier(0.69, 0.02, 0.53, 1)
		const easeCustom = cubicBezier(0.69, 0.02, 0.53, 1);

		/**
		 * Smooth scroll to target using cubic-bezier easing.
		 */
		let active_scroll_id = 0;
		function scrollToPosition(targetY, duration = 500) {
			const startY = window.scrollY;
			const distance = targetY - startY;
			let startTime = null;
			const my_scroll_id = ++active_scroll_id;

			function step(timestamp) {
				if (active_scroll_id !== my_scroll_id) return;
				if (!startTime) startTime = timestamp;
				const elapsed = timestamp - startTime;
				const progress = Math.min(elapsed / duration, 1);

				const easedProgress = easeCustom(progress);

				if (elapsed < duration) {
					window.scrollTo(0, startY + distance * easedProgress);
					requestAnimationFrame(step);
				} else {
					window.scrollTo(0, targetY);
				}
			}

			requestAnimationFrame(step);
		}

		let scroll_id = 0;

		function scrollElementOffsetAnimated(elem, offsetPx, duration = 500, section) {
			if (IS_MOBILE_FULL_SCREEN) return;
			let startTime = 0.0;
			const my_scroll_id = ++scroll_id;

			function step(timestamp) {
				if (cur_slide != section) return;
				if (my_scroll_id !== scroll_id) return;
				if (!startTime) startTime = timestamp;
				const elapsed = timestamp - startTime;
				const rect = elem.getBoundingClientRect();
				window.scrollTo(0, window.scrollY + rect.top - offsetPx);
				if (elapsed < duration) requestAnimationFrame(step);
			}

			requestAnimationFrame(step);
		}


		{
			let i = 0;
			const selectors = new Set();
			const sections = new Set();

			const positions = global_scrolls.map(({ pos }) => 120 - pos * 80);


			for (const [i, { section, slide_num, animation_duration, selector, pos }] of global_scrolls.entries()) {
				sections.add(section);
				selectors.add(selector);

				// console.log({selector:selector.slice(0, -("-rect".length))});

				global_animations.push({
					section,
					selector: selector.slice(0, -("-rect".length)),
					slide_num,
					animation_duration,
					forward_only: true,
					keyframes: {
						0:    {  transform: `translateY(${positions[i - 1] || 0}px)` },
						100:   { transform: `translateY(${positions[i]}px)` },
					},
					mobile_full_screen_only: true,
				});

				global_animations.push({
					section,
					selector: selector.slice(0, -("-rect".length)),
					slide_num,
					animation_duration: global_scrolls[i+1]?.animation_duration,
					backward_only: true,
					keyframes: {
						0:    {  transform: `translateY(${positions[i + 1] || 0}px)` },
						100:   { transform: `translateY(${positions[i]}px)` },
					},
					mobile_full_screen_only: true,
				});

				state_transitions.get(section)[slide_num].push(() => {
					const elem = document.querySelector(selector);
					const styles = getComputedStyle(elem);

					// console.log({elem, animation_duration: styles.animationDuration})

					// console.log(styles.animationName);       // e.g., "fadeIn"
					// console.log();   // e.g., "2s"
					// console.log(styles.animationDelay);      // e.g., "0.5s"
					// console.log(styles.animationIterationCount); // e.g., "infinite"
					// console.log('');
					scrollElementOffsetAnimated(document.querySelector(selector),
						// offset from top
						50,
						1000 * styles.animationDuration.slice(0, -1), section);
				});
			}
			const selectors_arr = [...selectors];
			const sections_arr = [...sections];

			for (let i = 0; i < selectors_arr.length; i++)
				state_transitions.get(sections_arr[i])[0].push(() => {
					scrollElementOffsetAnimated(document.querySelector(selectors_arr[i]),
								// offset from top
								50,
								5000, sections_arr[i]);
				});
		}

		// console.log(global_scrolls);
	})

	const code_info = new Map();

	let code_block_i = 0;

	for (const codeblock of document.getElementsByClassName("code")) {
		let codeblock_id = codeblock.getAttribute("id");
		const x = +codeblock.getAttribute("x");
		const y = +codeblock.getAttribute("y");
		const steps = codeblock.getAttribute("steps");
		const lang = codeblock.getAttribute("lang");
		const width = +codeblock.getAttribute("width");
		if (codeblock.getAttribute("height")) {
			throw new Error("Height is not allowed on code block")
		}
		const line_height = +codeblock.getAttribute("line-height");
		const font_size = codeblock.getAttribute("font-size");
		const line_num_indent = +codeblock.getAttribute("line-num-indent");
		const hide_line_numbers = codeblock.hasAttribute("hide-line-numbers");

		const line_indent = +codeblock.getAttribute("line-indent");
		let slide = codeblock;
		do slide = slide.parentNode; while (!slide.classList.contains("slide"));
		const slide_id = slide.getAttribute("id");


		const [lines, ranges] = preprocess(slide_id, codeblock.innerHTML, lang);

		if (codeblock_id) {
			code_info.set(codeblock_id, { x, y, width, line_height, line_num_indent, hide_line_numbers, line_indent, slide, ranges });
		} else {
			codeblock_id = `codeblock-${code_block_i++}`;
			codeblock.setAttribute("id", codeblock_id);
		}

		if (lines.length > 0) {
			let innerHTML = codeblock.hasAttribute("hide-background") ? '' : `<rect x="${x || 0}" y="${y || 0}" height="${y + (line_height*(codeblock.getAttribute("lines") || lines.length)) + 20}" width="${width}" fill="black"></rect>`;
			innerHTML += lines.map((e, i) => `<text class="line-of-code" x="${x + line_indent}" y="${y + (line_height*(i+1))}">${e}</text>`).join('\n');

			if (!hide_line_numbers)
				innerHTML += lines.map((_, i) => `<text class="line-number" x="${x + line_num_indent}" y="${y + (line_height*(i+1)) - 1}" text-anchor="end">${i + 1}</text>`);

			const extra_height = y + (line_height*(lines.length));

			if (extra_height > 1080) {
				pane_heights.set(slide_id, extra_height);

				for (const body of document.getElementsByTagName("body")) {
					body.insertAdjacentHTML("beforeend",
`
<style>
#container[slide="${slide_id}"] {
	height: ${extra_height / 10.80}%
}
</style>
`);
				}
		}

			codeblock.innerHTML = innerHTML;
		}

		if (steps) {
			codeblock.insertAdjacentHTML("afterbegin", `<rect id="${codeblock_id}-rect" width="1950" fill="purple" style="opacity: 0.6"></rect>`)
			let last = 0;
			let last_height = "0px";
			let last_y = "0px";
			var colors = ["rgb(99, 81, 1)", "purple", "rgb(99, 0, 0)", "rgb(88, 0, 128)", "rgb(0, 0, 128)"];
			Array.prototype.push.apply(global_animations, steps.split(",").map((av, i, k) => {
				const isLast = k.length === i + 1;
				let [v, num_lines] = av.split(":");
				num_lines ||= '1';
				const prev = last;

				// (8 - num_lines)
				// 2076

				const next = last = Math.min(0, (-v + Math.max(2, 3 - num_lines)) * line_height) - 9;
				const anim_duration = Math.max(0.2, Math.abs(next - prev) / (3000));
				const animation_duration = `${(i === 0 ? 1/0.9 : 1) * anim_duration}s`;
				// console.log({ prev, next, animation_duration });
				// console.log([v, y + (line_height*(v - 1)) + 10]);

				const prev_height = last_height;
				const next_height = last_height = `${line_height*(num_lines || 1) + line_height / 7}px`;

				const prev_y = last_y;
				const next_y_num = y + (line_height*(v - 1)) + line_height / 7;
				const next_y = last_y = `${next_y_num}px`;


				global_scrolls.push({
					section: slide_id,
					slide_num: i + 1,
					animation_duration,
					linear: true,
					pos: +v,
					selector: `#${codeblock_id}-rect`,
				});

				return [

				// {
				// 	section: slide_id,
				// 	selector: "#" + codeblock_id,
				// 	slide_num: i + 1,
				// 	forward_only: true,
				// 	skip_auto_prev_state: true,
				// 	animation_duration,
				// 	keyframes: {
				// 		0:   { transform: `translateY(${prev}px)` },
				// 		100: { transform: `translateY(${next}px)` },
				// 	}
				// }, {
				// 	section: slide_id,
				// 	selector: "#" + codeblock_id,
				// 	slide_num: i,
				// 	backward_only: true,
				// 	skip_auto_prev_state: true,
				// 	animation_duration,
				// 	keyframes: {
				// 		0:   { transform: `translateY(${next}px)` },
				// 		100: { transform: `translateY(${prev}px)` },
				// 	}
				// },
				{
					section: slide_id,
					selector: `#${codeblock_id}-rect`,
					slide_num: i + 1,
					forward_only: true,
					skip_auto_prev_state: true,
					animation_duration,
					keyframes: {
						0:   { height: prev_height, y: prev_y, fill: colors[(i + 0) % colors.length] },
						90: i === 0 ? { y: next_y, height: 0 } : undefined,
						100: { height: next_height, y: next_y, fill: colors[(i + 1) % colors.length] },
					}
				}, {
					section: slide_id,
					selector: `#${codeblock_id}-rect`,
					slide_num: i,
					backward_only: true,
					skip_auto_prev_state: true,
					animation_duration,
					keyframes: {
						0:   { height: next_height, y: next_y, fill: colors[(i + 1) % colors.length] },
						10: i === 0 ? { height: 0 } : undefined,
						100: { height: prev_height, y: prev_y, fill: colors[(i + 0) % colors.length] },
					}
				}, isLast && {
					section: slide_id,
					selector: `#${codeblock_id}-rect`,
					slide_num: i + 1,
					backward_only: true,
					skip_auto_prev_state: true,
					animation_duration,
					keyframes: {
						0:   { height: next_height, y: next_y },
						90: i === 0 ? { y: next_y, height: 0 } : undefined,
						100: { height: next_height, y: next_y },
					}
				},
				// isLast && {
				// 	section: slide_id,
				// 	selector: "#" + codeblock_id,
				// 	slide_num: i + 1,
				// 	backward_only: true,
				// 	skip_auto_prev_state: true,
				// 	animation_duration,
				// 	keyframes: {
				// 		0:   { transform: `translateY(${next}px)` },
				// 		100: { transform: `translateY(${next}px)` },
				// 	}
				// }
			];
			}).flat())
		}
	}

	for (const text of [...document.getElementsByTagName("text")]) {
		const align = text.getAttribute("align");
		if (align) {
			const line = +text.getAttribute("line");
			const info = code_info.get(align);

			text.setAttribute("x", info.x + info.line_indent);
			text.setAttribute("y", info.y + (info.line_height*(line+1)));

			for (const cl of ["label", "small-label", "xsmall-label", "ysmall-label", "big-label"]) {
				const label = text.getAttribute(cl);

				if (label) {
					const click = text.getAttribute("click");
					text.insertAdjacentHTML("beforebegin", `<text id="${text.getAttribute("id")}-label" class="${cl}" ${click ? `click=${click}` : ""} text-anchor="end" x="${info.x + info.line_indent}" y="${info.y + (info.line_height*(line+1))}">${label.replaceAll(">>", "»").replaceAll("<<", "«")}${label.length === 1 ? '' : `:`}&nbsp;</text>`)
				}
			}
		}
	}

	for (const bits of document.getElementsByClassName("bits-auto-color")) {
		bits.innerHTML = bits.innerHTML.replaceAll(/1+/g, e => `<tspan class="bit-1">${e}</tspan>`);
	}

	// const indexToChar = new Array(64).fill('').map((_, i) => i < 62 ? i < 36 ? i.toString(36) : (i - 26).toString(36).toUpperCase() : '&$'[i - 62]);


	for (const bits of document.getElementsByClassName("bits-match-color")) {
		const align = bits.getAttribute("align");
		if (!align) throw new Error("bits-match-color must use the 'align' property to be paired up with something!")
		const info = code_info.get(align);
		// console.log(bits.innerHTML);
		bits.innerHTML = processRanges(info.ranges, bits.innerHTML).join('\n');
	}

	{
		let i = 0;
		for (const bits of document.getElementsByClassName("bits-match-color2")) {
			const align = bits.getAttribute("align");
			if (!align) throw new Error("bits-match-color2 must use the 'align' property to be paired up with something!")
			const info = code_info.get(align);

			const [smally] = bits.getElementsByClassName("bits-small")

			for (const [kind, bottom, top] of info.ranges) {
				if (bottom <= i && i < top) {
					smally.classList.add("code-" + kind);
					break;
				}
			}
			// bits.innerHTML = processRanges(info.ranges, bits.innerHTML).join('\n');
			i++;
		}
	}

	for (const post_process of post_processes) post_process();

	const all_styles = new Map();

{
	let i = 0;
	let styles = new Array();
	let prev_selector;
	let prev_slide_num;
	let prev_section;
	const animations = new Array();

	function getSelectorForInternal(ge, num_clicks) {
		if (ge === num_clicks) throw new Error("num_clicks must be higher than the target click (clicks start at 0)")
		let arr = [];
		let y = ge;
		for (; y % 10; y++) {
			if (y >= num_clicks) return arr;
			arr.push(`[click="${y}"]`);
		}

		let z = y;
		let i = -1;
		for (; z % 100; z += 10) {
			if (z >= num_clicks) return arr;
			if (z / 10 === ge) {
				for (; z % 100; z += 10) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 10}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			arr.push(`[click^="${z / 10}"]:not([click="${z / 10}"])`);
		}

		let q = z;
		i = -1;
		for (; z % 1000; z += 100) {
			if (z >= num_clicks) return arr;
			// console.log(z, ge)
			if (z / 100 === ge) {
				for (; z % 1000; z += 100) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 100}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			for (let j = 0; j < 10; j++) {
				const k = z / 10 + j;

				arr.push(`[click^="${k}"]${ge <= k && k < num_clicks ? '' : `:not([click="${k}"])`}`);
			}
		}

		return arr;
	}

	function getSelectorFor(ge, num_clicks) {
		return `:is(${getSelectorForInternal(+ge, +num_clicks).join(", ")})`;
	}

	function getSelectorForRangeInternal(num_clicks, ge, lt) {
		if (ge === num_clicks) throw new Error("num_clicks must be higher than the target click (clicks start at 0)")
		let arr = [];
		let y = ge;
		for (; y % 10; y++) {
			if (y >= num_clicks) return arr;
			arr.push(`[click="${y}"]`);
		}

		let z = y;
		let i = -1;
		for (; z % 100; z += 10) {
			if (z >= num_clicks) return arr;
			if (z / 10 === ge) {
				for (; z % 100; z += 10) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 10}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			arr.push(`[click^="${z / 10}"]:not([click="${z / 10}"])`);
		}

		let q = z;
		i = -1;
		for (; z % 1000; z += 100) {
			if (z >= num_clicks) return arr;
			// console.log(z, ge)
			if (z / 100 === ge) {
				for (; z % 1000; z += 100) {
					if (z >= num_clicks) return arr;
					arr[++i] = `[click^="${z / 100}"]`
				}
				break;
			}
			// console.log(arr.findIndex(v => v === `[click="${z / 10}"]`), `[click="${z / 10}"]`);
			for (let j = 0; j < 10; j++) {
				const k = z / 10 + j;

				arr.push(`[click^="${k}"]${ge <= k && k < num_clicks ? '' : `:not([click="${k}"])`}`);
			}
		}

		return arr;
	}

	function getSelectorForRange(num_clicks, ge, lt) {
		return `:is(${getSelectorForRangeInternal(+num_clicks, +ge, +lt).join(", ")})`;
	}

	// console.log(getSelectorFor('5', '23'));
	// console.log(getSelectorFor('23', '33'));
	// console.log(getSelectorFor('20', '30'));

	const elements_to_selectors = new Map();
	const selectors_to_keyframes = new Map();

	for (const { section = (() => { throw "Invalid section" })(), selector, slide_num, keyframes } of global_animations.filter(e => e)) {
		const start_keyframe = keyframes[0];
		const end_keyframe = keyframes[100];

		for (const [, individual_selector] of selector.matchAll(/([^,]+?)(?:, ?|$)/g)) {
			for (const element of document.querySelectorAll(individual_selector)) {
				const old = elements_to_selectors.get(element);
				if (old && old !== individual_selector) {
					throw new Error("Cannot make an object peacefully coexist in two different classes/ids. Please use id's instead. Conflict between `" + individual_selector + "` and `" + old + "`");
				} else {
					elements_to_selectors.set(element, individual_selector);
				}
			}

			let arr = selectors_to_keyframes.get(individual_selector);
			if (arr === undefined) {
				arr = new Array();
				selectors_to_keyframes.set(individual_selector, arr);
			}
			arr.push({ slide_num, start_keyframe, end_keyframe });
		}
	}

	for (const [i, v] of selectors_to_keyframes.entries()) {
		let prev_slide_num = 0;

		for (const { slide_num, start_keyframe, end_keyframe } of v.sort((a, b) => a.slide_num - b.slide_num)) {
			// prev_slide_num, slide_num, new Array(slide_num - prev_slide_num).fill().map((_, i) => i + prev_slide_num);
			// console.log(slide_num, prev_slide_num);
			prev_slide_num = slide_num;
		}
	}

	//
	for (const { section, selector, slide_num, keyframes, animation_delay = '0s', animation_duration = '0s', skip_auto_prev_state = section === prev_section && selector === prev_selector, forward_only = false, backward_only = false, ease = false, linear = false, continuous = false, mobile_full_screen_only = false } of global_animations.filter(e => e)) {
		if (section !== (prev_section ?? section)) {
			all_styles.set(prev_section, styles.join("\n"));
			styles = new Array();
		}
		i += 1;
		const keyframe_entries = Object.entries(keyframes).filter(e => e[1] !== undefined).map(([a, b]) => [+a, b]).sort((a, b) => a[0] - b[0]);
		if (keyframe_entries[0]?.[0] !== 0) throw "Missing keyframe 0";
		if (keyframe_entries[keyframe_entries.length - 1]?.[0] !== 100) throw "Missing keyframe 100";

		if (selector !== prev_selector || slide_num !== prev_slide_num) {
			animations.length = 0;
		}

		const animation = `animation${i} ${animation_duration} ${linear ? "linear" : ease === true ? "ease" : ease || "cubic-bezier(0.69, 0.02, 0.53, 1)"} ${animation_delay} 1 forwards normal`;
		animations.push(animation)

		const mobile_only = mobile_full_screen_only ? "#container[mobile-translate] " : ""
		let selectors = selector.split(',');

		if (!skip_auto_prev_state) {
			styles.push(`${mobile_only}.slide#${section} ${selector} {
		${Object.entries(keyframe_entries[0][1]).map(([a, b]) => `${a}: ${b};`).join("\n\t")}
	}`);
		}

		// if (selector.startsWith('.')) {
		// 	Array.prototype.push.apply(selectors, [...document.querySelectorAll(selector)].filter(x => x.id).map(x => `${selector}#${x.id}`));
		// }

		styles.push(`${selectors.map(selector => `${mobile_only}.slide#${section}[${continuous ? 'fragment-' : 'click="'}${slide_num}${continuous ? '' : '"'}]${forward_only ? "[present-went-forward]" : backward_only ? "[present-went-backward]" : ""} ${selector}`).join(',\n')} {
		animation: ${animations.join(",\n\t")};
	}`);

		if (!continuous) styles.push(`${selectors.map(selector => `${mobile_only}.slide#${section}[fragment-${slide_num + 1}] ${selector}`).join(',\n')} {
		${Object.entries(keyframe_entries[keyframe_entries.length - 1][1]).map(([a, b]) => `${a}: ${b};`).join("\n\t")}
	}`);

	// 	if (forward_only) styles.push(`${`${selectors.map(selector => `.slide#${section}[click="${slide_num}"][present-went-backward] ${selector}`).join(',\n')} {
	// 	${Object.entries(keyframe_entries[keyframe_entries.length - 1][1]).map(([a, b]) => `${a}: ${b};`).join("\n\t")}
	// }`}`);

		styles.push(`@keyframes animation${i} {
		${keyframe_entries.map(([a, b]) => `${a}% { ${Object.entries(b).map(([a, b]) => `${a}: ${b};`).join(" ")} }`).join("\n\t")}
	}`);

		if (forward_only) {
			// console.log(styles[styles.length - 1]);
		}

		prev_selector = selector;
		prev_slide_num = slide_num;
		prev_section = section;
	}

	all_styles.set(prev_section, styles.join("\n"));

	var styleSheet = document.createElement("style");
	styleSheet.id = "slide-animations";
	styleSheet.innerHTML = [...all_styles.values()].join('\n');
	document.head.appendChild(styleSheet);
}

	const getStateFromURL = () => {
		const slide_arg = window.location.href.split("#").pop();
		const [slide_title, clicks_amt] = slide_arg.split("?");
		let cur_slide = slide_title || slide_elements[0].id;
		if (!clicks.has(cur_slide)) [[cur_slide]] = clicks;

		return [
			cur_slide,
			(clicks_amt || "").startsWith("click=")
			? Math.min(clicks.get(cur_slide) - 1, parseInt(clicks_amt.slice("click=".length)) || 0)
			: 0
		];
	}

	let [cur_slide, cur_click] = getStateFromURL();

	const updateURL = () => window.location.href = "#" + cur_slide + (cur_click === 0 ? '' : `?click=${cur_click}`);

	const updateContainerSlideAttribute = () => {
		container.setAttribute("slide", cur_slide);
		overlay.setAttribute("slide", cur_slide + "-overlay");
	}


	// window.onhashchange = function() {
	// 	const targetState = getSlideFromURL();
	// 	setState(targetState)
	// };

	function applyTransitions() {
		for (const cur_slide_element of slidesById.get(cur_slide)) {
			cur_slide_element.setAttribute("click", "" + cur_click);
			for (let i = 0; i <= cur_click; i++) cur_slide_element.setAttribute(`fragment-${i}`, "");
			const max_clicks = clicks.get(cur_slide);
			for (let i = cur_click; ++i < max_clicks; ) cur_slide_element.removeAttribute(`fragment-${i}`);
		}

		for (const state_transition of state_transitions.get(cur_slide)[cur_click]) {
			state_transition();
		}
	}

	function applyStateTransitionsUpToCurrentClickInSlide() {
		for (let i = 0; i <= cur_click; i++) {
			for (const state_transition of state_transitions.get(cur_slide)[i]) {
				state_transition();
			}
		}
	}

	function nextSlide() {
		let next_slide;
		let wasPreviousCurrentSlide = false;
		for (const [slide] of clicks) {
			if (wasPreviousCurrentSlide) {
				next_slide = slide;
				break;
			}
			wasPreviousCurrentSlide = cur_slide === slide;
		}
		if (!next_slide) return false;
		for (const cur_slide_element of slidesById.get(cur_slide)) {
			for (let i = 0; i < cur_click; i++) {
				cur_slide_element.removeAttribute(`fragment-${i}`);
			}
			cur_slide_element.removeAttribute("click");
			cur_click = 0;
		}

		cur_slide = next_slide;
		updateContainerSlideAttribute();
		return true;
	}

	function goForward() {
		const old_slide = cur_slide;
		const max_click = clicks.get(cur_slide) - 1;
		cur_click++;
		let is_new_slide = true;
		if (cur_click > max_click) {
			is_new_slide = nextSlide();
			if (!is_new_slide)
				cur_click--;
		}
		for (const old_slide_element of slidesById.get(old_slide)) {
			old_slide_element.removeAttribute("present-went-backward");
			if (old_slide !== cur_slide) old_slide_element.removeAttribute("present-went-forward");
		}
		for (const cur_slide_element of slidesById.get(cur_slide)) cur_slide_element.setAttribute("present-went-forward", "");
		if (is_new_slide) {
			applyTransitions();
			updateURL();
		}
	}

	function prevSlide() {
		for (const slide of slidesById.get(cur_slide)) {
			slide.removeAttribute("click");
			slide.removeAttribute("fragment-0");
		}
		let [[previous_slide]] = clicks
		for (const [slide] of clicks) {
			if (cur_slide === slide) break;
			previous_slide = slide;
		}
		cur_slide = previous_slide;
		cur_click = clicks.get(cur_slide) - 1;
		applyStateTransitionsUpToCurrentClickInSlide();
		updateContainerSlideAttribute();
	}

	function goBackward() {
		const old_slide = cur_slide;

		if (cur_click === 0) {
			prevSlide();
		} else {
			cur_click--;
		}

		for (const old_slide_element of slidesById.get(old_slide)) {
			old_slide_element.removeAttribute("present-went-forward");
			if (old_slide !== cur_slide) old_slide_element.removeAttribute("present-went-backward");
		}
		for (const slide of slidesById.get(cur_slide)) slide.setAttribute("present-went-backward", "");

		applyTransitions();
		updateURL();
	}

	let is_control_depressed = false;

	window.addEventListener("touchend", () => {
		document.body.requestFullscreen({ navigationUI: "hide" })
		.then(() => {
			IS_MOBILE_FULL_SCREEN = true;
			container.setAttribute("mobile-translate", "");
		})
		.catch(err => {
			console.error("Fullscreen request failed:", err);
		});
	});
	// window.addEventListener("touchstart", () => void (document.querySelector("body").requestFullscreen({ navigationUI: "hide" })));
	window.addEventListener("keyup", function (event) {
		// Do nothing if the event was already processed
		if (event.defaultPrevented) return;
		switch (event.key) {
		case "Control":
			is_control_depressed = false;
			break;
		default:
			return; // Quit when this doesn't handle the key event.
		}
	});

	window.addEventListener("keydown", function (event) {
		// Do nothing if the event was already processed
		if (event.defaultPrevented) return;

		switch (event.key) {
		case "ArrowLeft":
			goBackward();
			break;
		case "ArrowRight":
			goForward();
			break;
		case "Control":
			is_control_depressed = true;
			break;
		case 'c':
			if (is_control_depressed) {
				navigator.clipboard.writeText(code_snippets.get(cur_slide));
			}
		default:
			return; // Quit when this doesn't handle the key event.
		}

		// Cancel the default action to avoid it being handled twice
		event.preventDefault();
	}, true);

	applyTransitions();
	updateURL();
	applyStateTransitionsUpToCurrentClickInSlide();
	updateContainerSlideAttribute();
	for (const slide of slidesById.get(cur_slide)) slide.setAttribute("present-went-forward", "");
</script>


<script>
function subtractBinary(a, b) {
    // Convert binary strings to integers
    const intA = BigInt(`0b${[...a.replaceAll('.', '0')].reverse().join('')}`);
    const intB = BigInt(`0b${[...b.replaceAll('.', '0')].reverse().join('')}`);

    // Subtract
    let result = intA - intB;
	const flip_around = result < 0n;

    // If negative, handle appropriately
    if (flip_around) {
        result = ~result;
    }

	let str = result.toString(2).padStart(64, '0');

	if (flip_around) {
        str = str.replaceAll(/[01]/g, e => ['1', '0'][+e]);
    }

    // Convert back to binary string
    return [...str.replaceAll('0', '.')].reverse().join('');
}

function opBinary(a, b, op) {
    // Convert binary strings to integers
    const intA = BigInt(`0b${[...a.replaceAll('.', '0')].reverse().join('')}`);
    const intB = BigInt(`0b${[...b.replaceAll('.', '0')].reverse().join('')}`);

    // Subtract

    let result = undefined;

	switch (op) {
		case '-': result = intA - intB; break;
		case '^': result = intA ^ intB; break;
		case '&': result = intA & intB; break;
		case '&~': result = intA & ~intB; break;
		case '|': result = intA | intB; break;
	}

	const flip_around = result < 0n;

    // If negative, handle appropriately
    if (flip_around) {
        result = ~result;
    }

	let str = result.toString(2).padStart(64, '0');

	if (flip_around) {
        str = str.replaceAll(/[01]/g, e => ['1', '0'][+e]);
    }

    // Convert back to binary string
    return [...str.replaceAll('0', '.')].reverse().join('');
}

// Example:
const even_series = opBinary(
	"0111.111.1..1111.1.11111.11111.111111111.11111.1111.1111111111.1",
	"11..111....111....1111...1111..111.1111.11111.1111.1111111.11.11", '-');

const esc_and_term = opBinary(even_series, '.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1', '^');
const escaped = opBinary(esc_and_term, "11..111....111....1111...1111..111.1111.11111.1111.1111111.11.11", "^");
// console.log(even_series);
// console.log(esc_and_term);
// console.log(escaped);

// console.log(opBinary(
// 	"1....1.....1...11...1.1..1.......11............11............1..",
// 	"1...............1.................1..............1..............", "-"));

// const starts_and_quote_bounds = opBinary("...............1.................1..............1...............", opBinary("1..........1....1.....1........................1................", opBinary("...............1.................1..............1...............",
// opBinary("1...............1.................1..........................1.." & "1..........1....1.....1........................1................", "&"), '-'), '&'), '|');

const starts = "1...............1.................1..........................1..";
const quote_bounds_incl_carry = "1..........1....1.....1........................1................";
const starts_and_quote_bounds = opBinary(starts, quote_bounds_incl_carry, '&');
const carriages_or_newlines_or_eof = "...............1.................1..............1...............";
const subbed = opBinary(carriages_or_newlines_or_eof, starts_and_quote_bounds, '-');
const imm = opBinary(quote_bounds_incl_carry, subbed, '&');
let imm2 = opBinary(carriages_or_newlines_or_eof, imm, '|');
imm2 = opBinary(imm2, starts, '&~');

const cur_ends = opBinary(imm2, opBinary(imm2, starts, '-'), '&~');


// console.log({cur_ends});

</script>

<style>
	.bits-small {
		font-size: 25px;
		letter-spacing: -2px;
		text-align: center;
	}
</style>

</body>
</html>
